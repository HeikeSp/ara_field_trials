---
title: "Modelling of metabolite data Arabidopsis field trials"
author: "Heike Sprenger"
date: "Monday, July 18, 2016"
output:
  html_document:
    highlight: tango
    number_section: yes
    theme: cerulean
    toc: yes
    toc_float: true
    toc_depth: 4
---

# Set working directory  
```{r set working directory}
#getwd()
#setwd("D:/work/repos/ara_field_trials/")
```

# Load workspace, packages and scripts
```{r load workspace, include=TRUE, message=FALSE}
# load packages
library(knitr)
library(pander)
library(ggplot2)
library(DAAG)
library(leaps)
library(faraway)
library(MASS)
library(glmnet)

# set options for knitr
opts_chunk$set(fig.width=6, fig.height=5, tidy=TRUE, tidy.opts=list(width.cutoff=70))
opts_knit$set(root.dir = '../')

# load workspace
#load("metabolite_arafield_model.RData")
```


# Load data
Use changed metabolite data, from ``metabolite_arafield4_overview4.Rmd``
```{r load data}
field2 <- read.table("output/metabolite_arafield2_modified.txt", header = TRUE, sep = "\t")
field3 <- read.table("output/metabolite_arafield3_modified.txt", header = TRUE, sep = "\t")
field4 <- read.table("output/metabolite_arafield4_modified.txt", header = TRUE, sep = "\t")

# OLD VERSION
# lt50 <- read.table("data/LT50.txt", header = TRUE, sep = "\t")
# dim(lt50) 
# 58 accessions (= 52 accessions for training + 6 for testing)

# NEW VERSION with 64 accessions
lt50 <- read.table("data/lt50_64acc.txt", header = TRUE, sep = "\t")
dim(lt50)
# 64 accessions (= 52 accessions for training + 12 for testing)
table(lt50$Model)

# capacity
yCapacity4full <- field4$LT50ACC - field4$LT50NAC 
yCapacity <- lt50$LT50ACC - lt50$LT50NAC

setdiff(lt50$Accession, field4$accession) # Ws missing in Field 4
setdiff(lt50$Accession, field3$accession)
setdiff(lt50$Accession, field2$accession)
setdiff(field4$accession, lt50$Accession)
setdiff(field3$accession, lt50$Accession)
setdiff(field2$accession, lt50$Accession)

length(unique(field2$accession))
length(unique(field3$accession))
length(unique(field4$accession))

setdiff(field3$accession, field4$accession)

# Number accessions with known LT50
length(intersect(field2$accession, lt50$Accession))
length(intersect(field3$accession, lt50$Accession))
length(intersect(field4$accession, lt50$Accession))
```

## set factor levels correctly
```{r set factor levels correctly}
# antho score (en)
field2$antho_value_en <- factor(field2$antho_value_en, 
                                              levels = c("very low", "low", "intermediate", "high", "very high"))
field3$antho_value_en <- factor(field3$antho_value_en, 
                                              levels = c("low", "intermediate", "high", "very high")) # "very low" is not present
field4$antho_value_en <- factor(field4$antho_value_en, 
                                              levels = c("very low", "low", "intermediate", "high", "very high"))

# bbch categories
field2$bbch_categories <- factor(field2$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))
field3$bbch_categories <- factor(field3$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))
field4$bbch_categories <- factor(field4$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))

# flowering state
field2$flowering_state <- factor(field2$flowering_state, levels = c("non-flowering", "flowering"))
field3$flowering_state <- factor(field3$flowering_state, levels = c("non-flowering", "flowering"))
field4$flowering_state <- factor(field4$flowering_state, levels = c("non-flowering", "flowering"))

# vegetative state
field2$vegetative_state <- factor(field2$vegetative_state, levels = c("vegetative", "non-vegetative"))
field3$vegetative_state <- factor(field3$vegetative_state, levels = c("vegetative", "non-vegetative"))
field4$vegetative_state <- factor(field4$vegetative_state, levels = c("vegetative", "non-vegetative"))
```


# Define data for modeling
## Define training and test accessions
```{r define training and test accessions}
accessions_training <- as.character(lt50$Accession[which(lt50$Model == "train")])
accessions_testing <- as.character(lt50$Accession[which(lt50$Model == "test")])
accessions_known <- as.character(lt50$Accession)

# indices for accessions for training/testing
idx_train2 <- which(field2$accession %in% accessions_training)
idx_train3 <- which(field3$accession %in% accessions_training)
idx_train4 <- which(field4$accession %in% accessions_training)
idx_test2 <- which(field2$accession %in% accessions_testing)
idx_test3 <- which(field3$accession %in% accessions_testing)
idx_test4 <- which(field4$accession %in% accessions_testing)
```

## Define colnames
```{r define colnames}
model_colnames <- c("accession", "plant_name", "LT50ACC", "LT50NAC", "capacity",
                    "glucose_positive", "fructose_positive", "sucrose_positive",
                    "raffinose_positive", "amino_acids_positive", "malate_positive", 
                    "fumarate_positive", "proline_positive", "bbch_id", "anthoscore")

# with NORMALIZED BBCH
model_colnames_norm <- c("accession", "plant_name", "LT50ACC", "LT50NAC", "capacity",
                    "glucose_positive", "fructose_positive", "sucrose_positive",
                    "raffinose_positive", "amino_acids_positive", "malate_positive", 
                    "fumarate_positive", "proline_positive", "norm_bbch_id", "anthoscore")

model_colnames_short <- c("accession", "plant_name", "LT50ACC", "LT50NAC", "cap",
                          "glc","frc","suc","raf","aa","mal","fum","pro","bbch","anthoscore")
```


```{r}
# subset for model training/testing
field2_train <- field2[idx_train2, model_colnames]
field3_train <- field3[idx_train3, model_colnames]
field4_train <- field4[idx_train4, model_colnames]
field2_train_norm <- field2[idx_train2, model_colnames_norm]
field3_train_norm <- field3[idx_train3, model_colnames_norm]
field4_train_norm <- field4[idx_train4, model_colnames_norm]
field2_test <- field2[idx_test2, model_colnames]
field3_test <- field3[idx_test3, model_colnames]
field4_test <- field4[idx_test4, model_colnames]
field2_test_norm <- field2[idx_test2, model_colnames_norm]
field3_test_norm <- field3[idx_test3, model_colnames_norm]
field4_test_norm <- field4[idx_test4, model_colnames_norm]

# remove NA samples
field2_train <- field2_train[which(!is.na(field2_train$sucrose_positive) ), ]
field3_train <- field3_train[which(!is.na(field3_train$fumarate_positive) ), ]
# field3_test <- field3_test[which(!is.na(field3_test$fumarate_positive) ), ]

# Field4-Tsu, SampleID: 837060, Plant: [At.Tsu-0.n].2.2-4 --> missing values for BBCH and antho-Score! --> remove?
field4_train <- field4_train[which(!is.na(field4_train$anthoscore) ), ]

length(unique(field2_train$accession)) # 42 
length(unique(field3_train$accession)) # 48 (because of removed NAs!)
length(unique(field4_train$accession)) # 51

length(unique(field3_test$accession)) # 48 (because of removed NAs!)
# 12
```


## Define freezing tolerance per trial
```{r define freezing tolerance per trial}
# field2_train_LT50ACC <- field2_train$LT50ACC
# field3_train_LT50ACC <- field3_train$LT50ACC
# field4_train_LT50ACC <- field4_train$LT50ACC
# 
# yLT50NAC2 <- field2_train$LT50NAC
# yLT50NAC3 <- field3_train$LT50NAC
# yLT50NAC4 <- field4_train$LT50NAC
# 
# yCapacity2 <- field2_train$capacity
# yCapacity3 <- field3_train$capacity
# yCapacity4 <- field4_train$capacity
```


## Change colnames and export data
- using ORIGINAL/NORMALIZED BBCH!
```{r change colnames and export data}
# training data
colnames(field2_train) <- colnames(field3_train) <- colnames(field4_train) <- model_colnames_short
# using NORMALIZED BBCH
colnames(field2_train_norm) <- colnames(field3_train_norm) <- colnames(field4_train_norm) <- model_colnames_short

# test data
colnames(field2_test) <- colnames(field3_test) <- colnames(field4_test) <- model_colnames_short
# using NORMALIZED BBCH
colnames(field2_test_norm) <- colnames(field3_test_norm) <- colnames(field4_test_norm) <- model_colnames_short

# training data
write.table(field2_train, "output/metabolite_arafield2_train.txt", sep="\t")
write.table(field3_train, "output/metabolite_arafield3_train.txt", sep="\t")
write.table(field4_train, "output/metabolite_arafield4_train.txt", sep="\t")
write.table(field2_train_norm, "output/metabolite_arafield2_train_norm.txt", sep="\t")
write.table(field3_train_norm, "output/metabolite_arafield3_train_norm.txt", sep="\t")
write.table(field4_train_norm, "output/metabolite_arafield4_train_norm.txt", sep="\t")
# test data
write.table(field2_test, "output/metabolite_arafield2_test.txt", sep="\t")
write.table(field3_test, "output/metabolite_arafield3_test.txt", sep="\t")
write.table(field4_test, "output/metabolite_arafield4_test.txt", sep="\t")
write.table(field2_test_norm, "output/metabolite_arafield2_test_norm.txt", sep="\t")
write.table(field3_test_norm, "output/metabolite_arafield3_test_norm.txt", sep="\t")
write.table(field4_test_norm, "output/metabolite_arafield4_test_norm.txt", sep="\t")
```


# Linear Regression of LT50ACC
## Use Normalized BBCH
* Unterschied zwischen anova- und summary-Signifikanzen: erstere geben an, ob ein Effekt signifikant zur Erklaerung der Gesamtvarianz beitraegt.
* zweitere ist "nur" ein Test, ob die Steigung signifikant unterschiedlich von null ist
```{r regACC norm BBCH}
field4_regressionACC_norm <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                bbch + anthoscore, data = field4_train_norm)
summary(field4_regressionACC_norm)$r.squared
# Multiple R-squared: 0.363   

# use FACTOR for antho_score and norm_bbch
field4_regressionACC_norm_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                       factor(bbch) + factor(anthoscore), data = field4_train_norm)
summary(field4_regressionACC_norm_factor)$r.squared
# Multiple R-squared: 0.428 
```


## Use original BBCH - without factor
```{r regACC original BBCH - without factor}
field2_regressionACC <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                               bbch + anthoscore, data = field2_train)
field3_regressionACC <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                bbch + anthoscore, data = field3_train)
field4_regressionACC <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                bbch + anthoscore, data = field4_train)

summary(field2_regressionACC)$r.squared # 0.331
summary(field3_regressionACC)$r.squared # 0.23
summary(field4_regressionACC)$r.squared # 0.406 
```


## Use original BBCH - factor
```{r regACC original BBCH - factor}
field2_regressionACC_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    factor(bbch) + factor(anthoscore), data = field2_train)
field3_regressionACC_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    factor(bbch) + factor(anthoscore), data = field3_train)
field4_regressionACC_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    factor(bbch) + factor(anthoscore), data = field4_train)

summary(field2_regressionACC_factor)$r.squared # 0.44
summary(field3_regressionACC_factor)$r.squared # 0.353
summary(field4_regressionACC_factor)$r.squared # 0.428 
summary(field4_regressionACC_factor)$adj.r.squared # Adjusted R-squared: 0.298
```


## cross-validation
```{r cross-validation}
field2_DAAGdata <- field2_train[,c(3:15)]
field3_DAAGdata <- field3_train[,c(3:15)]
field4_DAAGdata <- field4_train[,c(3:15)]

# 5-fold cross-validation
CVlm(data = field2_DAAGdata, form.lm = field2_regressionACC, m = 5) # overall ms: 3.71
CVlm(data = field3_DAAGdata, form.lm = field3_regressionACC, m = 5) # overall ms: 2.77
CVlm(data = field4_DAAGdata, form.lm = field4_regressionACC, m = 5) # Overall ms: 2.44
```


## Leave-One-Out-cross-validation (LOO-CV)
```{r Leave-One-Out-cross-validation (LOO-CV), warning=FALSE, message=FALSE}
field2_loocv <- CVlm(data = field2_DAAGdata, form.lm = field2_regressionACC, m = 109, printit = F)
attr(field2_loocv, "ms") # Overall ms: 3.37

field3_loocv <- CVlm(data = field3_DAAGdata, form.lm = field3_regressionACC, m = 109, printit = F)
attr(field3_loocv, "ms") # Overall ms: 2.85

field4_loocv <- CVlm(data = field4_DAAGdata, form.lm = field4_regressionACC, m = 109, printit = F)
attr(field4_loocv, "ms") # Overall ms: 2.36
```


## Prediction of LT50ACC with model (for accessions that are included in the model = training data)
```{r prediction of LT50ACC using factor model with ORIGINAL BBCH}
cor.test(field2_regressionACC_factor$fitted.values, field2_train$LT50ACC) # R = 0.663
cor.test(field3_regressionACC_factor$fitted.values, field3_train$LT50ACC) # R = 0.594
cor.test(field4_regressionACC_factor$fitted.values, field4_train$LT50ACC) # R = 0.654 / R2 = 0.428

plot(field2_train$LT50ACC, field2_regressionACC_factor$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), 
     pch = 19)
abline(lm(field2_regressionACC_factor$fitted.values ~ yLT50ACC2))

plot(field3_train$LT50ACC, field3_regressionACC_factor$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), 
     pch = 19)
abline(lm(field3_regressionACC_factor$fitted.values ~ yLT50ACC3))

plot(field4_train$LT50ACC, field4_regressionACC_factor$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(field4_regressionACC_factor$fitted.values ~ field4_train$LT50ACC))
```


## Prediction of LT50ACC with model (for accessions that are included in the model = training data)
```{r prediction of LT50ACC using model with ORIGINAL BBCH}
cor.test(field2_regressionACC$fitted.values, field2_train$LT50ACC) # R = 0.575
cor.test(field3_regressionACC$fitted.values, field3_train$LT50ACC) # R = 0.479
cor.test(field4_regressionACC$fitted.values, field4_train$LT50ACC) # R = 0.637

plot(field2_train$LT50ACC, field2_regressionACC$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), 
     pch = 19)
abline(lm(field2_regressionACC$fitted.values ~ yLT50ACC2))

plot(field3_train$LT50ACC, field3_regressionACC_factor$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), 
     pch = 19)
abline(lm(field3_regressionACC$fitted.values ~ yLT50ACC3))

plot(field4_train$LT50ACC, field4_regressionACC$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(field4_regressionACC$fitted.values ~ field4_train$LT50ACC))
```


## Prediction of LT50ACC test data
```{r prediction of LT50ACC for test data}
head(field4_test_norm)

# Vorhersage der LT50-Werte fuer ausgewaehlte Akzessionen mit Hilfe des berechneten Regressionsmodells
field4_predictionACC_norm <- predict(field4_regressionACC_norm, field4_test_norm[,6:15])
field4_predictionACC_norm_factor <- predict(field4_regressionACC_norm_factor, field4_test_norm[,6:15])
field4_predictionACC <- predict(field4_regressionACC, field4_test[,6:15])

field2_predictionACC_factor <- predict(field2_regressionACC_factor, field2_test[,6:15])
field3_predictionACC_factor <- predict(field3_regressionACC_factor, field3_test[,6:15])
field4_predictionACC_factor <- predict(field4_regressionACC_factor, field4_test[,6:15])

plot(field4_predictionACC, field4_predictionACC_norm)
plot(field4_predictionACC, field4_predictionACC_factor)

# mehr zum Thema Vorhersage und Konfidenz-Intervalle im Kapitel 3 im Buch Regression, Seite 123

# Vorhersage mit 95%-Vorhersageintervall
head(predict(field4_regressionACC, field4_test, interval="prediction"))

# Vorhersage mit 95%-Konfidenzintervall
head(predict(field4_regressionACC, field4_test, interval="confidence"))

field4_predictionACC_table <- data.frame(accession = field4_test$accession,
                                         measured = field4_test$LT50ACC,
                                         predicted = field4_predictionACC)

field2_predictionACC_table_factor <- data.frame(accession = field2_test$accession,
                                                measured = field2_test$LT50ACC,
                                                predicted = field2_predictionACC_factor)

field3_predictionACC_table_factor <- data.frame(accession = field3_test$accession,
                                                measured = field3_test$LT50ACC,
                                                predicted = field3_predictionACC_factor)

field4_predictionACC_table_factor <- data.frame(accession = field4_test$accession,
                                                measured = field4_test$LT50ACC,
                                                predicted = field4_predictionACC_factor)

field4_predictionACC_table_norm <- data.frame(accession = field4_test_norm$accession,
                                              measured = field4_test_norm$LT50ACC,
                                              predicted = field4_predictionACC_norm)

head(field4_predictionACC_table)
head(field4_predictionACC_table_norm)
head(field2_predictionACC_table_factor)
head(field3_predictionACC_table_factor)
head(field4_predictionACC_table_factor)

write.table(field4_predictionACC_table, "output/field4_predictionACC.txt", sep="\t")
write.table(field4_predictionACC_table_factor, "output/field4_predictionACC_factor.txt", sep="\t")
write.table(field4_predictionACC_table_norm, "output/field4_predictionACC_norm.txt", sep="\t")

sum(((field4_predictionACC)-(field4_test$LT50ACC))^2)
# 80
sum(((field4_predictionACC_norm)-(field4_test$LT50ACC))^2)
# 94.5
sum(((field4_predictionACC_factor)-(field4_test$LT50ACC))^2)
# 80.4

sum(((field4_predictionACC)-(field4_test$LT50ACC))^2) / sum((field4_test$LT50ACC)^2)
# 0.0363
sum(((field4_predictionACC_norm)-(field4_test$LT50ACC))^2) / sum((field4_test$LT50ACC)^2)
# 0.0429

cor.test(field4_test$LT50ACC, field4_predictionACC)
cor.test(field4_test$LT50ACC, field4_predictionACC_norm)
cor.test(field4_test$LT50ACC, field4_predictionACC_factor)

plot(field4_test$LT50ACC, field4_predictionACC)
plot(field4_test$LT50ACC, field4_predictionACC_factor)

par(mfrow=c(1,1))
barplot(t(as.matrix(field4_predictionACC_table[,2:3])), 
        beside=T, names.arg = field4_predictionACC_table$accession, las=2)

barplot(t(as.matrix(field4_predictionACC_table_factor[,2:3])), 
        beside=T, names.arg = field4_predictionACC_table_factor$accession, las=2)

# Vorhersage ist ganz okay fuer 5 von 6 Akzessionen, aber die Vorhersage fuer Van-0 ist komplett verschieden


barplot(t(as.matrix(field3_predictionACC_table_factor[,2:3])), 
        beside=T, names.arg = field3_predictionACC_table_factor$accession, las=2)
```


## reduced model
```{r reduced model}
summary(field2_regressionACC_factor)
summary(field3_regressionACC_factor)
summary(field4_regressionACC_factor)

anova(field2_regressionACC_factor)
anova(field3_regressionACC_factor)
anova(field4_regressionACC_factor)
```



## Cp-plot
```{r Cp-plot}
################### Cp-Plot ####################
x <- as.matrix(field4_train[,c(6:15)]) # Create design matrix x
y <- field4_train$LT50ACC # Create response vector y
leapsModels <- leaps(x, y, method="Cp", nbest=3, names=colnames(x))

pdf(file="figures/Metabolite_AraField4_CpPlot.pdf")
Cpplot(leapsModels)
dev.off()

adjr <- leaps(x, y, method="adjr2") # Check which model the adjusted R2 selects
maxadjr(adjr, 8)

# y <- arafield4_regressiondata$yLT50ACC[cooks.distance(arafield4_regressionACC)<0.2]
# x <- cbind(arafield4_regressiondata[,4:14])
# x_part <- x[cooks.distance(arafield4_regressionACC)<0.2,]
# a <- leaps(x_part, y)
# b <- leaps(x, y, method="adjr2")
```


# LASSO model
# LASSO model field 3
```{r LASSO model field 3}
x <- as.matrix(field3_train[,6:15])
y <- field3_train$LT50ACC

test_x <- as.matrix(field3_test[,6:15])
test_y <- field3_test$LT50ACC

set.seed(1)
field3_lasso_ACC <- glmnet(x,y)

# Cross-validation
set.seed(1)
field3_lasso_cv_ACC <- cv.glmnet(x, y)

# use no specific lambda
field3_lasso_ACC_pred_test <- predict(field3_lasso_ACC, new = test_x)

# calculate mean error
field3_lasso_ACC_pred_test_err <- apply( (field3_lasso_ACC_pred_test - test_y)^2, 2, mean )

# use optimal lamba value
field3_lasso_ACC_pred_all_lambda <- predict(field3_lasso_cv_ACC, new = x, s="lambda.min")
field3_lasso_ACC_pred_test_lambda <- predict(field3_lasso_cv_ACC, new = test_x, s="lambda.min")

# number of variables in model (for lambda.min)
which(field3_lasso_cv_ACC$lambda == field3_lasso_cv_ACC$lambda.min)
# 30
field3_lasso_cv_ACC$nzero[23]
# 10

# coefficients
field3_lasso_cv_ACC$glmnet.fit$beta[,"s29"]

cor.test(y, field3_lasso_ACC_pred_all_lambda)
# 0.475

field3_lasso_ACC_pred_test_lambda_table <- data.frame(accession = field3_test$accession,
                                                      measured = field3_test$LT50ACC,
                                                      lasso = field3_lasso_ACC_pred_test_lambda, 
                                                      regression_fac = field3_predictionACC_factor)

sum(((field3_lasso_ACC_pred_test_lambda)-(field3_test$LT50ACC))^2)
# NA

sum(((field3_lasso_ACC_pred_test_lambda)-(field3_test$LT50ACC))^2) / sum((field3_test$LT50ACC)^2)
# NA
```


## LASSO model field 4
```{r LASSO model field 4}
x <- as.matrix(field4_train[,6:15])
y <- field4_train$LT50ACC

test_x <- as.matrix(field4_test[,6:15])
test_y <- field4_test$LT50ACC

set.seed(1)
field4_lasso_ACC <- glmnet(x,y)

# Cross-validation
set.seed(1)
field4_lasso_cv_ACC <- cv.glmnet(x, y)
# plot(field4_lasso_cv_ACC)

# use no specific lambda
field4_lasso_ACC_pred_test <- predict(field4_lasso_ACC, new = test_x)

# calculate mean error
field4_lasso_ACC_pred_test_err <- apply( (field4_lasso_ACC_pred_test - test_y)^2, 2, mean )
# points(log(field4_lasso_ACC$lambda), field4_lasso_ACC_pred_test_err, col="blue", pch="*")

# use optimal lamba value
field4_lasso_ACC_pred_all_lambda <- predict(field4_lasso_cv_ACC, new = x, s="lambda.min")
field4_lasso_ACC_pred_test_lambda <- predict(field4_lasso_cv_ACC, new = test_x, s="lambda.min")

# number of variables in model (for lambda.min)
which(field4_lasso_cv_ACC$lambda == field4_lasso_cv_ACC$lambda.min)
# 23
field4_lasso_cv_ACC$nzero[23]
# 4

# coefficients
field4_lasso_cv_ACC$glmnet.fit$beta[,"s22"]


# plot observed vs. predicted DRYM
# plot(y, lasso_all_pred_all_lambda)
# abline(0,1)
cor.test(y, field4_lasso_ACC_pred_all_lambda)


field4_lasso_ACC_pred_test_lambda_table <- data.frame(accession = field4_test$accession,
                                                      measured = field4_test$LT50ACC,
                                                      lasso = field4_lasso_ACC_pred_test_lambda, 
                                                      regression = field4_predictionACC,
                                                      regression_fac = field4_predictionACC_factor)


# barplot(t(as.matrix(lasso_all_pred_test_lambda_table[,2:3])), 
#         beside=T, names.arg = lasso_all_pred_test_lambda_table$acc, las=2)
# 
# barplot(t(as.matrix(lasso_all_pred_test_lambda_table[,2:4])), 
#         beside=T, names.arg = lasso_all_pred_test_lambda_table$acc, las=2)

sum(((field4_lasso_ACC_pred_test_lambda)-(field4_test$LT50ACC))^2)
# 61.8

sum(((field4_lasso_ACC_pred_test_lambda)-(field4_test$LT50ACC))^2) / sum((field4_test$LT50ACC)^2)
# 0.028
```


## Prediction of LT50ACC with model (for accessions that are included in the model = training data)
```{r prediction of LT50ACC using model with ORIGINAL BBCH and LASSO}
cor.test(field4_regressionACC$fitted.values, field4_train$LT50ACC)
# R = 0.637
cor.test(field4_lasso_ACC_pred_all_lambda, field4_train$LT50ACC)
# R = 0.609

par(mfrow=c(1,2))

plot(field4_train$LT50ACC, field4_regressionACC$fitted.values, main = "regression",
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(field4_regressionACC$fitted.values ~ field4_train$LT50ACC))
#lm(field4_regressionACC$fitted.values ~ field4_train$LT50ACC)

plot(field4_train$LT50ACC, field4_lasso_ACC_pred_all_lambda, main = "lasso",
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(field4_lasso_ACC_pred_all_lambda ~ field4_train$LT50ACC))
#lm(field4_lasso_ACC_pred_all_lambda ~ field4_train$LT50ACC)
```



```{r compare different models}
range(test_y)
lim_values <- c(-11.6, -5.5)

pdf("figures/field4_compare_model_validation.pdf", 8, 8)
par(mfrow=c(2,2))

plot(test_y, field4_lasso_ACC_pred_test_lambda, col = "white",
     main = "lasso model", xlim = lim_values, ylim = lim_values)
text(test_y, field4_lasso_ACC_pred_test_lambda, field4_test$accession)
text(-10,-6, "cor = 0.405", col="red")
abline(0,1, col="red")
cor.test(test_y, field4_lasso_ACC_pred_test_lambda)

plot(test_y, field4_predictionACC, col = "white",
     main = "regression model", xlim = lim_values, ylim = lim_values)
text(test_y, field4_predictionACC, field4_test$accession)
text(-10,-6, "cor = 0.295", col="red")
abline(0,1, col="red")
cor.test(test_y, field4_predictionACC)

plot(test_y, field4_predictionACC_factor, col = "white",
     main = "regression model (factor)", 
     xlim = lim_values, ylim = lim_values)
text(test_y, field4_predictionACC_factor, field4_test$accession)
text(-10,-6, "cor = 0.3", col="red")
abline(0,1, col="red")
cor.test(test_y, field4_predictionACC_factor)

plot(test_y, field4_predictionACC_norm, col = "white",
     main = "regression model (norm BBCH)",
     xlim = lim_values, ylim = lim_values)
text(test_y, field4_predictionACC_norm, field4_test$accession)
text(-10,-6, "cor = 0.18", col="red")
abline(0,1, col="red")
cor.test(test_y, field4_predictionACC_norm)

dev.off()
```








## variable selection

### forward selection
```{r forward selection}
# Create initial NULL model
field2_regressionACC_null <- lm(field2_train$LT50ACC ~ 1, data = field2_train)
field3_regressionACC_null <- lm(field3_train$LT50ACC ~ 1, data = field3_train)
field4_regressionACC_null <- lm(field4_train$LT50ACC ~ 1, data = field4_train)

# Choose a model by AIC in a Stepwise Algorithm
# Forward
field4_regressionACC_fw <- step(field4_regressionACC_null, 
                                scope = formula(field4_regressionACC), 
                                direction = "forward")

# Step:  AIC=92.9
# yLT50ACC ~ norm_bbch + raf + fum + suc
#              Df Sum of Sq RSS  AIC
# <none>                    233 92.9
# + glc         1     2.340 231 93.8
# + pro         1     2.281 231 93.8
# + frc         1     2.266 231 93.8
# + anthoscore  1     1.144 232 94.4
# + antho       1     0.510 233 94.7
# + aa          1     0.101 233 94.9
# + mal         1     0.006 233 94.9

summary(field4_regressionACC_fw)
# R = 0.392

# Vorhersage-Werte fuer Oekotypen, die nicht im Modell sind
predict(field4_regressionACC_fw, field4_test)

# Summe der quadratischen Differenzen zwischen Mess- und Vorhersagewert 
sum(((predict(field4_regressionACC_fw, field4_test)) - (field4_test$LT50ACC))^2)
# 81
sum(((predict(field4_regressionACC_fw, field4_test)) - (field4_test$LT50ACC))^2)/ sum((field4_test$LT50ACC)^2)
# 0.0367
```


### stepAIC
#### default direction (if missing): backward!!!
```{r selection in both directions}
############  SELECTION in BOTH DIRECTIONS ###################
# Without FACTOR!
step(field4_regressionACC_null, 
     scope = formula(field4_regressionACC_factor), 
     direction = "both")
# Step:  AIC=92.9
# yLT50ACC ~ norm_bbch + raf + fum + suc
# Call:
# lm(formula = yLT50ACC ~ norm_bbch + raf + fum + suc, data = arafield4_regressiondata)
# Coefficients:
# (Intercept)    norm_bbch          raf          fum          suc  
#     -7.2765       1.0280      -0.9556      -0.0720       0.0542  

# das selbe Modell wie bei forward selection

# Both directions, starting from Null model (FACTOR!)
field2_regressionACC_factorAIC <- step(field2_regressionACC_null, 
                                       scope = formula(field2_regressionACC_factor), 
                                       direction = "both")
# raf, fum, mal

field3_regressionACC_factorAIC <- step(field3_regressionACC_null, 
                                       scope = formula(field3_regressionACC_factor), 
                                       direction = "both")
# factor(bbch), pro, suc

field4_regressionACC_factorAIC <- step(field4_regressionACC_null, 
                                       scope = formula(field4_regressionACC_factor), 
                                       direction = "both")
summary(field4_regressionACC_factorAIC)
# factor(bbch), raf, suc, fum


# Summe der quadratischen Differenzen zwischen Mess- und Vorhersagewert
sum(((predict(arafield4_regressionACC_factorAIC, arafield4_predictiondata)) - (measuredLT50ACC))^2) / sum((measuredLT50ACC)^2)
# 0.069
sum(((predict(arafield4_regressionACC_factorAIC, arafield4_predictiondata)) - (measuredLT50ACC))^2)
# 74.1

# bind predicted and measured LT50ACC for accessions of test set
head(data.frame(accession = field3_test$accession, 
                measured = field3_test$LT50ACC,
                predicted_reduced = predict(field3_regressionACC_factorAIC, field3_test),
                predicted_full = predict(field3_regressionACC_factor, field3_test)))

head(data.frame(accession = field4_test$accession, 
                measured = field4_test$LT50ACC,
                predicted_reduced = predict(field4_regressionACC_factorAIC, field4_test),
                predicted_full = predict(field4_regressionACC_factor, field4_test)))
```


### stepAIC default
#### default direction (if missing): backward!!!
```{r stepAIC default}
arafield4_stepAIC_ACC <- stepAIC(arafield4_regressionACC)

arafield4_stepAIC_ACC$coefficients
# (Intercept)         frc         raf         fum         pro   norm_bbch 
#     -7.5118      0.0558     -0.8974     -0.0873      2.7659      0.9638 

# predited values for accessions that are included in the null model (training data)
arafield4_stepAIC_ACC$fitted.values

# predited values for accessions that are NOT included in the null model (test data)
arafield4_prediction_stepAIC_ACC <- predict(arafield4_stepAIC_ACC, arafield4_predictiondata)
 
head(data.frame(arafield4_predictiondata, arafield4_prediction_stepAIC_ACC, measuredLT50ACC)[,c(1,14,15)])
#         acc arafield4_prediction_stepAIC_ACC measuredLT50ACC
# 1      Be-0                            -7.32           -5.71
# 2      Be-0                            -7.80           -5.71
# 3    Bsch-2                            -9.96           -9.13
# 4    Bsch-2                           -10.99           -9.13
# 5    Bsch-2                            -9.27           -9.13
# 6    Bsch-2                           -10.14           -9.13

# Summe der quadratischen Differenzen zwischen Mess- und Vorhersagewert
sum(((arafield4_prediction_stepAIC_ACC) - (measuredLT50ACC))^2)
# 88.4
sum(((arafield4_prediction_stepAIC_ACC) - (measuredLT50ACC))^2)/ sum((measuredLT50ACC)^2)
# 0.0823
```


### comparison of two models --> ANOVA
```{r comparison of two models}
# anova(arafield4_regressionACC, arafield4_stepAIC_ACC)
# Analysis of Variance Table
# 
# Model 1: yLT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + antho + 
#     norm_bbch + anthoscore
# Model 2: yLT50ACC ~ frc + raf + fum + pro + norm_bbch
#   Res.Df RSS Df Sum of Sq    F Pr(>F)
# 1     97 223                         
# 2    103 230 -6     -6.28 0.45   0.84

# p-value > 0.05, also Annahme von H0, dass beide Modelle aehnlich
```


### backward selection
```{r backward selection}
step(arafield4_regressionACC, scope=formula(arafield4_regressionACC), direction="backward")
# fuehrt zum gleichen Ergebnis wir stepAIC, da bei step auch der AIC-Wert minimiert wird (backward)

```


### add quadratic term for norm_bbch
#### increases R2 from 0.34 to 0.37
```{r add quadratic term for norm_bbch}
summary(lm(yLT50ACC ~ frc + raf + fum + poly(norm_bbch,2), data = arafield4_regressiondata_norm))
# Call:
# lm(formula = yLT50ACC ~ frc + raf + fum + poly(norm_bbch, 2), 
#     data = arafield4_regressiondata)
# Residuals:
#    Min     1Q Median     3Q    Max 
# -3.154 -1.004  0.135  0.930  4.021 
# Coefficients:
#                     Estimate Std. Error t value Pr(>|t|)    
# (Intercept)          -7.6495     0.5646  -13.55  < 2e-16 ***
# frc                   0.0447     0.0346    1.29    0.199    
# raf                  -0.7717     0.2287   -3.37    0.001 ** 
# fum                  -0.0658     0.0339   -1.94    0.055 .  
# poly(norm_bbch, 2)1   8.2905     1.4813    5.60  1.8e-07 ***
# poly(norm_bbch, 2)2   3.5948     1.5641    2.30    0.024 *  
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
# Residual standard error: 1.47 on 103 degrees of freedom
# Multiple R-squared:  0.372,  Adjusted R-squared:  0.342 
# F-statistic: 12.2 on 5 and 103 DF,  p-value: 2.62e-09


testlm2 <- lm(I(1/yLT50ACC) ~ frc + raf + fum + poly(norm_bbch,2), data = arafield4_regressiondata_norm)
summary(lm(I(1/yLT50ACC) ~ frc + raf + fum + poly(norm_bbch,2), data = arafield4_regressiondata_norm))
```


### regression model for LT50NAC
```{r regression model for LT50NAC}
############## Regressionsmodell fuer LT50NAC #######################
arafield4_regressionNAC <- lm(yLT50NAC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                antho + bbch + anthoscore, data = arafield4_regressiondata)

summary(arafield4_regressionNAC)
# Call:
# lm(formula = yLT50NAC ~ glc + frc + suc + raf + aa + mal + fum + 
#     pro + antho + norm_bbch + anthoscore, data = arafield4_regressiondata)
# 
# Residuals:
#     Min      1Q  Median      3Q     Max 
# -1.8135 -0.4997  0.0778  0.4670  1.9091 
# 
# Coefficients:
#             Estimate Std. Error t value Pr(>|t|)    
# (Intercept) -5.33125    0.56514   -9.43  2.2e-15 ***
# glc          0.02267    0.01850    1.23    0.223    
# frc         -0.00334    0.02881   -0.12    0.908    
# suc          0.00742    0.01887    0.39    0.695    
# raf         -0.33558    0.16354   -2.05    0.043 *  
# aa          -0.01578    0.02878   -0.55    0.585    
# mal         -0.00922    0.01573   -0.59    0.559    
# fum         -0.00404    0.02009   -0.20    0.841    
# pro          1.42423    1.29303    1.10    0.273    
# antho        0.15910    0.08030    1.98    0.050 .  
# norm_bbch    0.26992    0.11543    2.34    0.021 *  
# anthoscore  -0.16358    0.11168   -1.46    0.146    
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
# 
# Residual standard error: 0.783 on 97 degrees of freedom
# Multiple R-squared:  0.212,  Adjusted R-squared:  0.122 
# F-statistic: 2.37 on 11 and 97 DF,  p-value: 0.0122

# Vorhersage der LT50-Werte mit Hilfe des Modells (fuer Oekotypen, die im Modell enthalten sind)
arafield4_regressionNAC$fitted.values

cor(yLT50NAC4,arafield4_regressionNAC$fitted.values)
# 0.479 bzw. R2 = 0.23
```


### prediction of LT50NAC for test data
```{r prediction of LT50NAC for test data}
arafield4_predictionNAC <- predict(arafield4_regressionNAC, arafield4_predictiondata)

measuredLT50NAC <- metabolite_arafield4_prediction$LT50NAC

head(data.frame(arafield4_predictiondata, arafield4_predictionNAC, measuredLT50NAC)[,c(1,14,15)])
#      acc arafield4_predictionNAC measuredLT50NAC
# 1   Be-0                   -5.15           -4.63
# 2   Be-0                   -5.32           -4.63
# 3 Bsch-2                   -5.85           -5.43
# 4 Bsch-2                   -6.13           -5.43
# 5 Bsch-2                   -5.81           -5.43
# 6 Bsch-2                   -6.15           -5.43
```


### stepAIC for LT50NAC
```{r stepAIC for LT50NAC}
arafield4_stepAIC_NAC <- stepAIC(arafield4_regressionNAC)

summary(arafield4_stepAIC_NAC)
# Residual standard error: 0.767 on 103 degrees of freedom
# Multiple R-squared:  0.196,  Adjusted R-squared:  0.157 
# F-statistic: 5.03 on 5 and 103 DF,  p-value: 0.000368

# fuer Oekotypen, die im Modell sind
predictedLT50NAC4_stepAIC <- arafield4_stepAIC_NAC$coefficients[1] + 
  arafield4_regressiondata$glc*arafield4_stepAIC_NAC$coefficients[2] +
  arafield4_regressiondata$raf*arafield4_stepAIC_NAC$coefficients[3] + 
  arafield4_regressiondata$antho*arafield4_stepAIC_NAC$coefficients[4] +
  arafield4_regressiondata$norm_bbch*arafield4_stepAIC_NAC$coefficients[5] + 
  arafield4_regressiondata$anthoscore*arafield4_stepAIC_NAC$coefficients[6]

# entspricht
arafield4_stepAIC_NAC$fitted.values

# fuer Oekotypen, die nicht im Modell sind
arafield4_prediction_stepAIC_NAC <- predict(arafield4_stepAIC_NAC, arafield4_predictiondata)

head(data.frame(arafield4_predictiondata, arafield4_prediction_stepAIC_NAC, measuredLT50NAC)[,c(1,14,15)])
#      acc arafield4_prediction_stepAIC_NAC measuredLT50NAC
# 1   Be-0                            -5.06           -4.63
# 2   Be-0                            -5.11           -4.63
# 3 Bsch-2                            -5.91           -5.43
# 4 Bsch-2                            -6.03           -5.43
# 5 Bsch-2                            -5.62           -5.43
# 6 Bsch-2                            -6.01           -5.43
```


### regression model for acclimation capacity
```{r regression model for acclimation capacity}
# yCapacity4

arafield4_regressionCap <- lm(yCapacity4 ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                antho + norm_bbch + anthoscore, data = arafield4_regressiondata_norm)

summary(arafield4_regressionCap)
# Call:
# lm(formula = yCapacity4 ~ glc + frc + suc + raf + aa + mal + 
#     fum + pro + antho + norm_bbch + anthoscore, data = arafield4_regressiondata)
# Residuals:
#     Min      1Q  Median      3Q     Max 
# -2.6966 -0.5716  0.0427  0.6911  2.7839 
# Coefficients:
#             Estimate Std. Error t value Pr(>|t|)    
# (Intercept)  -1.6892     0.8248   -2.05  0.04327 *  
# glc          -0.0137     0.0270   -0.51  0.61409    
# frc           0.0402     0.0421    0.96  0.34129    
# suc           0.0252     0.0275    0.92  0.36155    
# raf          -0.8114     0.2387   -3.40  0.00098 ***
# aa           -0.0217     0.0420   -0.52  0.60589    
# mal           0.0127     0.0230    0.55  0.58046    
# fum          -0.0615     0.0293   -2.10  0.03857 *  
# pro           1.0586     1.8872    0.56  0.57613    
# antho         0.0163     0.1172    0.14  0.88965    
# norm_bbch     0.6915     0.1685    4.10  8.4e-05 ***
# anthoscore   -0.0693     0.1630   -0.43  0.67168    
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
# Residual standard error: 1.14 on 97 degrees of freedom
# Multiple R-squared:  0.346,  Adjusted R-squared:  0.272 
# F-statistic: 4.67 on 11 and 97 DF,  p-value: 1.05e-05

# Vorhersage der Kapazitaet mit Hilfe des Modells (fuer Oekotypen, die im Modell enthalten sind)
arafield4_regressionCap$fitted.values

cor(yCapacity4,arafield4_regressionCap$fitted.values)
# 0.589 bzw. R2 = 0.347
```


### prediction of capacity for test data
```{r prediction of capacity for test data}
# Vorhersage der LT50-Werte fuer ausgewaehlte Akzessionen mit Hilfe des berechneten Regressionsmodells

arafield4_predictionCap <- predict(arafield4_regressionCap, arafield4_predictiondata_norm)

measuredCap <- measuredLT50ACC - measuredLT50NAC

head(data.frame(arafield4_predictiondata, arafield4_predictionCap, measuredCap)[,c(1,14,15)])
#      acc arafield4_predictionCap measuredCap
# 1   Be-0                   -2.71       -1.07
# 2   Be-0                   -2.41       -1.07
# 3 Bsch-2                   -4.08       -3.70
# 4 Bsch-2                   -4.81       -3.70
# 5 Bsch-2                   -3.26       -3.70
# 6 Bsch-2                   -3.99       -3.70
```


### stepAIC for Capacity
```{r stepAIC for Capacity}
arafield4_stepAIC_Cap <- stepAIC(arafield4_regressionCap)

summary(arafield4_stepAIC_Cap)
# Residual standard error: 1.11 on 104 degrees of freedom
# Multiple R-squared:  0.334,  Adjusted R-squared:  0.308 
# F-statistic:   13 on 4 and 104 DF,  p-value: 1.25e-08

# fuer Oekotypen, die im Modell sind
arafield4_stepAIC_Cap$fitted.values

# fuer Oekotypen, die nicht im Modell sind
arafield4_prediction_stepAIC_Cap <- predict(arafield4_stepAIC_Cap, arafield4_predictiondata_norm)

head(data.frame(arafield4_predictiondata_norm, arafield4_prediction_stepAIC_Cap, measuredCap)[,c(1,14,15)])
#      acc arafield4_prediction_stepAIC_Cap measuredCap
# 1   Be-0                            -2.71       -1.07
# 2   Be-0                            -2.36       -1.07
# 3 Bsch-2                            -3.93       -3.70
# 4 Bsch-2                            -4.92       -3.70
# 5 Bsch-2                            -3.22       -3.70
# 6 Bsch-2                            -4.05       -3.70
```


# loo-cv
# loo-cv field 3
```{r loo-cv field 3}
accessions_known

field3_error_cv <- c()

for(acc in accessions_known){
  
  accessions_training_cv <- accessions_known[-which(acc==accessions_known)]
  accessions_testing_cv <- accessions_known[which(acc==accessions_known)]
  
  idx_train_cv <- which(field3$accession %in% accessions_training_cv)
  idx_test_cv <- which(field3$accession %in% accessions_testing_cv)
  
  field3_train_cv <- field3[idx_train_cv, model_colnames]
  field3_test_cv <- field3[idx_test_cv, model_colnames]
  
  colnames(field3_train_cv) <- colnames(field3_test_cv) <- model_colnames_short
  
  #field3_regressionACC_factor_cv <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
  #                                  factor(bbch) + factor(anthoscore), data = field3_train_cv)
  
  field3_regressionACC_factor_cv <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    bbch + anthoscore, data = field3_train_cv)
  
  field3_error_cv <- c(field3_error_cv, 
                       sum(((predict(field3_regressionACC_factor_cv, field3_test_cv)) - 
                              (field3_test_cv$LT50ACC))^2)/ sum((field3_test_cv$LT50ACC)^2))
}

names(field3_error_cv) <- accessions_known

```


# loo-cv field 4
```{r loo-cv field 4}
accessions_known

field4_error_cv <- c()

for(acc in accessions_known){
  
  accessions_training_cv <- accessions_known[-which(acc==accessions_known)]
  accessions_testing_cv <- accessions_known[which(acc==accessions_known)]
  
  idx_train_cv <- which(field4$accession %in% accessions_training_cv)
  idx_test_cv <- which(field4$accession %in% accessions_testing_cv)
  
  field4_train_cv <- field4[idx_train_cv, model_colnames]
  field4_test_cv <- field4[idx_test_cv, model_colnames]
  
  colnames(field4_train_cv) <- colnames(field4_test_cv) <- model_colnames_short
  
  #field4_regressionACC_factor_cv <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
  #                                  factor(bbch) + factor(anthoscore), data = field4_train_cv)
  
  field4_regressionACC_factor_cv <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    bbch + anthoscore, data = field4_train_cv)
  
  field4_error_cv <- c(field4_error_cv, 
                       sum(((predict(field4_regressionACC_factor_cv, field4_test_cv)) - 
                              (field4_test_cv$LT50ACC))^2)/ sum((field4_test_cv$LT50ACC)^2))
}

names(field4_error_cv) <- accessions_known


plot(field3_error_cv, field4_error_cv)
```


## save workspace
```{r save workspace}
save.image("metabolite_arafield_model.RData")
sessionInfo()
```


```{r}
# knit2html("scripts/metabolite_arafield4_models.Rmd", output = "scripts/metabolite_arafield4_models.html")
```

