---
title: "Modelling of metabolite data Arabidopsis field trials"
author: "Heike Sprenger"
date: "Monday, July 18, 2016"
output:
  html_document:
    highlight: tango
    number_section: yes
    theme: cerulean
    toc: yes
    toc_float: true
    toc_depth: 4
editor_options: 
  chunk_output_type: console
---

# Set working directory  
```{r set working directory}
#getwd()
# setwd("D:/work/repos/ara_field_trials/")
# setwd("X:/mpimp/repos/ara_field_trials")
# setwd("E:/uschi-home-sync/uschi/Seafile/uschi-work/repos/ara_field_trials")
# setwd("/media/uschi/seagate/uschi-home-sync/uschi/Seafile/uschi-work/repos/ara_field_trials")
setwd("~/sync/Seafile/uschi-work/repos/ara_field_trials")
```

# Load workspace, packages and scripts
```{r load workspace, include=TRUE, message=FALSE}
# load packages
library(knitr)
library(pander)
library(ggplot2)
library(DAAG)
library(leaps)
library(faraway)
library(MASS)
library(glmnet)
library(caret)
library(tidyverse)
library(ggpubr)
library(lemon) # for coord_capped_cart
library(RColorBrewer)
library(ggrepel)

# set options for knitr
opts_chunk$set(fig.width=6, fig.height=5, tidy=TRUE, tidy.opts=list(width.cutoff=70))
opts_knit$set(root.dir = '../')

# load workspace
#load("metabolite_arafield_model_lt50_acc.RData")

pal_grey <- c("black", "grey50", "grey75")
```


# Source functions
```{r source functions}
source("../functions/func_calc_loocv.R", encoding = 'UTF-8')
source("../functions/func_calc_loocv_caret.R", encoding = 'UTF-8')
source("../functions/func_pred_plot.R")
```


# Load data
Use changed metabolite data, from ``metabolite_arafield4_overview.Rmd``
```{r load data}
field2 <- read.table("output/metabolite_arafield2_modified.txt", header = TRUE, sep = "\t")
field3 <- read.table("output/metabolite_arafield3_modified.txt", header = TRUE, sep = "\t")
field4 <- read.table("output/metabolite_arafield4_modified.txt", header = TRUE, sep = "\t")

# OLD VERSION
# lt50 <- read.table("data/LT50.txt", header = TRUE, sep = "\t")
# dim(lt50) 
# 58 accessions (= 52 accessions for training + 6 for testing)

# NEW VERSION with 64 accessions
lt50 <- read.table("data/LT50_64acc.txt", header = TRUE, sep = "\t")
dim(lt50)
# 64 accessions (= 52 accessions for training + 12 for testing)
table(lt50$Model)

# capacity
yCapacity4full <- field4$LT50ACC - field4$LT50NAC 
lt50$Capacity <- lt50$LT50ACC - lt50$LT50NAC

setdiff(lt50$Accession, field4$accession) # Ws missing in Field 4
setdiff(lt50$Accession, field3$accession)
setdiff(lt50$Accession, field2$accession)
setdiff(field4$accession, lt50$Accession)
setdiff(field3$accession, lt50$Accession)
setdiff(field2$accession, lt50$Accession)

length(unique(field2$accession))
length(unique(field3$accession))
length(unique(field4$accession))

setdiff(field3$accession, field4$accession)

# Number accessions with known LT50
length(intersect(field2$accession, lt50$Accession))
length(intersect(field3$accession, lt50$Accession))
length(intersect(field4$accession, lt50$Accession))
```


## Set factor levels correctly
```{r set factor levels correctly}
# antho score (en)
field2$antho_value_en <- factor(field2$antho_value_en, 
                                              levels = c("very low", "low", "intermediate", "high", "very high"))
field3$antho_value_en <- factor(field3$antho_value_en, 
                                              levels = c("low", "intermediate", "high", "very high")) # "very low" is not present
field4$antho_value_en <- factor(field4$antho_value_en, 
                                              levels = c("very low", "low", "intermediate", "high", "very high"))

# bbch_id as factor
class(field4$bbch_id)
field2$bbch_factor <- factor(field2$bbch_id)
field3$bbch_factor <- factor(field3$bbch_id)
field4$bbch_factor <- factor(field4$bbch_id)

# bbch categories
field2$bbch_categories <- factor(field2$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))
field3$bbch_categories <- factor(field3$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))
field4$bbch_categories <- factor(field4$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))

# flowering state
field2$flowering_state <- factor(field2$flowering_state, levels = c("non-flowering", "flowering"))
field3$flowering_state <- factor(field3$flowering_state, levels = c("non-flowering", "flowering"))
field4$flowering_state <- factor(field4$flowering_state, levels = c("non-flowering", "flowering"))

# vegetative state
field2$vegetative_state <- factor(field2$vegetative_state, levels = c("vegetative", "non-vegetative"))
field3$vegetative_state <- factor(field3$vegetative_state, levels = c("vegetative", "non-vegetative"))
field4$vegetative_state <- factor(field4$vegetative_state, levels = c("vegetative", "non-vegetative"))
```

## Remove missing values (NAs)
```{r remove missing values (NAs)}
dim(field2) # 94
dim(field3) # 162
dim(field4) # 160

field2 <- field2[which(!is.na(field2$sucrose_positive) ), ]
field3 <- field3[which(!is.na(field3$fumarate_positive) ), ]
# Field4-Tsu, SampleID: 837060, Plant: [At.Tsu-0.n].2.2-4 --> missing values for BBCH and antho-Score! --> remove?
field4 <- field4[which(!is.na(field4$anthoscore) ), ]

dim(field2) # 93
dim(field3) # 160
dim(field4) # 159
```


## Standardize metabolite levels
```{r standardize metabolite levels}
hist(field4$proline_positive)
hist(field4$prolineT)
hist(scale(field4$prolineT))

field2_scaled <- data.frame(field2[,c("accession", "plant_name", "LT50ACC", "LT50NAC", 
                                      "capacity", "bbch_id", "anthoscore", "bbch_factor", "antho_value_en")],
                            scale(field2[,c("glucoseT","fructoseT","sucroseT","raffinoseT",
                                            "amino_acidsT","malateT","fumarateT","prolineT")]))

field3_scaled <- data.frame(field3[,c("accession", "plant_name", "LT50ACC", "LT50NAC", 
                                      "capacity", "bbch_id", "anthoscore", "bbch_factor", "antho_value_en")],
                            scale(field3[,c("glucoseT","fructoseT","sucroseT","raffinoseT",
                                            "amino_acidsT","malateT","fumarateT","prolineT")]))

field4_scaled <- data.frame(field4[,c("accession", "plant_name", "LT50ACC", "LT50NAC", 
                                      "capacity", "bbch_id", "anthoscore", "bbch_factor", "antho_value_en")],
                            scale(field4[,c("glucoseT","fructoseT","sucroseT","raffinoseT",
                                            "amino_acidsT","malateT","fumarateT","prolineT")]))
```



# Define data for modeling
## Define training and test accessions
```{r define training and test accessions}
table(lt50$Model)
accessions_training <- as.character(lt50$Accession[which(lt50$Model == "train")])
accessions_testing <- as.character(lt50$Accession[which(lt50$Model == "test")])
accessions_known <- as.character(lt50$Accession)
accessions_unknown <- as.character(setdiff(field3$accession, lt50$Accession))
sum(length(accessions_known), length(accessions_unknown))

# indices for accessions for training/testing
idx_train2 <- which(field2$accession %in% accessions_training)
idx_train3 <- which(field3$accession %in% accessions_training)
idx_train4 <- which(field4$accession %in% accessions_training)
idx_test2 <- which(field2$accession %in% accessions_testing)
idx_test3 <- which(field3$accession %in% accessions_testing)
idx_test4 <- which(field4$accession %in% accessions_testing)
idx_all2 <- which(field2$accession %in% accessions_known)
idx_all3 <- which(field3$accession %in% accessions_known)
idx_all4 <- which(field4$accession %in% accessions_known)

idx_unknown2 <- which(field2$accession %in% accessions_unknown)
idx_unknown3 <- which(field3$accession %in% accessions_unknown)
idx_unknown4 <- which(field4$accession %in% accessions_unknown)
```

## Define colnames
```{r define colnames}
model_colnames_short <- c("accession", "plant_name", "LT50ACC", "LT50NAC", "cap",
                          "glc","frc","suc","raf","aa","mal","fum","pro","bbch","anthoscore")

# transformed and scaled variables
model_colnamesT <- c("accession", "plant_name", "LT50ACC", "LT50NAC", "capacity",
                    "glucoseT", "fructoseT", "sucroseT","raffinoseT", "amino_acidsT", 
                    "malateT", "fumarateT", "prolineT", "bbch_id", "anthoscore")

model_colnamesT_factor <- model_colnamesT
model_colnamesT_factor[14:15] <- c("bbch_factor", "antho_value_en")
```


### Subset for model training/testing
```{r subset for model training/testing}
# training set
field2_trainT <- field2_scaled[idx_train2, model_colnamesT]
field3_trainT <- field3_scaled[idx_train3, model_colnamesT]
field4_trainT <- field4_scaled[idx_train4, model_colnamesT]
field2_trainT_fac <- field2_scaled[idx_train2, model_colnamesT_factor]
field3_trainT_fac <- field3_scaled[idx_train3, model_colnamesT_factor]
field4_trainT_fac <- field4_scaled[idx_train4, model_colnamesT_factor]

# testing set
field2_testT <- field2_scaled[idx_test2, model_colnamesT]
field3_testT <- field3_scaled[idx_test3, model_colnamesT]
field4_testT <- field4_scaled[idx_test4, model_colnamesT]
field2_testT_fac <- field2_scaled[idx_test2, model_colnamesT_factor]
field3_testT_fac <- field3_scaled[idx_test3, model_colnamesT_factor]
field4_testT_fac <- field4_scaled[idx_test4, model_colnamesT_factor]

# all accessions
field2_allT_fac <- field2_scaled[idx_all2, model_colnamesT_factor]
field3_allT_fac <- field3_scaled[idx_all3, model_colnamesT_factor]
field4_allT_fac <- field4_scaled[idx_all4, model_colnamesT_factor]

# only accessions with unknown LT50
field2_unknownT_fac <- field2_scaled[idx_unknown2, model_colnamesT_factor]
field3_unknownT_fac <- field3_scaled[idx_unknown3, model_colnamesT_factor]
field4_unknownT_fac <- field4_scaled[idx_unknown4, model_colnamesT_factor]

# remove NA samples
# field2_trainT_fac <- field2_trainT_fac[which(!is.na(field2_trainT_fac$sucrose_positive) ), ]
# field3_trainT_fac <- field3_trainT_fac[which(!is.na(field3_trainT_fac$fumarate_positive) ), ]
# field3_testT_fac <- field3_testT_fac[which(!is.na(field3_testT_fac$fumarate_positive) ), ]

# Field4-Tsu, SampleID: 837060, Plant: [At.Tsu-0.n].2.2-4 --> missing values for BBCH and antho-Score! --> remove?
# field4_trainT_fac <- field4_trainT_fac[which(!is.na(field4_trainT_fac$anthoscore) ), ]

length(unique(field2_trainT_fac$accession)) # 42 
length(unique(field3_trainT_fac$accession)) # 52/48 (with/without NAs for fumarate!)
length(unique(field4_trainT_fac$accession)) # 51

length(unique(field2_testT_fac$accession)) # 6
length(unique(field3_testT_fac$accession)) # 12/9 (with/without NAs for fumarate)
length(unique(field4_testT_fac$accession)) # 12
```


## Data splitting NEW
```{r data splitting NEW}
n_obs <- nrow(lt50) # 64
source("../functions/func_get_splits.R")
set.seed(1234)
folds <- func_get_splits(seq = sample(1:n_obs), num = 8)

folds_acc <- folds

for(i in 1:8){
  for(j in 1:8){
    folds_acc[i,j] <- as.character(lt50$Accession)[folds[i,j]]
  }
}

# trainsets will be a list of 8 dataframes
x_f4_train <- x_f4_test <- y_f4_train <- y_f4_test <- list()

for(i in 1:8){
  idx_train4 <- which(field4$accession %in% c(folds_acc[-i,]))
  idx_test4 <- which(field4$accession %in% folds_acc[i,])
  
  x_f4_train[[i]] <- field4_scaled[idx_train4, model_colnamesT_factor[6:15]]
  x_f4_test[[i]] <- field4_scaled[idx_test4, model_colnamesT_factor[6:15]]
  y_f4_train[[i]] <- field4_scaled[idx_train4, "LT50ACC"]
  y_f4_test[[i]] <- field4_scaled[idx_test4, "LT50ACC"]
}

dim(x_f4_train[[1]])
# 117 rows = observations, 10 columns

dim(x_f4_test[[1]])
# 18 rows = observations, 10 columns
```


## Define freezing tolerance per trial
```{r define freezing tolerance per trial}
# field2_train_LT50ACC <- field2_train$LT50ACC
# field3_train_LT50ACC <- field3_train$LT50ACC
# field4_train_LT50ACC <- field4_train$LT50ACC
# 
# yLT50NAC2 <- field2_train$LT50NAC
# yLT50NAC3 <- field3_train$LT50NAC
# yLT50NAC4 <- field4_train$LT50NAC
# 
# yCapacity2 <- field2_train$capacity
# yCapacity3 <- field3_train$capacity
# yCapacity4 <- field4_train$capacity
```


## Change colnames and export data
- using transformed and scaled data
```{r change colnames and export data}
# training data
colnames(field2_trainT) <- colnames(field3_trainT) <- 
  colnames(field4_trainT) <- model_colnames_short
colnames(field2_trainT_fac) <- colnames(field3_trainT_fac) <- 
  colnames(field4_trainT_fac) <- model_colnames_short
# test data
colnames(field2_testT) <- colnames(field3_testT) <- 
  colnames(field4_testT) <- model_colnames_short
colnames(field2_testT_fac) <- colnames(field3_testT_fac) <- 
  colnames(field4_testT_fac) <- model_colnames_short
# all accessions
colnames(field2_allT_fac) <- colnames(field3_allT_fac) <- 
  colnames(field4_allT_fac) <- model_colnames_short
# data for accessions of unknown LT50
colnames(field2_unknownT_fac) <- colnames(field3_unknownT_fac) <- 
  colnames(field4_unknownT_fac) <- model_colnames_short

# training data
write.table(field2_trainT_fac, "output/metabolite_arafield2_trainT_fac.txt", sep="\t")
write.table(field3_trainT_fac, "output/metabolite_arafield3_trainT_fac.txt", sep="\t")
write.table(field4_trainT_fac, "output/metabolite_arafield4_trainT_fac.txt", sep="\t")
# test data
write.table(field2_testT_fac, "output/metabolite_arafield2_testT_fac.txt", sep="\t")
write.table(field3_testT_fac, "output/metabolite_arafield3_testT_fac.txt", sep="\t")
write.table(field4_testT_fac, "output/metabolite_arafield4_testT_fac.txt", sep="\t")
```


# Linear Regression of LT50ACC (Training)
## Use transformed and scaled data (with factor)
```{r regACC transformed and scaled data - with factor}
field2T_regressionACC_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                     bbch + anthoscore, data = field2_trainT_fac)
field3T_regressionACC_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                     bbch + anthoscore, data = field3_trainT_fac)
field4T_regressionACC_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                     bbch + anthoscore, data = field4_trainT_fac)

summary(field2T_regressionACC_factor)$r.squared # 0.481
summary(field3T_regressionACC_factor)$r.squared # 0.350
summary(field4T_regressionACC_factor)$r.squared # 0.428

cor(field4T_regressionACC_factor$fitted.values, field4_trainT_fac$LT50ACC) # R = 0.654
#predict(field4T_regressionACC_factor, field4_trainT_fac[,6:15]) # equivalent to fitted.values
```

## Combine predictions across trials
```{r combine training predictions across trials}
pred_df2_train <- data.frame(data = "trial2",
                       accession = field2_trainT_fac$accession,
                       measured = field2_trainT_fac$LT50ACC,
                       predicted = field2T_regressionACC_factor$fitted.values)

pred_df3_train <- data.frame(data = "trial3",
                       accession = field3_trainT_fac$accession,
                       measured = field3_trainT_fac$LT50ACC,
                       predicted = field3T_regressionACC_factor$fitted.values)

pred_df4_train <- data.frame(data = "trial4",
                       accession = field4_trainT_fac$accession,
                       measured = field4_trainT_fac$LT50ACC,
                       predicted = field4T_regressionACC_factor$fitted.values)

pred_df_train <- rbind(pred_df2_train, pred_df3_train, pred_df4_train)
```

## Correlation scatter plot
```{r correlation training scatter plot}
range(pred_df_train$predicted)
range(pred_df_train$measured)
lim_values <- c(-12.5, -5)

sp_train <- ggscatter(pred_df_train, x = "measured", y = "predicted",
                add = "reg.line", 
                add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
                conf.int = TRUE)

sp_train_lim <- ggpar(sp_train, ylim = lim_values, xlim = lim_values)
sp_train_facet <- facet(sp_train_lim + theme_bw(), facet.by = "data")
sp_train_final <- sp_train_facet + stat_cor(method = "pearson", label.x.npc = 'center', label.y.npc = 'top')

ggsave(filename = "figures/predictions_train_corr_plot.png", 
       plot = sp_train_final, width = 10, height = 4, dpi = 600)
```


# Linear Regression of LT50ACC (All Data)
## Use transformed and scaled data (with factor)
```{r regACC transformed and scaled data - with factor}
field2T_regressionACC_all_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                     bbch + anthoscore, data = field2_allT_fac)
field3T_regressionACC_all_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                     bbch + anthoscore, data = field3_allT_fac)
field4T_regressionACC_all_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                     bbch + anthoscore, data = field4_allT_fac)

summary(field2T_regressionACC_all_factor)$r.squared # 0.500
summary(field3T_regressionACC_all_factor)$r.squared # 0.394
summary(field4T_regressionACC_all_factor)$r.squared # 0.410

cor(field4T_regressionACC_all_factor$fitted.values, field4_allT_fac$LT50ACC) # R = 0.640
#predict(field4T_regressionACC_all_factor, field4_allT_fac[,6:15]) # equivalent to fitted.values
```

# Apply models to different datasets (other trials)
## All accessions
```{r apply models to different datasets ALL}
field2T_regressionACC_all_factor$xlevels$bbch <- union(field2T_regressionACC_all_factor$xlevels$bbch,
                                                   union(levels(field3_allT_fac$bbch),
                                                         levels(field4_allT_fac$bbch)))
field3T_regressionACC_all_factor$xlevels$bbch <- union(field3T_regressionACC_all_factor$xlevels$bbch,
                                                   levels(field4_allT_fac$bbch))
field4T_regressionACC_all_factor$xlevels$bbch <- union(field4T_regressionACC_all_factor$xlevels$bbch,
                                                   levels(field3_allT_fac$bbch))


field3T_regressionACC_all_factor$xlevels$anthoscore <- union(field3T_regressionACC_all_factor$xlevels$anthoscore,
                                                             levels(field4_allT_fac$anthoscore))

field3T_regressionACC_all_factor_pred2 <- predict(field3T_regressionACC_all_factor, field2_allT_fac[,6:15]) # 3>2
field3T_regressionACC_all_factor_pred4 <- predict(field3T_regressionACC_all_factor, field4_allT_fac[,6:15]) # 3>4
field4T_regressionACC_all_factor_pred2 <- predict(field4T_regressionACC_all_factor, field2_allT_fac[,6:15]) # 4>2
field4T_regressionACC_all_factor_pred3 <- predict(field4T_regressionACC_all_factor, field3_allT_fac[,6:15]) # 4>3
field2T_regressionACC_all_factor_pred3 <- predict(field2T_regressionACC_all_factor, field3_allT_fac[,6:15]) # 2>3
field2T_regressionACC_all_factor_pred4 <- predict(field2T_regressionACC_all_factor, field4_allT_fac[,6:15]) # 2>4
```

## Training accessions
```{r apply models to different datasets TRAINING}
field2T_regressionACC_factor$xlevels$bbch <- union(field2T_regressionACC_factor$xlevels$bbch,
                                                   union(levels(field3_trainT_fac$bbch),
                                                         levels(field4_trainT_fac$bbch)))
field4T_regressionACC_factor$xlevels$bbch <- union(field4T_regressionACC_factor$xlevels$bbch,
                                                   levels(field3_trainT_fac$bbch))
field3T_regressionACC_factor$xlevels$bbch <- union(field3T_regressionACC_factor$xlevels$bbch,
                                                   levels(field4_trainT_fac$bbch))
field3T_regressionACC_factor$xlevels$anthoscore <- union(field3T_regressionACC_factor$xlevels$anthoscore,
                                                         levels(field4_trainT_fac$anthoscore))

field3T_regressionACC_factor_pred2 <- predict(field3T_regressionACC_factor, field2_trainT_fac[,6:15]) # 3>2
field3T_regressionACC_factor_pred4 <- predict(field3T_regressionACC_factor, field4_trainT_fac[,6:15]) # 3>4
field4T_regressionACC_factor_pred2 <- predict(field4T_regressionACC_factor, field2_trainT_fac[,6:15]) # 4>2
field4T_regressionACC_factor_pred3 <- predict(field4T_regressionACC_factor, field3_trainT_fac[,6:15]) # 4>3
field2T_regressionACC_factor_pred3 <- predict(field2T_regressionACC_factor, field3_trainT_fac[,6:15]) # 2>3
field2T_regressionACC_factor_pred4 <- predict(field2T_regressionACC_factor, field4_trainT_fac[,6:15]) # 2>4
```

## Plot predicted vs. measured LT50ACC (across trials)
```{r plot predicted vs. measured LT50ACC (across trials)}
plot(field2_trainT_fac$LT50ACC, field3T_regressionACC_factor_pred2)
cor(field2_trainT_fac$LT50ACC, field3T_regressionACC_factor_pred2) # 0.45
cor(field2_allT_fac$LT50ACC, field3T_regressionACC_all_factor_pred2) # 0.48

plot(field4_trainT_fac$LT50ACC, field3T_regressionACC_factor_pred4)
cor(field4_trainT_fac$LT50ACC, field3T_regressionACC_factor_pred4) # 0.485
cor(field4_allT_fac$LT50ACC, field3T_regressionACC_all_factor_pred4) # 0.48

plot(field3_trainT_fac$LT50ACC, field4T_regressionACC_factor_pred3)
cor(field3_trainT_fac$LT50ACC, field4T_regressionACC_factor_pred3) # 0.413
cor(field3_allT_fac$LT50ACC, field4T_regressionACC_all_factor_pred3) # 0.46

plot(field2_trainT_fac$LT50ACC, field4T_regressionACC_factor_pred2)
cor(field2_trainT_fac$LT50ACC, field4T_regressionACC_factor_pred2)

plot(field3_trainT_fac$LT50ACC, field2T_regressionACC_factor_pred3)
cor(field3_trainT_fac$LT50ACC, field2T_regressionACC_factor_pred3)

plot(field4_trainT_fac$LT50ACC, field2T_regressionACC_factor_pred4)
cor(field4_trainT_fac$LT50ACC, field2T_regressionACC_factor_pred4)
```

## Combine predictions across trials
```{r combine predictions across trials}
pred_df2 <- data.frame(data = "trial2",
                       accession = field2_allT_fac$accession,
                       measured = field2_allT_fac$LT50ACC,
                       model2 = field2T_regressionACC_all_factor$fitted.values,
                       model3 = field3T_regressionACC_all_factor_pred2,
                       model4 = field4T_regressionACC_all_factor_pred2)

pred_df3 <- data.frame(data = "trial3",
                       accession = field3_allT_fac$accession,
                       measured = field3_allT_fac$LT50ACC,
                       model2 = field2T_regressionACC_all_factor_pred3,
                       model3 = field3T_regressionACC_all_factor$fitted.values,
                       model4 = field4T_regressionACC_all_factor_pred3)

pred_df4 <- data.frame(data = "trial4",
                       accession = field4_allT_fac$accession,
                       measured = field4_allT_fac$LT50ACC,
                       model2 = field2T_regressionACC_all_factor_pred4,
                       model3 = field3T_regressionACC_all_factor_pred4,
                       model4 = field4T_regressionACC_all_factor$fitted.values)

pred_df_all <- rbind(pred_df2, pred_df3, pred_df4)

pred_df_all_ <- 
  pred_df_all %>%
  gather(key = "model", value = "predicted", 4:6)
```

## Correlation scatter plot
```{r correlation scatter plot}
range(pred_df_all_$predicted)
lim_values <- c(-12.5, -4)

sp <- ggscatter(pred_df_all_, x = "measured", y = "predicted",
                add = "reg.line", 
                add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
                conf.int = TRUE)

sp_lim <- ggpar(sp, ylim = lim_values, xlim = lim_values)

sp_facet <- facet(sp_lim + theme_bw(), facet.by = c("model","data"))

sp_final <- sp_facet + stat_cor(method = "pearson", label.x.npc = 'center', label.y.npc = 'top')

ggsave(filename = "figures/predictions_all_corr_plot.png", plot = sp_final, width = 7, height = 7)
```

# Prediction of LT50ACC
## Prediction of LT50ACC training data
```{r prediction of LT50ACC training data}
cor.test(field2T_regressionACC_factor$fitted.values, field2_trainT_fac$LT50ACC) # R = 0.67
cor.test(field3T_regressionACC_factor$fitted.values, field3_trainT_fac$LT50ACC) # R = 0.598
cor.test(field4T_regressionACC_factor$fitted.values, field4_trainT_fac$LT50ACC) # R = 0.656 / R2 = 0.43

plot(field2_trainT_fac$LT50ACC, field2T_regressionACC_factor$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), 
     pch = 19)
abline(lm(field2T_regressionACC_factor$fitted.values ~ field2_trainT_fac$LT50ACC))

plot(field3_trainT_fac$LT50ACC, field3T_regressionACC_factor$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), 
     pch = 19)
abline(lm(field3T_regressionACC_factor$fitted.values ~ field3_trainT_fac$LT50ACC))

plot(field4_trainT_fac$LT50ACC, field4T_regressionACC_factor$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(field4T_regressionACC_factor$fitted.values ~ field4_trainT_fac$LT50ACC))
```

## Prediction of LT50ACC test data
```{r prediction of LT50ACC for test data}
# Vorhersage der LT50-Werte fuer ausgewaehlte Akzessionen mit Hilfe des berechneten Regressionsmodells
field2T_predictionACC_factor <- predict(field2T_regressionACC_factor, field2_testT_fac[,6:15])
field3T_predictionACC_factor <- predict(field3T_regressionACC_factor, field3_testT_fac[,6:15])
field4T_predictionACC_factor <- predict(field4T_regressionACC_factor, field4_testT_fac[,6:15])
```

### Tables of predicted LT50ACC for test data
```{r tables of predicted LT50ACC for test data}
field2_predictionACC_table <- data.frame(accession = field2_testT_fac$accession,
                                         measured = field2_testT_fac$LT50ACC,
                                         predicted = field2T_predictionACC_factor)

field3_predictionACC_table <- data.frame(accession = field3_testT_fac$accession,
                                         measured = field3_testT_fac$LT50ACC,
                                         predicted = field3T_predictionACC_factor)

field4_predictionACC_table <- data.frame(accession = field4_testT_fac$accession,
                                         measured = field4_testT_fac$LT50ACC,
                                         predicted = field4T_predictionACC_factor)

head(field2_predictionACC_table)
head(field3_predictionACC_table)
head(field4_predictionACC_table)

write.table(field2_predictionACC_table, "output/field2_predictionACC.txt", sep="\t")
write.table(field3_predictionACC_table, "output/field3_predictionACC.txt", sep="\t")
write.table(field4_predictionACC_table, "output/field4_predictionACC.txt", sep="\t")
```


### Correlation of predicted and measured LT50ACC for test data
```{r correlation of predicted and measured LT50ACC for test data}
# field 2
cor(field2_testT_fac$LT50ACC, field2T_predictionACC_factor)
# field 3
cor(field3_testT_fac$LT50ACC, field3T_predictionACC_factor)
# field 4
cor(field4_testT_fac$LT50ACC, field4T_predictionACC_factor)
```


### Difference between predicted and measured LT50 for test data
```{r difference between predicted and measured LT50 for test data}
sum(((field2T_predictionACC_factor)-(field2_testT_fac$LT50ACC))^2)
# 14.5
sum(((field2T_predictionACC_factor)-(field2_testT_fac$LT50ACC))^2) / sum((field2_testT_fac$LT50ACC)^2)
# 0.0159

sum(((field3T_predictionACC_factor)-(field3_testT_fac$LT50ACC))^2)
# 25.2
sum(((field3T_predictionACC_factor)-(field3_testT_fac$LT50ACC))^2) / sum((field3_testT_fac$LT50ACC)^2)
# 0.011

sum(((field4T_predictionACC_factor)-(field4_testT_fac$LT50ACC))^2)
# 58.5
sum(((field4T_predictionACC_factor)-(field4_testT_fac$LT50ACC))^2) / sum((field4_testT_fac$LT50ACC)^2)
# 0.0258
```


### Barplots of predicted LT50ACC for test data
```{r barplots of predicted LT50ACC for test data}
# plot(field4_testT_fac$LT50ACC, field4T_predictionACC_factor)

barplot(t(as.matrix(field2_predictionACC_table[,2:3])), 
        beside=T, names.arg = field2_predictionACC_table$accession, las=2)

barplot(t(as.matrix(field3_predictionACC_table[,2:3])), 
        beside=T, names.arg = field3_predictionACC_table$accession, las=2)

barplot(t(as.matrix(field4_predictionACC_table[,2:3])), 
        beside=T, names.arg = field4_predictionACC_table$accession, las=2)
```

### Confidence interval
```{r confidence interval}
# mehr zum Thema Vorhersage und Konfidenz-Intervalle im Kapitel 3 im Buch Regression, Seite 123
# Vorhersage mit 95%-Vorhersageintervall
head(predict(field4T_regressionACC_factor, field4_testT_fac, interval="prediction"))
# Vorhersage mit 95%-Konfidenzintervall
head(predict(field4T_regressionACC_factor, field4_testT_fac, interval="confidence"))
```

# Accessions of unknown LT50
```{r accessions of unknown LT50}
accessions_unknown

field3T_regressionACC_all_factor$xlevels$`bbch` <- union(field3T_regressionACC_all_factor$xlevels$`bbch`,
                                                        levels(field3_unknownT_fac$bbch))

field4T_regressionACC_all_factor$xlevels$`bbch` <- union(field4T_regressionACC_all_factor$xlevels$`bbch`,
                                                        levels(field4_unknownT_fac$bbch))

field2T_unknown_predictionACC_factor <- predict(field2T_regressionACC_all_factor, field2_unknownT_fac[,6:15])
field3T_unknown_predictionACC_factor <- predict(field3T_regressionACC_all_factor, field3_unknownT_fac[,6:15])
field4T_unknown_predictionACC_factor <- predict(field4T_regressionACC_all_factor, field4_unknownT_fac[,6:15])
names(field2T_unknown_predictionACC_factor) <- field2_unknownT_fac$accession
names(field3T_unknown_predictionACC_factor) <- field3_unknownT_fac$accession
names(field4T_unknown_predictionACC_factor) <- field4_unknownT_fac$accession
```

# ANOVA per model/trial
```{r ANOVA per model}
# training data
anova(field2T_regressionACC_factor)
anova(field3T_regressionACC_factor)
anova(field4T_regressionACC_factor)
# summary(field2T_regressionACC_factor)
# summary(field3T_regressionACC_factor)
# summary(field4T_regressionACC_factor)

anova_resT_regressionACC_factor <- data.frame(field2 = anova(field2T_regressionACC_factor)[["Pr(>F)"]],
                                              field3 = anova(field3T_regressionACC_factor)[["Pr(>F)"]],
                                              field4 = anova(field4T_regressionACC_factor)[["Pr(>F)"]])
rownames(anova_resT_regressionACC_factor) <- rownames(anova(field2T_regressionACC_factor))

# all data
anova(field2T_regressionACC_all_factor)
anova(field3T_regressionACC_all_factor)
anova(field4T_regressionACC_all_factor)
# summary(field2T_regressionACC_all_factor)
# summary(field3T_regressionACC_all_factor)
# summary(field4T_regressionACC_all_factor)

anova_resT_regressionACC_all_factor <- data.frame(field2 = anova(field2T_regressionACC_all_factor)[["Pr(>F)"]],
                                              field3 = anova(field3T_regressionACC_all_factor)[["Pr(>F)"]],
                                              field4 = anova(field4T_regressionACC_all_factor)[["Pr(>F)"]])
rownames(anova_resT_regressionACC_all_factor) <- rownames(anova(field2T_regressionACC_all_factor))

write.table(anova_resT_regressionACC_factor, "output/anova_resT_regressionACC_factor.txt", sep = "\t")
write.table(anova_resT_regressionACC_all_factor, "output/anova_resT_regressionACC_all_factor.txt", sep = "\t")
```

## Combine ANOVA p-values of all trials
```{r Combine ANOVA of all trials}
field2T_regressionACC_all_factor_anova <- 
  # anova(field2T_regressionACC_factor)[1:10,] %>% 
  anova(field2T_regressionACC_all_factor)[1:10,] %>% 
  rownames_to_column("predictor") %>%
  mutate(trial = "Field 2007/08")

field3T_regressionACC_all_factor_anova <- 
  # anova(field3T_regressionACC_factor)[1:10,] %>% 
  anova(field3T_regressionACC_all_factor)[1:10,] %>% 
  rownames_to_column("predictor") %>%
  mutate(trial = "Field 2008/09")

field4T_regressionACC_all_factor_anova <- 
  # anova(field4T_regressionACC_factor)[1:10,] %>% 
  anova(field4T_regressionACC_all_factor)[1:10,] %>% 
  rownames_to_column("predictor") %>%
  mutate(trial = "Field 2009/10")

# fieldT_regressionACC_factor_anova <-
#   bind_rows(field2T_regressionACC_factor_anova,
#             field3T_regressionACC_factor_anova,
#             field4T_regressionACC_factor_anova)

fieldT_regressionACC_all_factor_anova <-
  bind_rows(field2T_regressionACC_all_factor_anova,
            field3T_regressionACC_all_factor_anova,
            field4T_regressionACC_all_factor_anova)

# colnames(fieldT_regressionACC_factor_anova)[6] <- "pvalue"
colnames(fieldT_regressionACC_all_factor_anova)[6] <- "pvalue"

# fieldT_regressionACC_factor_anova %>%
#   ggplot(.) + geom_tile(aes(x = trial, y = predictor, fill = -log10(pvalue)))

fieldT_regressionACC_all_factor_anova %>%
  ggplot(.) + geom_tile(aes(x = trial, y = predictor, fill = -log10(pvalue)))

# plot(-log10(fieldT_regressionACC_factor_anova$pvalue),-log10(fieldT_regressionACC_all_factor_anova$pvalue) )

# for table in manuscript?
# fieldT_regressionACC_factor_anova %>%
#   dplyr::select(predictor, trial, pvalue) %>%
#   pivot_wider(names_from = trial, values_from = pvalue, id_cols = "predictor") %>% View
```

# LASSO model
## LASSO model field 3
```{r LASSO model field 3}
x <- as.matrix(field3_trainT[,6:15])
y <- field3_trainT$LT50ACC

test_x <- as.matrix(field3_testT[,6:15])
test_y <- field3_testT$LT50ACC

set.seed(1)
field3_lasso_ACC <- glmnet(x,y)

# Cross-validation
set.seed(1)
field3_lasso_cv_ACC <- cv.glmnet(x, y)

# compare different alpha values
set.seed(1)
field3_lasso_cv_ACC1 <- cv.glmnet(x, y, alpha=1)
set.seed(1)
field3_lasso_cv_ACC.5 <- cv.glmnet(x, y, alpha=0.5)
set.seed(1)
field3_lasso_cv_ACC0 <- cv.glmnet(x, y, alpha=0)
plot(field3_lasso_cv_ACC1)
plot(field3_lasso_cv_ACC.5)
plot(field3_lasso_cv_ACC0)
plot(log(field3_lasso_cv_ACC1$lambda),field3_lasso_cv_ACC1$cvm,pch=19,
     col="red",xlab="log(Lambda)",ylab=field3_lasso_cv_ACC1$name, 
     xlim = c(-6,6), ylim = c(2.5,3.1))
points(log(field3_lasso_cv_ACC.5$lambda),field3_lasso_cv_ACC.5$cvm,pch=19,col="grey")
points(log(field3_lasso_cv_ACC0$lambda),field3_lasso_cv_ACC0$cvm,pch=19,col="blue")
legend("topleft",legend=c("alpha= 1","alpha= .5","alpha 0"),pch=19,col=c("red","grey","blue"))

# use no specific lambda
field3_lasso_ACC_pred_test <- predict(field3_lasso_ACC, new = test_x)

# calculate mean error
field3_lasso_ACC_pred_test_err <- apply( (field3_lasso_ACC_pred_test - test_y)^2, 2, mean )

# use optimal lamba value
field3_lasso_ACC_pred_all_lambda <- predict(field3_lasso_cv_ACC, new = x, s="lambda.min")
field3_lasso_ACC_pred_test_lambda <- predict(field3_lasso_cv_ACC, new = test_x, s="lambda.min")

# number of variables in model (for lambda.min)
which(field3_lasso_cv_ACC$lambda == field3_lasso_cv_ACC$lambda.min)
# 24
field3_lasso_cv_ACC$nzero[24]
# 8

# coefficients
field3_lasso_cv_ACC$glmnet.fit$beta[,"s23"]

cor.test(y, field3_lasso_ACC_pred_all_lambda)
# 0.599
cor.test(test_y, field3_lasso_ACC_pred_test_lambda)
# 0.582

field3_lasso_ACC_pred_test_lambda_table <- data.frame(accession = field3_test$accession,
                                                      measured = field3_test$LT50ACC,
                                                      lasso = field3_lasso_ACC_pred_test_lambda, 
                                                      regression_fac = field3_predictionACC_factor)

sum(((field3_lasso_ACC_pred_test_lambda)-(field3_test$LT50ACC))^2)
# 47.8

sum(((field3_lasso_ACC_pred_test_lambda)-(field3_test$LT50ACC))^2) / sum((field3_test$LT50ACC)^2)
# 0.0211
```


## LASSO model field 4
```{r LASSO model field 4}
x <- as.matrix(field4_train[,6:15])
y <- field4_train$LT50ACC

test_x <- as.matrix(field4_test[,6:15])
test_y <- field4_test$LT50ACC

set.seed(1)
field4_lasso_ACC <- glmnet(x,y)

# Cross-validation
set.seed(1)
field4_lasso_cv_ACC <- cv.glmnet(x, y)
# plot(field4_lasso_cv_ACC)

# compare different alpha values
# compare different alpha values
field4_lasso_cv_ACC1 <- cv.glmnet(x, y, alpha=1)
field4_lasso_cv_ACC.95 <- cv.glmnet(x, y, alpha=0.95)
field4_lasso_cv_ACC.5 <- cv.glmnet(x, y, alpha=0.5)
field4_lasso_cv_ACC0 <- cv.glmnet(x, y, alpha=0)
plot(field4_lasso_cv_ACC1)
plot(field4_lasso_cv_ACC.95)
plot(field4_lasso_cv_ACC.5)
plot(field4_lasso_cv_ACC0)
plot(log(field4_lasso_cv_ACC1$lambda),field4_lasso_cv_ACC1$cvm,pch=19,
     col="red",xlab="log(Lambda)",ylab=field4_lasso_cv_ACC1$name, 
     xlim = c(-6,6), ylim = c(2.1,3.4))
points(log(field4_lasso_cv_ACC.95$lambda),field4_lasso_cv_ACC.95$cvm,pch=19,col="green")
points(log(field4_lasso_cv_ACC.5$lambda),field4_lasso_cv_ACC.5$cvm,pch=19,col="grey")
points(log(field4_lasso_cv_ACC0$lambda),field4_lasso_cv_ACC0$cvm,pch=19,col="blue")
legend("topleft",legend=c("alpha= 1","alpha= .95","alpha= .5","alpha 0"),pch=19,col=c("red","green","grey","blue"))

# use no specific lambda
field4_lasso_ACC_pred_test <- predict(field4_lasso_ACC, new = test_x)

# calculate mean error
field4_lasso_ACC_pred_test_err <- apply( (field4_lasso_ACC_pred_test - test_y)^2, 2, mean )
# points(log(field4_lasso_ACC$lambda), field4_lasso_ACC_pred_test_err, col="blue", pch="*")

# use optimal lamba value
field4_lasso_ACC_pred_all_lambda <- predict(field4_lasso_cv_ACC, new = x, s="lambda.min")
field4_lasso_ACC_pred_test_lambda <- predict(field4_lasso_cv_ACC, new = test_x, s="lambda.min")

# number of variables in model (for lambda.min)
which(field4_lasso_cv_ACC$lambda == field4_lasso_cv_ACC$lambda.min)
# 23
field4_lasso_cv_ACC$nzero[23]
# 4

# coefficients
field4_lasso_cv_ACC$glmnet.fit$beta[,"s22"]


# plot observed vs. predicted DRYM
# plot(y, lasso_all_pred_all_lambda)
# abline(0,1)
cor.test(y, field4_lasso_ACC_pred_all_lambda) # 0.609
cor.test(test_y, field4_lasso_ACC_pred_test_lambda) # 0.592

field4_lasso_ACC_pred_test_lambda_table <- data.frame(accession = field4_test$accession,
                                                      measured = field4_test$LT50ACC,
                                                      lasso = field4_lasso_ACC_pred_test_lambda, 
                                                      regression = field4_predictionACC,
                                                      regression_fac = field4_predictionACC_factor)


# barplot(t(as.matrix(lasso_all_pred_test_lambda_table[,2:3])), 
#         beside=T, names.arg = lasso_all_pred_test_lambda_table$acc, las=2)
# 
# barplot(t(as.matrix(lasso_all_pred_test_lambda_table[,2:4])), 
#         beside=T, names.arg = lasso_all_pred_test_lambda_table$acc, las=2)

sum(((field4_lasso_ACC_pred_test_lambda)-(field4_test$LT50ACC))^2)
# 38.3

sum(((field4_lasso_ACC_pred_test_lambda)-(field4_test$LT50ACC))^2) / sum((field4_test$LT50ACC)^2)
# 0.0169
```


## Prediction of LT50ACC with model (for accessions that are included in the model = training data)
```{r prediction of LT50ACC using model with ORIGINAL BBCH and LASSO}
cor.test(field4_regressionACC$fitted.values, field4_train$LT50ACC)
# R = 0.636
cor.test(field4_lasso_ACC_pred_all_lambda, field4_train$LT50ACC)
# R = 0.609

par(mfrow=c(1,2))

plot(field4_train$LT50ACC, field4_regressionACC$fitted.values, main = "regression",
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(field4_regressionACC$fitted.values ~ field4_train$LT50ACC))
#lm(field4_regressionACC$fitted.values ~ field4_train$LT50ACC)

plot(field4_train$LT50ACC, field4_lasso_ACC_pred_all_lambda, main = "lasso",
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(field4_lasso_ACC_pred_all_lambda ~ field4_train$LT50ACC))
#lm(field4_lasso_ACC_pred_all_lambda ~ field4_train$LT50ACC)
```



# Variable selection

**step is a slightly simplified version of stepAIC in package MASS (Venables & Ripley, 2002 and earlier editions).**

## Create initial NULL model
```{r Create initial NULL model}
field2T_regressionACC_fac_null <- lm(field2_trainT_fac$LT50ACC ~ 1, data = field2_trainT_fac)
field3T_regressionACC_fac_null <- lm(field3_trainT_fac$LT50ACC ~ 1, data = field3_trainT_fac)
field4T_regressionACC_fac_null <- lm(field4_trainT_fac$LT50ACC ~ 1, data = field4_trainT_fac)
```


## Field2
```{r variable selection field2}
stepAIC(object = field2T_regressionACC_factor, scope = formula(field2T_regressionACC_factor), 
        direction = "backward") # 72.58
stepAIC(object = field2T_regressionACC_factor, scope = formula(field2T_regressionACC_factor), 
        direction = "both") # 72.58
stepAIC(object = field2T_regressionACC_fac_null, scope = formula(field2T_regressionACC_factor),
        direction = "both") # 72.58
stepAIC(object = field2T_regressionACC_fac_null, scope = formula(field2T_regressionACC_factor), direction = "forward") # 72.58

step(object = field2T_regressionACC_factor, scope = formula(field2T_regressionACC_factor), 
     direction = "backward") # 72.58
step(object = field2T_regressionACC_factor, scope = formula(field2T_regressionACC_factor), 
     direction = "both") # 72.58
step(object = field2T_regressionACC_fac_null, scope = formula(field2T_regressionACC_factor), 
     direction = "both") # 72.58
step(object = field2T_regressionACC_fac_null, scope = formula(field2T_regressionACC_factor), 
     direction = "forward") # 72.58


field2T_regressionACC_factor_red <- step(object = field2T_regressionACC_factor, 
                                         scope = formula(field2T_regressionACC_factor), 
                                         direction = "both")
# AIC=72.58, mal, raf, fum
```

## Field3
```{r variable selection field3}
stepAIC(object = field3T_regressionACC_factor, scope = formula(field3T_regressionACC_factor), direction = "backward") # 99.08
stepAIC(object = field3T_regressionACC_factor, scope = formula(field3T_regressionACC_factor), direction = "both") # 99.08
stepAIC(object = field3T_regressionACC_fac_null, scope = formula(field3T_regressionACC_factor), direction = "both") 
# AIC=99.49, bbch + aa + suc
stepAIC(object = field3T_regressionACC_fac_null, scope = formula(field3T_regressionACC_factor), direction = "forward") # 100.85

step(object = field3T_regressionACC_factor, scope = formula(field3T_regressionACC_factor), direction = "backward") # 99.08
step(object = field3T_regressionACC_factor, scope = formula(field3T_regressionACC_factor), direction = "both") # 99.08
step(object = field3T_regressionACC_fac_null, scope = formula(field3T_regressionACC_factor), direction = "both") # 99.49
step(object = field3T_regressionACC_fac_null, scope = formula(field3T_regressionACC_factor), direction = "forward") # 100.85

field3T_regressionACC_factor_red <- step(object = field3T_regressionACC_factor, 
                                         scope = formula(field3T_regressionACC_factor), 
                                         direction = "both")
# AIC=99.08, glc + raf + fum + pro
```

## Field4
```{r variable selection field4}
stepAIC(object = field4T_regressionACC_factor, scope = formula(field4T_regressionACC_factor), direction = "backward") # 94.17
stepAIC(object = field4T_regressionACC_factor, scope = formula(field4T_regressionACC_factor), direction = "both") # 94.17
stepAIC(object = field4T_regressionACC_fac_null, scope = formula(field4T_regressionACC_factor), direction = "both") # 94.17
stepAIC(object = field4T_regressionACC_fac_null, scope = formula(field4T_regressionACC_factor), direction = "forward") # 94.17

step(object = field4T_regressionACC_factor, scope = formula(field4T_regressionACC_factor), direction = "backward") # 94.17
step(object = field4T_regressionACC_factor, scope = formula(field4T_regressionACC_factor), direction = "both") # 94.17
step(object = field4T_regressionACC_fac_null, scope = formula(field4T_regressionACC_factor), direction = "both") # 94.17
step(object = field4T_regressionACC_fac_null, scope = formula(field4T_regressionACC_factor), direction = "forward") # 94.17

field4T_regressionACC_factor_red <- step(object = field4T_regressionACC_factor, 
                                         scope = formula(field4T_regressionACC_factor), 
                                         direction = "both")
# AIC=94.17, suc, raf, factor(bbch)
```


## Combine predictions across trials REDUCED
```{r combine training predictions across trials REDUCED}
pred_df2_train_red <- data.frame(data = "trial2",
                                 accession = field2_trainT_fac$accession,
                                 measured = field2_trainT_fac$LT50ACC,
                                 predicted = field2T_regressionACC_factor_red$fitted.values)

pred_df3_train_red <- data.frame(data = "trial3",
                                 accession = field3_trainT_fac$accession,
                                 measured = field3_trainT_fac$LT50ACC,
                                 predicted = field3T_regressionACC_factor_red$fitted.values)

pred_df4_train_red <- data.frame(data = "trial4",
                                 accession = field4_trainT_fac$accession,
                                 measured = field4_trainT_fac$LT50ACC,
                                 predicted = field4T_regressionACC_factor_red$fitted.values)

pred_df_train_red <- rbind(pred_df2_train_red, 
                           pred_df3_train_red, 
                           pred_df4_train_red)
```


## Correlation scatter plot
```{r correlation training scatter plot REDUCED}
range(pred_df_train_red$predicted)
range(pred_df_train_red$measured)
lim_values <- c(-12.5, -5)

sp_red <- ggscatter(pred_df_train_red, x = "measured", y = "predicted",
                add = "reg.line", 
                add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
                conf.int = TRUE)

sp_red_lim <- ggpar(sp_red, ylim = lim_values, xlim = lim_values)
sp_red_facet <- facet(sp_red_lim + theme_bw(), facet.by = "data")
sp_red_final <- sp_red_facet + stat_cor(method = "pearson", label.x = -11, label.y.npc = 'top')

ggsave(filename = "figures/predictions_train_reduced_corr_plot.png", 
       plot = sp_red_final, width = 10, height = 4, dpi = 600)
```


# Model comparison regarding test set
```{r Model comparison regarding test set}
pred_df_test2 <- data.frame(trial = "trial2",
                            data = "field2",
                            accession = field2_testT_fac$accession, 
                            measured = field2_testT_fac$LT50ACC,
                            predicted_full = predict(field2T_regressionACC_factor, field2_testT_fac),
                            predicted_reduced = predict(field2T_regressionACC_factor_red, field2_testT_fac))

pred_df_test3 <- data.frame(trial = "trial3",
                            data = "field3",
                            accession = field3_testT_fac$accession, 
                            measured = field3_testT_fac$LT50ACC,
                            predicted_full = predict(field3T_regressionACC_factor, field3_testT_fac),
                            predicted_reduced = predict(field3T_regressionACC_factor_red, field3_testT_fac))

pred_df_test4 <- data.frame(trial = "trial4",
                            data = "field4",
                            accession = field4_testT_fac$accession, 
                            measured = field4_testT_fac$LT50ACC,
                            predicted_full = predict(field4T_regressionACC_factor, field4_testT_fac),
                            predicted_reduced = predict(field4T_regressionACC_factor_red, field4_testT_fac))

pred_df_test <- rbind(pred_df_test2, pred_df_test3, pred_df_test4)

pred_df_test_ <- 
  pred_df_test %>%
  gather(key = "model", value = "predicted", 5:6)

pred_df_test_2 <- 
  pred_df_test %>%
  gather(key = "model", value = "value", 4:6) %>%
  droplevels()
```

## Correlation scatter plot
```{r correlation test scatter plot}
range(pred_df_test_$predicted)
range(pred_df_test_$measured)
lim_values <- c(-12.5, -5)

sp_test <- ggscatter(pred_df_test_, x = "measured", y = "predicted",
                add = "reg.line", 
                add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
                conf.int = TRUE)

sp_test_lim <- ggpar(sp_test, ylim = lim_values, xlim = lim_values)
sp_test_facet <- facet(sp_test_lim + theme_bw(), facet.by = c("model","trial"))
sp_test_final <- sp_test_facet + stat_cor(method = "pearson", label.x = -12, label.y.npc = 'top')

ggsave(filename = "figures/predictions_test_corr_plot.png", 
       plot = sp_test_final, width = 7, height = 5, dpi = 600)
```

## Barplot of predicted LT50ACC
```{r barplot of predicted LT50ACC test accessions}
lt50_test <- lt50 %>% 
  filter(Accession %in% accessions_testing) %>% 
  droplevels() %>%
  arrange(-LT50ACC) # decreasing order by LT50ACC

pred_df_test_2$accession <- factor(pred_df_test_2$accession, 
                                   levels = as.character(lt50_test$Accession))

levels(pred_df_test_2$trial) <- c("Field 2007/08", "Field 2008/09", "Field 2009/10")

p_bar_test <- 
  ggplot(pred_df_test_2) + 
  geom_bar(aes(x = accession, y = value, fill = model),
           position = "dodge", stat = "summary",  fun.y = "mean") +
  scale_fill_manual(name = "", values = pal_grey,
                    breaks = c("measured", "predicted_full", "predicted_reduced"),
                    labels = c("measured", "predicted full model", "predicted reduced model")) +
  theme_bw() + ylab(expression("LT"[50]*"ACC (°C)")) +
  facet_wrap(~ trial) + 
  # theme_pubr() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position = "bottom")

ggsave(filename = "figures/predictions_test_barplot.png", 
       plot = p_bar_test, width = 8, height = 5, dpi = 600)
```

## Mean and absolute difference per accession
```{r Mean and absolute difference per test accession}
pred_test_mean_df <- 
  pred_df_test %>%
  group_by(data,accession) %>%
  summarise(pred_full_mean = mean(predicted_full),
            pred_full_se = sd(predicted_full)/sqrt(length(predicted_full)),
            pred_red_mean = mean(predicted_reduced),
            pred_red_se = sd(predicted_reduced)/sqrt(length(predicted_reduced))) %>%
  left_join(lt50, by = c("accession" = "Accession")) %>%
  dplyr::select(-LT50NAC, -SE_LT50NAC, -Model, -Capacity) %>%
  mutate(abs_diff_full = abs(pred_full_mean - LT50ACC)) %>%
  mutate(abs_diff_red = abs(pred_red_mean - LT50ACC))
```

## Barplot of mean per accession (and error bars)
```{r Barplot of mean per test accession}
pred_test_mean_longer <-
  pred_test_mean_df %>%
  dplyr::select(-abs_diff_full, -abs_diff_red) %>%
  dplyr::rename("mean_predictedFull" = pred_full_mean) %>%
  dplyr::rename("se_predictedFull" = pred_full_se) %>%
  dplyr::rename("mean_predictedRed" = pred_red_mean) %>%
  dplyr::rename("se_predictedRed" = pred_red_se) %>%
  dplyr::rename("mean_measured" = LT50ACC) %>%
  dplyr::rename("se_measured" = SE_LT50ACC) %>%
  pivot_longer(cols = -c(data, accession),
               names_to = c(".value", "set"), 
               names_pattern = "(.*)_(.*)") %>%
  left_join(lt50[,c(1,3)], by = c("accession" = "Accession"))

levels(pred_test_mean_longer$data) <- c("Field 2007/08", "Field 2008/09", "Field 2009/10")

barplot_pred_test_mean <- 
  pred_test_mean_longer %>%
  ggplot(., aes(x = reorder(accession, -LT50ACC), y = mean, fill = set)) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se),
                  width = 0.2,                    # Width of the error bars
                  position=position_dodge(0.9)) +
  facet_wrap(~data, ncol=3) +
  scale_fill_manual(name  = "", values = pal_grey,
                    breaks = c("measured", "predictedFull", "predictedRed"),
                    labels = c("measured", "predicted full model", "predicted reduced model")) +
  theme_bw() + xlab("accession") + 
  ylab(expression("LT"[50]*"ACC (°C)")) +
  theme(axis.text.x  = element_text(angle=90, hjust=1), legend.position = "bottom")

ggsave(filename = "figures/predictions_test_barplot_error.png", 
       plot = barplot_pred_test_mean, width = 8, height = 5, dpi = 600)
```


# LOO-CV
## Full model
```{r loo-cv field, warning=FALSE}
# full model
field2_error_cv <- func_calc_loocv(field_data = field2_scaled)
field3_error_cv <- func_calc_loocv(field_data = field3_scaled)
field4_error_cv <- func_calc_loocv(field_data = field4_scaled)

field2_pred_cv <- func_calc_loocv(field2_scaled, return_val = "pred", data_name = "field2")
field3_pred_cv <- func_calc_loocv(field3_scaled, return_val = "pred", data_name = "field3")
field4_pred_cv <- func_calc_loocv(field4_scaled, return_val = "pred", data_name = "field4")

pred_full_loocv_df <- rbind(field2_pred_cv, field3_pred_cv, field4_pred_cv)

range(pred_full_loocv_df$predicted)
range(pred_full_loocv_df$measured)
lim_values <- c(-12.5, -5)

sp_loocv <- ggscatter(pred_full_loocv_df, x = "measured", y = "predicted",
                add = "reg.line", 
                add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
                conf.int = TRUE)

sp_loocv_lim <- ggpar(sp_loocv, ylim = lim_values, xlim = lim_values)
sp_loocv_facet <- facet(sp_loocv_lim + theme_bw(), facet.by = "data")
sp_loocv_final <- sp_loocv_facet + stat_cor(method = "pearson", label.x.npc = 'center', label.y.npc = 'top')

ggsave(filename = "figures/predictions_loocv_corr_plot.png", 
       plot = sp_loocv_final, width = 10, height = 4, dpi = 600)
```

### Mean per accession for LT50 (pred vs measured)
```{r loo-cv field mean per accession, warning=FALSE}
pred_full_loocv_mean_df <- 
  pred_full_loocv_df %>%
  group_by(data,accession) %>%
  summarise(predicted_mean = mean(predicted),
            predicted_se = sd(predicted)/sqrt(length(predicted)),
            predicted_n = length(predicted)) %>%
  left_join(lt50, by = c("accession" = "Accession")) %>%
  dplyr::select(-LT50NAC, -SE_LT50NAC, -Model, -Capacity) %>%
  dplyr::rename("predicted" = "predicted_mean") %>%
  dplyr::rename("measured" = "LT50ACC") %>%
  mutate(abs_diff = abs(predicted - measured))

range(pred_full_loocv_mean_df$predicted)
range(pred_full_loocv_mean_df$measured)
lim_values <- c(-12.5, -5)

sp_loocv_mean <- ggscatter(pred_full_loocv_mean_df, x = "measured", y = "predicted",
                           add = "reg.line", 
                           add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
                           conf.int = TRUE)

sp_loocv_mean_lim <- ggpar(sp_loocv_mean, ylim = lim_values, xlim = lim_values)
sp_loocv_mean_facet <- facet(sp_loocv_mean_lim + theme_bw(), facet.by = "data")
sp_loocv_mean_final <- sp_loocv_mean_facet + stat_cor(method = "pearson", label.x = -11, label.y.npc = 'top')

ggsave(filename = "figures/predictions_loocv_corr_plot_mean.png", 
       plot = sp_loocv_mean_final, width = 10, height = 4, dpi = 600)
```

## Reduced model
### Field2
```{r LOO-CV reduced model field2}
field2_sel_vars <- variable.names(field2T_regressionACC_factor_red)[-1]
field2_sel_varsT <- c(model_colnamesT_factor[1:5], "raffinoseT", "malateT", "fumarateT")
field2_sel_vars_short <- c(model_colnames_short[1:5], field2_sel_vars)
field2_formula <- as.formula(paste("LT50ACC", paste(field2_sel_vars, collapse = " + "), sep = " ~ "))
print(field2_formula) # LT50ACC ~ raf + mal + fum

field2_red_pred_cv <- func_calc_loocv(field_data = field2_scaled, return_val = "pred", 
                                      data_name = "field2", 
                                      colnames_short = field2_sel_vars_short, 
                                      colnamesT_factor = field2_sel_varsT, 
                                      formula = field2_formula)
```

### Field3
```{r LOO-CV reduced model field3}
# field3T_regressionACC_factor_red
# glc + raf + fum + pro
field3_sel_vars <- c("glc", "raf", "fum", "pro")
field3_sel_varsT <- c(model_colnamesT_factor[1:5], "glucoseT", "raffinoseT", "fumarateT", "prolineT")

# alternative:
# field3T_regressionACC_factorAIC
# factor(bbch) + aa + suc
# field3_sel_vars <- c("bbch", "aa", "suc")
# field3_sel_varsT <- c(model_colnamesT_factor[1:5], "bbch_factor", "amino_acidsT", "sucroseT")
field3_sel_vars_short <- c(model_colnames_short[1:5], field3_sel_vars)

# field3_formula <- as.formula(paste("LT50ACC ~ bbch + aa + suc"))
field3_formula <- as.formula(paste("LT50ACC ~ glc + raf + fum + pro"))
print(field3_formula) # LT50ACC ~ glc + raf + fum + pro

field3_red_pred_cv <- func_calc_loocv(field_data = field3_scaled, return_val = "pred", 
                                      data_name = "field3", 
                                      colnames_short = field3_sel_vars_short, 
                                      colnamesT_factor = field3_sel_varsT, 
                                      formula = field3_formula)
```

### Field4
```{r LOO-CV reduced model field4}
# field4T_regressionACC_factor_red
field4_sel_vars <- c("bbch", "raf", "suc")
field4_sel_varsT <- c(model_colnamesT_factor[1:5], "bbch_factor", "raffinoseT", "sucroseT")
field4_sel_vars_short <- c(model_colnames_short[1:5], field4_sel_vars)
field4_formula <- as.formula(paste("LT50ACC", paste(field4_sel_vars, collapse = " + "), sep = " ~ "))
print(field4_formula) # LT50ACC ~ bbch + raf + suc

field4_red_pred_cv <- func_calc_loocv(field_data = field4_scaled, return_val = "pred", 
                                      data_name = "field4", 
                                      colnames_short = field4_sel_vars_short, 
                                      colnamesT_factor = field4_sel_varsT, 
                                      formula = field4_formula)
```

### Mean per accession (reduced model)
```{r Mean per accession (reduced model)}
pred_red_loocv_df <- rbind(field2_red_pred_cv, field3_red_pred_cv, field4_red_pred_cv)

pred_red_loocv_mean_df <- 
  pred_red_loocv_df %>%
  group_by(data,accession) %>%
  summarise(predicted_mean = mean(predicted),
            predicted_se = sd(predicted)/sqrt(length(predicted)),
            predicted_n = length(predicted)) %>%
  left_join(lt50, by = c("accession" = "Accession")) %>%
  dplyr::select(-LT50NAC, -SE_LT50NAC, -Model, -Capacity)

colnames(pred_red_loocv_mean_df)[3] <- "predicted"
colnames(pred_red_loocv_mean_df)[6] <- "measured"

pred_red_loocv_mean_df$abs_diff <- abs(pred_red_loocv_mean_df$predicted - pred_red_loocv_mean_df$measured)

pred_red_loocv_df$model <- "prediction (reduced model)"
pred_full_loocv_df$model <- "prediction (full model)"
```

### Combine full and reduced model
```{r Mean combine full and reduced model}
pred_all_loocv_df <- rbind(pred_full_loocv_df, pred_red_loocv_df)

pred_all_loocv_mean_df <- 
  pred_all_loocv_df %>%
  group_by(data,model,accession) %>%
  summarise(predicted_mean = mean(predicted),
            predicted_se = sd(predicted)/sqrt(length(predicted)),
            predicted_n = length(predicted)) %>%
  left_join(lt50, by = c("accession" = "Accession")) %>%
  dplyr::select(-LT50NAC, -SE_LT50NAC, -Model, -Capacity)

colnames(pred_all_loocv_mean_df)[4] <- "predicted"
colnames(pred_all_loocv_mean_df)[7] <- "measured"

pred_all_loocv_mean_df$abs_diff <- abs(pred_all_loocv_mean_df$predicted - pred_all_loocv_mean_df$measured)

range(pred_all_loocv_mean_df$predicted)
range(pred_all_loocv_mean_df$measured)
lim_values <- c(-12.5, -5)

sp_all_loocv_mean <- ggscatter(pred_all_loocv_mean_df, x = "measured", y = "predicted",
                           add = "reg.line", 
                           add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
                           conf.int = TRUE)

sp_all_loocv_mean_lim <- ggpar(sp_all_loocv_mean, ylim = lim_values, xlim = lim_values)
sp_all_loocv_mean_facet <- facet(sp_all_loocv_mean_lim + theme_bw(), facet.by = c("model","data"))
sp_all_loocv_mean_final <- sp_all_loocv_mean_facet + stat_cor(method = "pearson", label.x = -11, label.y.npc = 'top')

ggsave(filename = "figures/predictions_loocv_corr_plot_mean_full_red.png", 
       plot = sp_all_loocv_mean_final, width = 10, height = 7, dpi = 600)
```



## Plot of absolute difference between pred and measured
```{r Plot of absolute difference between pred and measured}
plot_abs_diff <- 
  pred_full_loocv_mean_df %>%
  ggplot(., aes(x = measured, y = abs_diff)) + 
  geom_point() + facet_wrap(~data) +
  geom_smooth()

ggsave(filename = "figures/predictions_loocv_abs_diff.png", 
       plot = plot_abs_diff, width = 8, height = 5, dpi = 600)

# with accession names as labels
plot_abs_diff2 <- 
  pred_full_loocv_mean_df %>%
  ggplot(., aes(x = measured, y = abs_diff, label = accession)) + 
  geom_point() + facet_wrap(~data) +
  geom_smooth() +
  geom_text_repel() 

ggsave(filename = "figures/predictions_loocv_abs_diff_label.png", 
       plot = plot_abs_diff2, width = 15, height = 8, dpi = 600)

# reduced + full model
plot_abs_diff_all <- 
  pred_all_loocv_mean_df %>%
  ggplot(., aes(x = measured, y = abs_diff, color = model, group = model)) + 
  geom_point() + facet_wrap(~data) +
  geom_smooth()

ggsave(filename = "figures/predictions_loocv_abs_diff_all.png", 
       plot = plot_abs_diff_all, width = 8, height = 5, dpi = 600)
```

## Compare training/test CV with LOO-CV results
```{r Compare training/test CV with LOO-CV results}
# merge training/test CV with LOO-CV results
pred_test_loocv_mean_df <-
  pred_all_loocv_mean_df %>%
  filter(model == "prediction (full model)") %>%
  inner_join(pred_test_mean_df, by = c("data", "accession"))

# scatterplot of absolute difference of LOOCV vs. training/test set
pred_test_loocv_mean_df %>%
  ggplot(., aes(x = abs_diff, y = abs_diff_full)) +
  geom_point() + facet_wrap(~data) +
  xlab("abs diff from LOOCV") + ylab("abs diff from test validation")

# scatterplot of absolute difference of LOOCV vs. training/test set --> difference between both abs_diff
pred_test_loocv_mean_df %>%
  mutate(loocv_test = abs_diff - abs_diff_full) %>%
  ggplot(., aes(x = accession, y = loocv_test)) +
  geom_bar(position = position_dodge(), stat = "identity") +
  facet_wrap(~data)

# barplot of absolute difference of LOOCV vs. training/test set
pred_test_loocv_mean_df %>%
  dplyr::select(data, accession, abs_diff, abs_diff_full) %>%
  rename(loocv = abs_diff) %>%
  rename(test = abs_diff_full) %>%
  pivot_longer(cols = c(loocv, test), names_to = "validation", values_to = "abs_diff") %>%
  ggplot(., aes(y = abs_diff, x = accession, fill = validation)) +
  geom_bar(position = position_dodge(), stat = "identity") + facet_wrap(~data) 
```

--> sometimes the absolute difference from LOOCV is lower and sometimes the training/test set one
--> no clear preference for one of the two


## Barplot of mean per accession (full model)
```{r Barplot of mean per accession (full model)}
pred_full_loocv_mean_longer <-
  pred_full_loocv_mean_df %>%
  dplyr::select(-predicted_n, -abs_diff) %>%
  dplyr::rename("mean_predicted" = predicted) %>%
  dplyr::rename("se_predicted" = predicted_se) %>%
  dplyr::rename("mean_measured" = measured) %>%
  dplyr::rename("se_measured" = SE_LT50ACC) %>%
  pivot_longer(cols = -c(data, accession),
               names_to = c(".value", "set"), 
               names_pattern = "(.*)_(.*)") %>%
  left_join(lt50[,c(1,3)], by = c("accession" = "Accession"))

barplot_pred_full_loocv_mean <- 
  pred_full_loocv_mean_longer %>%
  ggplot(., aes(x = reorder(accession, LT50ACC), y = mean, fill = set)) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se),
                  width = 0.2,                    # Width of the error bars
                  position=position_dodge(0.9)) +
  facet_rep_wrap(~data, ncol=1, repeat.tick.labels = 'all') +
  scale_fill_manual(name  = "", values = pal_grey[c(1,3)]) +
  theme_bw() + xlab("accession") + 
  ylab(expression("LT"[50]*"ACC (°C)")) +
  theme(axis.text.x  = element_text(angle=90, hjust=1), legend.position = "bottom")

ggsave(filename = "figures/predictions_loocv_barplot_mean.png", 
       plot = barplot_pred_full_loocv_mean, width = 10, height = 12, dpi = 600)
```

## Barplot of mean per accession (reduced and full model)
```{r Barplot of mean per accession (reduced and full model)}
# combine full and reduced model prediction results
pred_all_loocv_mean_longer <-
  pred_red_loocv_mean_df %>%
  dplyr::select(-predicted_n, -abs_diff) %>%
  dplyr::rename("mean_predictedR" = predicted) %>%
  dplyr::rename("se_predictedR" = predicted_se) %>%
  dplyr::rename("mean_measured" = measured) %>%
  dplyr::rename("se_measured" = SE_LT50ACC) %>%
  bind_cols(pred_full_loocv_mean_df[,3:4]) %>%
  dplyr::rename("mean_predictedF" = predicted) %>%
  dplyr::rename("se_predictedF" = predicted_se) %>%
  pivot_longer(cols = -c(data, accession),
               names_to = c(".value", "set"), 
               names_pattern = "(.*)_(.*)") %>%
  left_join(lt50[,c(1,3)], by = c("accession" = "Accession"))

levels(pred_all_loocv_mean_longer$data) <- c("Field 2007/08", "Field 2008/09", "Field 2009/10")

barplot_all_pred_loocv_mean <- 
  pred_all_loocv_mean_longer %>%
  ggplot(., aes(x = reorder(accession, LT50ACC), y = mean, fill = set)) + 
  geom_bar(position = position_dodge(), stat = "identity") +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se),
                  width = 0.2,                    # Width of the error bars
                  position=position_dodge(0.9)) +
  facet_rep_wrap(~data, ncol=1, repeat.tick.labels = 'all') +
  scale_fill_manual(name  = "",
                    values = pal_grey, #brewer.pal(n = 4, "Paired")[2:4],
                    breaks = c("measured", "predictedF", "predictedR"),
                    labels = c("measured", "predicted full model", "predicted reduced model")) +
  theme_bw() + xlab("accession") + 
  ylab(expression("LT"[50]*"ACC (°C)")) +
  theme(axis.text.x  = element_text(angle=90, hjust=1), legend.position = "bottom")

ggsave(filename = "figures/predictions_loocv_barplot_mean_all.png", 
       plot = barplot_all_pred_loocv_mean, width = 9, height = 10, dpi = 600)
```


# Caret
## Tuning parameters
```{r caret tuning parameters}
grid <- 10^ seq (10,-2, length = 100) # for lambda

# for glmnet (elastic net)
eGrid <- expand.grid(.alpha = c(0, .05, .1, .3, .5, .7, .9, .95, .99, 1), 
                     .lambda = 10^seq(from = -6,to = 0, length = 50)) # or grid
                     #.lambda = seq(1e-6, 1, length = 50)) # or grid

# for lasso
eGrid_lasso <- expand.grid(.fraction = 10^seq(from = -6,to = 0, length = 50)) # or grid


Control <- trainControl(#method = "LOOCV",
                        method = "repeatedcv", 
                        repeats = 5, number = 10,
                        verboseIter = TRUE)
```

## Lasso: LOO-CV models
```{r Lasso: LOO-CV models}
field2_pred_loocv <- func_calc_loocv_caret(field_data = field2_scaled, 
                                           method_val = "lasso", 
                                           eGrid_val = eGrid_lasso)

field3_pred_loocv <- func_calc_loocv_caret(field_data = field3_scaled, 
                                           method_val = "lasso", 
                                           eGrid_val = eGrid_lasso)

field4_pred_loocv <- func_calc_loocv_caret(field_data = field4_scaled, 
                                           method_val = "lasso", 
                                           eGrid_val = eGrid_lasso)
```

## Modify results and join with LT50
```{r Modify results and join with LT50}
field2_pred_loocv <- 
  field2_pred_loocv %>%
  left_join(lt50, by = c("accession" = "Accession"))

field3_pred_loocv <- 
  field3_pred_loocv %>%
  left_join(lt50, by = c("accession" = "Accession"))

field4_pred_loocv <- 
  field4_pred_loocv %>%
  left_join(lt50, by = c("accession" = "Accession"))
```

## Correlation between measured and predicted LT50
```{r Correlation between measured and predicted LT50}
plot(field2_pred_loocv$LT50ACC, field2_pred_loocv$predicted)
cor.test(field2_pred_loocv$LT50ACC, field2_pred_loocv$predicted) # 0.41135

plot(field3_pred_loocv$LT50ACC, field3_pred_loocv$predicted)
cor.test(field3_pred_loocv$LT50ACC, field3_pred_loocv$predicted) # 0.3131

plot(field4_pred_loocv$LT50ACC, field4_pred_loocv$predicted)
cor.test(field4_pred_loocv$LT50ACC, field4_pred_loocv$predicted) # 0.5310876 
```

## Plot Lasso predictions
```{r plot Lasso predictions}
# par(mfrow=c(1,1))
par(mfrow=c(1,2))

func_pred_plot(x = field2_pred_loocv$LT50ACC,
               y = field2_pred_loocv$predicted,
               main_text = "lasso model",
               labels = field2_pred_loocv$accession)
func_pred_plot(x = field2_pred_cv$measured,
               y = field2_pred_cv$predicted,
               main_text = "LOOCV linear reg model",
               labels = field2_pred_cv$accession)


func_pred_plot(x = field3_pred_loocv$LT50ACC,
               y = field3_pred_loocv$predicted,
               main_text = "lasso model",
               labels = field3_pred_loocv$accession)
func_pred_plot(x = field3_pred_cv$measured,
               y = field3_pred_cv$predicted,
               main_text = "LOOCV linear reg model",
               labels = field3_pred_cv$accession)


func_pred_plot(x = field4_pred_loocv$LT50ACC,
               y = field4_pred_loocv$predicted,
               main_text = "lasso model",
               labels = field4_pred_loocv$accession)
func_pred_plot(x = field4_pred_cv$measured,
               y = field4_pred_cv$predicted,
               main_text = "LOOCV linear reg model",
               labels = field4_pred_cv$accession)
```


## try out training with first fold of training data: field 3
```{r try out training with first fold of training data field 3}
method_val <- "glmnet"
# method_val <- "lasso"

# x_f3_train_caret <- field3_train[,c(6:15)]
# y_f3_train_caret <- field3_train$LT50ACC
# x_f3_test <- field3_test[,c(6:15)]
# y_f3_test <- field3_test$LT50ACC

x_f3_train_caret <- field3_trainT[,c(6:15)]
y_f3_train_caret <- field3_trainT$LT50ACC
x_f3_test <- field3_testT[,c(6:15)]
y_f3_test <- field3_testT$LT50ACC

set.seed(1234)
lassoFit_f3T <- train(x = x_f3_train_caret, 
                   y = y_f3_train_caret,
                   method = "lasso",
                   metric = "RMSE",
                   tuneGrid = eGrid_lasso,
                   trControl = Control)

set.seed(1234)
glmnetFit_f3T <- train(x = x_f3_train_caret, 
                   y = y_f3_train_caret,
                   method = "glmnet",
                   metric = "RMSE",
                   tuneGrid = eGrid,
                   trControl = Control)

lassoFit_f3T$bestTune # alpha: 1
# 0.754
# R2: 0.2149733

glmnetFit_f3T$bestTune
# original training data
# alpha: 0, lambda: 0.3237 --> ridge regression
# R2: 0.1481273, R: 0.385, RMSE: 1.61

# glmnet
table(coef(glmnetFit_f3T$finalModel, s = glmnetFit_f3T$bestTune$lambda)[,1] != 0)
# 4874 predictors (+ intercept) have coefficients that are not zero, the rest was removed

# table(coef(netFit_f3$finalModel, s = netFit_f3$bestTune$fraction)[,1] != 0)

plot(lassoFit_f3T, metric = "Rsquared")
plot(lassoFit_f3T, metric = "RMSE")
plot(glmnetFit_f3T, metric = "Rsquared")

cor.test(y_f3_test, predict(lassoFit_f3T, newdata = x_f3_test)) #  0.582
cor.test(y_f3_test, predict(glmnetFit_f3T, newdata = x_f3_test)) # 0.622
cor.test(y_f3_train_caret, predict(lassoFit_f3T, newdata = x_f3_train_caret))  # 0.503
cor.test(y_f3_train_caret, predict(glmnetFit_f3T, newdata = x_f3_train_caret)) # 0.505

plot(field3_trainT$LT50ACC, predict(lassoFit_f3T, newdata = x_f3_train_caret), 
     ylim=range(field3_trainT$LT50ACC), col="white")
text(field3_trainT$LT50ACC, predict(lassoFit_f3T, newdata = x_f3_train_caret),
     labels = as.character(field3_trainT$accession), cex = 0.8)
abline(0, 1, col = "grey")
abline(lm(predict(lassoFit_f3T, newdata = x_f3_train_caret) ~ field3_trainT$LT50ACC), col = "red")
```

## try out training with first fold of training data: field 4
```{r try out training with first fold of training data field 4}
# x_f4_train_caret <- field4_train[,c(6:15)]
# y_f4_train_caret <- field4_train$LT50ACC
# x_f4_test <- field4_test[,c(6:15)]
# y_f4_test <- field4_test$LT50ACC

x_f4_train_caret <- field4_trainT[,c(6:15)]
y_f4_train_caret <- field4_trainT$LT50ACC
x_f4_test <- field4_testT[,c(6:15)]
y_f4_test <- field4_testT$LT50ACC

set.seed(1234)
lassoFit_f4T <- train(x = x_f4_train_caret, 
                     y = y_f4_train_caret,
                     method = "lasso",
                     metric = "RMSE",
                     tuneGrid = eGrid_lasso,
                     trControl = Control)

set.seed(1234)
glmnetFit_f4T <- train(x = x_f4_train_caret, 
                      y = y_f4_train_caret,
                      method = "glmnet",
                      metric = "RMSE",
                      tuneGrid = eGrid,
                      trControl = Control)

lassoFit_f4$bestTune
# 0.569
# R2: 0.3687, R: 0.606

glmnetFit_f4$bestTune
# alpha: 0.95, lambda: 0.07906043 --> nearly ridge regression
# R2: 0.3678, R: 0.606, RMSE: 1.493873

# glmnet
table(coef(netFit_f4$finalModel, s = netFit_f4$bestTune$lambda)[,1] != 0)
# 4874 predictors (+ intercept) have coefficients that are not zero, the rest was removed

# table(coef(netFit_f4$finalModel, s = netFit_f4$bestTune$fraction)[,1] != 0)

plot(lassoFit_f4, metric = "Rsquared")
plot(lassoFit_f4T, metric = "Rsquared")
plot(glmnetFit_f4, metric = "Rsquared")
plot(glmnetFit_f4T, metric = "Rsquared")

# plot(y_f4_test, predict(glmnetFit_f4, newdata = x_f4_test))
cor(y_f4_test, predict(lassoFit_f4T, newdata = x_f4_test)) #  0.537
cor(y_f4_test, predict(glmnetFit_f4T, newdata = x_f4_test)) # 0.536
cor(y_f4_train_caret, predict(lassoFit_f4T, newdata = x_f4_train_caret))  # 0.623
cor(y_f4_train_caret, predict(glmnetFit_f4T, newdata = x_f4_train_caret)) # 0.623

plot(field4_train$LT50ACC, predict(netFit_f4, newdata = x_f4_train_caret), 
     ylim=range(field4_train$LT50ACC), col="white")
text(field4_train$LT50ACC, predict(netFit_f4, newdata = x_f4_train_caret),
     labels = as.character(field4_train$accession), cex = 0.8)
abline(0, 1, col = "grey")
abline(lm(predict(netFit_f4, newdata = x_f4_train_caret) ~ field4_train$LT50ACC), col = "red")
```

```{r}
par(mfrow=c(2,2))
func_pred_plot(x = test_y,
               y = field3_lasso_ACC_pred_test_lambda,
               main_text = "lasso model field 3",
               labels = field3_test$accession)

func_pred_plot(x = test_y,
               y = predict(netFit_f3, newdata = x_f3_test),
               main_text = "caret model field 3",
               labels = field3_test$accession)

func_pred_plot(x = test_y,
               y = field4_lasso_ACC_pred_test_lambda,
               main_text = "lasso model field 4",
               labels = field4_test$accession)

func_pred_plot(x = test_y,
               y = predict(netFit_f4, newdata = x_f4_test),
               main_text = "caret model field 4",
               labels = field4_test$accession)
```



## caret with nested CV
```{r caret with nested CV}
method_val <- "glmnet"
# method_val <- "lasso"

# predicted and corresponding true values
dim(folds)
# yhats_caret = matrix(nrow = nrow(folds), ncol = ncol(folds)) # fold in column
yhats_caret <- list()
rsquared_caret <- c()

fit_caret <- list()
fitcv_caret <- list()

# iterate over the outer folds 
for(i in 1:ncol(folds)){
  
  x_f4_train_caret <- x_f4_train[[i]]
  x_f4_test_caret <- x_f4_test[[i]]
  y_f4_train_caret <- y_f4_train[[i]]
  y_f4_test_caret <- y_f4_test[[i]]
  # colnames(x_train_caret) <- seq(1:ncol(x_train_caret))
  # colnames(x_test_caret) <- seq(1:ncol(x_test_caret))
  
  fit_caret[[i]] <- train(x = x_f4_train_caret, 
                          y = y_f4_train_caret,
                          method = method_val,
                          tuneGrid = eGrid,
                          # tuneGrid = eGrid_lasso,
                          trControl = Control)

  # predict the test set observations and calculate prediction score
  # yhats_caret[,i] <- predict(fit_caret[[i]], 
  #                    newdata = x_f4_test_caret)
  
  yhats_caret[[i]] <- predict(fit_caret[[i]], 
                              newdata = x_f4_test_caret)
  
  lm_fit <- lm(yhats_caret[[i]] ~ y_f4_test[[i]])
  rsquared_caret[i] <- summary(lm_fit)$r.squared
}

plot(unlist(yhats_caret) ~ unlist(y_f4_test),
     ylab = "predicted", xlab = "observed")

lm_fit_caret <- lm(unlist(yhats_caret) ~ unlist(y_f4_test))
summary(lm_fit_caret)$r.squared


varImp(fit_caret[[1]])

# get coefficients of variables for best model (1st fold of training data)
coef(fit_caret[[1]]$finalModel, s = fit_caret[[1]]$bestTune$lambda) # is nearly equivalent to glmnet model result

table(coef(fit_caret[[1]]$finalModel, s = fit_caret[[1]]$bestTune$lambda)[,1] != 0)
table(coef(fit_caret[[2]]$finalModel, s = fit_caret[[2]]$bestTune$lambda)[,1] != 0)

sel_var <- as.integer(names(which(coef(fit_caret[[1]]$finalModel, s = fit_caret[[1]]$bestTune$lambda)[,1] != 0)))
sel_var_names <- names_keep_int_c[sel_var[-1]]
View(cor_int_all_r[sel_var_names,])
View(cor_int_all_p[sel_var_names,])

hist(log10(cor_int_c$pval_adj[sel_var_names,]))
hist(log10(cor_int_c$pval_adj))

hist(cor_int_c$coeff[sel_var_names,])
hist(cor_int_c$coeff)
```


# Save workspace
```{r save workspace}
save.image("metabolite_arafield_model_lt50_acc.RData")
sessionInfo()
```


```{r}
# knit2html("scripts/metabolite_arafield4_models.Rmd", output = "scripts/metabolite_arafield4_models.html")
```

