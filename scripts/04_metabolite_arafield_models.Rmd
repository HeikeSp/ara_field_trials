---
title: "Modelling of metabolite data Arabidopsis field trials"
author: "Heike Sprenger"
date: "Monday, July 18, 2016"
output:
  html_document:
    highlight: tango
    number_section: yes
    theme: cerulean
    toc: yes
    toc_float: true
    toc_depth: 4
---

# Set working directory  
```{r set working directory}
#getwd()
#setwd("D:/work/repos/ara_field_trials/")
```

# Load workspace, packages and scripts
```{r load workspace, include=TRUE, message=FALSE}
# load packages
library(knitr)
library(pander)
library(ggplot2)
library(DAAG)
library(leaps)
library(faraway)
library(MASS)
library(glmnet)

# set options for knitr
opts_chunk$set(fig.width=10, fig.height=5)
opts_knit$set(root.dir = '../')

# load workspace
#load("metabolite_arafield_model.RData")
```


# Load data
Use changed metabolite data, from ``metabolite_arafield4_overview4.Rmd``
```{r load data}
metabolite_arafield2 <- read.table("output/metabolite_arafield2_modified.txt", header = TRUE, sep = "\t")
metabolite_arafield3 <- read.table("output/metabolite_arafield3_modified.txt", header = TRUE, sep = "\t")
metabolite_arafield4 <- read.table("output/metabolite_arafield4_modified.txt", header = TRUE, sep = "\t")

lt50 <- read.table("data/LT50.txt", header = TRUE, sep = "\t")
dim(lt50) 
# 58 accessions (= 52 accessions for training + 6 for testing)
pander(head(lt50))

yCapacity4full <- metabolite_arafield4$LT50ACC - metabolite_arafield4$LT50NAC 
yCapacity <- lt50$LT50ACC - lt50$LT50NAC

lt50_66acc <- read.table("data/LT50_66acc.txt", header = TRUE, sep = "\t")
dim(lt50_66acc)
# 64 accessions (= 52 accessions for training + 12 for testing)
table(lt50_66acc$Model)
setdiff(lt50_66acc$Accession, lt50$Accession)
# "Ei-2"     "Petergof" "Bu-2"     "Est-1"    "Sorbo"    "Ost-0" 

setdiff(lt50_66acc$Accession, metabolite_arafield4$accession) # Ws missing in Field 4
setdiff(lt50_66acc$Accession, metabolite_arafield3$accession)
setdiff(lt50_66acc$Accession, metabolite_arafield2$accession)
setdiff(metabolite_arafield4$accession, lt50_66acc$Accession)
setdiff(metabolite_arafield3$accession, lt50_66acc$Accession)
setdiff(metabolite_arafield2$accession, lt50_66acc$Accession)

length(unique(metabolite_arafield2$accession))
length(unique(metabolite_arafield3$accession))
length(unique(metabolite_arafield4$accession))
```

## set factor levels correctly
```{r set factor levels correctly}
# antho score (en)
metabolite_arafield2$antho_value_en <- factor(metabolite_arafield2$antho_value_en, levels = c("very low", "low", "intermediate", "high", "very high"))
metabolite_arafield3$antho_value_en <- factor(metabolite_arafield3$antho_value_en, levels = c("low", "intermediate", "high", "very high"))
metabolite_arafield4$antho_value_en <- factor(metabolite_arafield4$antho_value_en, levels = c("very low", "low", "intermediate", "high", "very high"))

# bbch categories
metabolite_arafield2$bbch_categories <- factor(metabolite_arafield2$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))
metabolite_arafield3$bbch_categories <- factor(metabolite_arafield3$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))
metabolite_arafield4$bbch_categories <- factor(metabolite_arafield4$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))

# flowering state
metabolite_arafield2$flowering_state <- factor(metabolite_arafield2$flowering_state, levels = c("non-flowering", "flowering"))
metabolite_arafield3$flowering_state <- factor(metabolite_arafield3$flowering_state, levels = c("non-flowering", "flowering"))
metabolite_arafield4$flowering_state <- factor(metabolite_arafield4$flowering_state, levels = c("non-flowering", "flowering"))

# vegetative state
metabolite_arafield2$vegetative_state <- factor(metabolite_arafield2$vegetative_state, levels = c("vegetative", "non-vegetative"))
metabolite_arafield3$vegetative_state <- factor(metabolite_arafield3$vegetative_state, levels = c("vegetative", "non-vegetative"))
metabolite_arafield4$vegetative_state <- factor(metabolite_arafield4$vegetative_state, levels = c("vegetative", "non-vegetative"))
```


# Exclude NAs for LT50 and anthoscore
```{r exclude NAs for LT50 and anthoscore}
accessions_training <- as.character(lt50_66acc$Accession[which(lt50_66acc$Model == "train")])
accessions_testing <- as.character(lt50_66acc$Accession[which(lt50_66acc$Model == "test")])

# Tsu, SampleID: 837060 --> missing values for BBCH and antho_score! --> remove?

idx_train4 <- which(metabolite_arafield4$accession %in% accessions_training)
metabolite_arafield4_part <- metabolite_arafield4[idx_train4,]
metabolite_arafield4_part <- metabolite_arafield4_part[which(!is.na(metabolite_arafield4_part$anthoscore) ), ]

yLT50ACC4 <- metabolite_arafield4_part$LT50ACC
yLT50NAC4 <- metabolite_arafield4_part$LT50NAC
yCapacity4 <- yLT50ACC4 - yLT50NAC4

length(unique(metabolite_arafield4_part$accession))
#colnames(metabolite_arafield4_part)
```


# dataset with outliers without NAs for LT50
- using NORMALIZED BBCH!
```{r dataset with outliers without NAs for LT50}
# cat_bbch_id4 <- metabolite_arafield4_part$bbch_categories # vegetative, Bluetenanlage oder Bluete

# Dataframe for regression model of LT50ACC
arafield4_regressiondata_norm <- data.frame(accession = metabolite_arafield4_part$accession, 
                                       plant_name = metabolite_arafield4_part$plant_name,
                                       yLT50ACC = metabolite_arafield4_part$LT50ACC, 
                                       yLT50NAC = metabolite_arafield4_part$LT50NAC, 
                                       glc = metabolite_arafield4_part$glucose_positive,
                                       frc = metabolite_arafield4_part$fructose_positive, 
                                       suc = metabolite_arafield4_part$sucrose_positive, 
                                       raf = metabolite_arafield4_part$raffinose_positive, 
                                       aa = metabolite_arafield4_part$amino_acids_positive, 
                                       mal = metabolite_arafield4_part$malate_positive, 
                                       fum = metabolite_arafield4_part$fumarate_positive, 
                                       pro = metabolite_arafield4_part$proline_positive, 
                                       antho = metabolite_arafield4_part$anthocyanin_positive, 
                                       norm_bbch = metabolite_arafield4_part$norm_bbch_id, 
                                       anthoscore = metabolite_arafield4_part$anthoscore)

pander(head(arafield4_regressiondata_norm))

write.table(arafield4_regressiondata_norm, "output/metabolite_arafield4_regressiondata_norm.txt", sep="\t")
```


## first linear regression model without changes
* Unterschied zwischen anova- und summary-Signifikanzen: erstere geben an, ob ein Effekt signifikant zur Erklaerung der Gesamtvarianz beitraegt.
* zweitere ist "nur" ein Test, ob die Steigung signifikant unterschiedlich von null ist
```{r first linear regression model without changes}
arafield4_regressionACC_norm <- lm(yLT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                antho + norm_bbch + anthoscore, data = arafield4_regressiondata_norm)
summary(arafield4_regressionACC_norm)$r.squared
# Multiple R-squared: 0.371    
summary(arafield4_regressionACC_norm)$adj.r.squared
# Adjusted R-squared: 0.2997

anova(arafield4_regressionACC_norm)
summary(arafield4_regressionACC_norm)


# use factor for antho_score and norm_bbch
arafield4_regressionACC_norm_factor <- lm(yLT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                antho + factor(norm_bbch) + factor(anthoscore), data = arafield4_regressiondata_norm)
summary(arafield4_regressionACC_norm_factor)$r.squared
# Multiple R-squared: 0.438 
summary(arafield4_regressionACC_norm_factor)$adj.r.squared
# Adjusted R-squared: 0.303
```

## cross-validation
```{r cross-validation}
arafield4_DAAGdata_norm <- arafield4_regressiondata_norm[,c(3:15)]

# 5-fold cross-validation
CVlm(data = arafield4_DAAGdata_norm, arafield4_regressionACC_norm, m=5)
# Overall ms 
#       2.86
```


## Leave-One-Out-cross-validation (LOO-CV)
```{r Leave-One-Out-cross-validation (LOO-CV), warning=FALSE, message=FALSE}
out_norm <- CVlm(data = arafield4_DAAGdata_norm, arafield4_regressionACC_norm, m=109, printit = FALSE)
attr(out_norm, "ms")
# Overall ms: 2.55
```


## Prediction of LT50ACC with model (for accessions that are included in the model = training data)
```{r prediction of LT50ACC with model}
cor(arafield4_regressionACC_norm$fitted.values, yLT50ACC4)
#0.609 bzw. R2 = 0.371

plot(yLT50ACC4, arafield4_regressionACC_norm$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(arafield4_regressionACC_norm$fitted.values ~ yLT50ACC4))
lm(arafield4_regressionACC_norm$fitted.values ~ yLT50ACC4)
```


# dataset with ORIGINAL BBCH
```{r dataset with ORIGINAL BBCH}
# Dataframe for regression model of LT50ACC
arafield4_regressiondata <- data.frame(accession = metabolite_arafield4_part$accession, 
                                       plant_name = metabolite_arafield4_part$plant_name,
                                       yLT50ACC = metabolite_arafield4_part$LT50ACC, 
                                       yLT50NAC = metabolite_arafield4_part$LT50NAC, 
                                       glc = metabolite_arafield4_part$glucose_positive,
                                       frc = metabolite_arafield4_part$fructose_positive, 
                                       suc = metabolite_arafield4_part$sucrose_positive, 
                                       raf = metabolite_arafield4_part$raffinose_positive, 
                                       aa = metabolite_arafield4_part$amino_acids_positive, 
                                       mal = metabolite_arafield4_part$malate_positive, 
                                       fum = metabolite_arafield4_part$fumarate_positive, 
                                       pro = metabolite_arafield4_part$proline_positive, 
                                       antho = metabolite_arafield4_part$anthocyanin_positive, 
                                       bbch = metabolite_arafield4_part$bbch_id, 
                                       anthoscore = metabolite_arafield4_part$anthoscore)

pander(head(arafield4_regressiondata))

write.table(arafield4_regressiondata, "output/metabolite_arafield4_regressiondata.txt", sep="\t")
```


## first linear regression model with ORIGINAL BBCH
* Unterschied zwischen anova- und summary-Signifikanzen: erstere geben an, ob ein Effekt signifikant zur Erklaerung der Gesamtvarianz beitraegt.
* zweitere ist "nur" ein Test, ob die Steigung signifikant unterschiedlich von null ist
```{r first linear regression model with ORIGINAL BBCH}
arafield4_regressionACC <- lm(yLT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                antho + bbch + anthoscore, data = arafield4_regressiondata)
summary(arafield4_regressionACC)$r.squared
# Multiple R-squared: 0.411    
summary(arafield4_regressionACC)$adj.r.squared
# Adjusted R-squared: 0.344

anova(arafield4_regressionACC)
summary(arafield4_regressionACC)


arafield4_regressionACC_factor <- lm(yLT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                     antho + factor(bbch) + factor(anthoscore), data=arafield4_regressiondata)
summary(arafield4_regressionACC_factor)
anova(arafield4_regressionACC_factor)
# Multiple R-squared:  0.438,	Adjusted R-squared:  0.303 
```

## cross-validation
```{r cross-validation with original BBCH}
arafield4_DAAGdata <- arafield4_regressiondata[,c(3:15)]

# 5-fold cross-validation
CVlm(data = arafield4_DAAGdata, arafield4_regressionACC, m=5)
# Overall ms 
#       2.63
```

## Leave-One-Out-cross-validation (LOO-CV)
```{r Leave-One-Out-cross-validation (LOO-CV) with ORIGINAL BBCH, warning=FALSE, message=FALSE}
out <- CVlm(data = arafield4_DAAGdata, arafield4_regressionACC, m=109, printit = FALSE)
attr(out, "ms")
# Overall ms: 2.38
```


## Prediction of LT50ACC with model (for accessions that are included in the model = training data)
```{r prediction of LT50ACC using model with ORIGINAL BBCH}
cor.test(arafield4_regressionACC$fitted.values, yLT50ACC4)
# R = 0.641 bzw. R2 = 0.411

plot(yLT50ACC4, arafield4_regressionACC$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(arafield4_regressionACC$fitted.values ~ yLT50ACC4))
lm(arafield4_regressionACC$fitted.values ~ yLT50ACC4)
```


# Definition of test data
```{r definition of test data}
# Test-Datensatz mit Akzessionen bekannter LT50-Werte (nicht im Modell enthalten)
idx_test4 <- which(metabolite_arafield4$accession %in% accessions_testing)
metabolite_arafield4_prediction <- metabolite_arafield4[idx_test4,]

# Dataframe mit Spalten fuer Vorhersage des LT50-Wertes (ACC)
arafield4_predictiondata_norm <- data.frame(acc = metabolite_arafield4_prediction$accession, 
                                       plant_name = metabolite_arafield4_prediction$plant_name,
                                       glc = metabolite_arafield4_prediction$glucose_positive, 
                                       frc = metabolite_arafield4_prediction$fructose_positive, 
                                       suc = metabolite_arafield4_prediction$sucrose_positive,
                                       raf = metabolite_arafield4_prediction$raffinose_positive, 
                                       aa = metabolite_arafield4_prediction$amino_acids_positive, 
                                       mal = metabolite_arafield4_prediction$malate_positive,
                                       fum = metabolite_arafield4_prediction$fumarate_positive, 
                                       pro = metabolite_arafield4_prediction$proline_positive, 
                                       antho = metabolite_arafield4_prediction$anthocyanin_positive,
                                       norm_bbch = metabolite_arafield4_prediction$norm_bbch_id, 
                                       anthoscore = metabolite_arafield4_prediction$anthoscore)

write.table(arafield4_predictiondata_norm, file="output/metabolite_arafield4_predictiondata_norm.txt", sep="\t")

# WITH ORIGINAL BBCH
arafield4_predictiondata <- data.frame(acc = metabolite_arafield4_prediction$accession, 
                                       plant_name = metabolite_arafield4_prediction$plant_name,
                                       glc = metabolite_arafield4_prediction$glucose_positive, 
                                       frc = metabolite_arafield4_prediction$fructose_positive, 
                                       suc = metabolite_arafield4_prediction$sucrose_positive,
                                       raf = metabolite_arafield4_prediction$raffinose_positive, 
                                       aa = metabolite_arafield4_prediction$amino_acids_positive, 
                                       mal = metabolite_arafield4_prediction$malate_positive,
                                       fum = metabolite_arafield4_prediction$fumarate_positive, 
                                       pro = metabolite_arafield4_prediction$proline_positive, 
                                       antho = metabolite_arafield4_prediction$anthocyanin_positive,
                                       bbch = metabolite_arafield4_prediction$bbch_id, 
                                       anthoscore = metabolite_arafield4_prediction$anthoscore)

write.table(arafield4_predictiondata, file="output/metabolite_arafield4_predictiondata.txt", sep="\t")
```



## Prediction of LT50ACC test data
```{r prediction of LT50ACC for test data}
# Vorhersage der LT50-Werte fuer ausgewaehlte Akzessionen mit Hilfe des berechneten Regressionsmodells
arafield4_predictionACC_norm <- predict(arafield4_regressionACC_norm, arafield4_predictiondata_norm)
arafield4_predictionACC_norm_factor <- predict(arafield4_regressionACC_norm_factor, arafield4_predictiondata_norm)
arafield4_predictionACC <- predict(arafield4_regressionACC, arafield4_predictiondata)
arafield4_predictionACC_factor <- predict(arafield4_regressionACC_factor, arafield4_predictiondata)

plot(arafield4_predictionACC, arafield4_predictionACC_norm)
plot(arafield4_predictionACC, arafield4_predictionACC_factor)

# mehr zum Thema Vorhersage und Konfidenz-Intervalle im Kapitel 3 im Buch Regression, Seite 123

# Vorhersage mit 95%-Vorhersageintervall
head(predict(arafield4_regressionACC, arafield4_predictiondata, interval="prediction"))

# Vorhersage mit 95%-Konfidenzintervall
head(predict(arafield4_regressionACC, arafield4_predictiondata, interval="confidence"))

measuredLT50ACC <- metabolite_arafield4_prediction$LT50ACC

arafield4_predictionACCtable <- data.frame(arafield4_predictiondata,
                                           arafield4_predictionACC, 
                                           measuredLT50ACC)[,c(1,14,15)]

arafield4_predictionACCtable_norm <- data.frame(arafield4_predictiondata,
                                                arafield4_predictionACC_norm, 
                                                measuredLT50ACC)[,c(1,14,15)]

head(arafield4_predictionACCtable)
head(arafield4_predictionACCtable_norm)

write.table(arafield4_predictionACCtable, "output/arafield4_predictionACC.txt", sep="\t")
write.table(arafield4_predictionACCtable_norm, "output/arafield4_predictionACC_norm.txt", sep="\t")

sum(((arafield4_predictionACC)-(measuredLT50ACC))^2)
# 81.7
sum(((arafield4_predictionACC_norm)-(measuredLT50ACC))^2)
# 95.9
sum(((arafield4_predictionACC_factor)-(measuredLT50ACC))^2)
# 85.8

sum(((arafield4_predictionACC)-(measuredLT50ACC))^2) / sum((measuredLT50ACC)^2)
# 0.0371
sum(((arafield4_predictionACC_norm)-(measuredLT50ACC))^2) / sum((measuredLT50ACC)^2)
# 0.0435

cor.test(measuredLT50ACC, arafield4_predictionACC_norm)
cor.test(measuredLT50ACC, arafield4_predictionACC_norm_factor)

plot(measuredLT50ACC, arafield4_predictionACC)
cor.test(measuredLT50ACC, arafield4_predictionACC)

plot(measuredLT50ACC, arafield4_predictionACC_factor)
cor.test(measuredLT50ACC, arafield4_predictionACC_factor)

par(mfrow=c(1,1))
barplot(t(as.matrix(arafield4_predictionACCtable[,2:3])), 
        beside=T, names.arg = arafield4_predictionACCtable$acc, las=2)

# Vorhersage ist ganz okay fuer 5 von 6 Akzessionen, aber die Vorhersage fuer Van-0 ist komplett verschieden
```

## Cp-plot
```{r Cp-plot}
################### Cp-Plot ####################
x <- as.matrix(arafield4_regressiondata[,c(5:15)]) # Create design matrix x
#colnames(x)=c("Glucose","Fructose","Saccharose","Raffinose","Aminosaeuren","Malat","Fumarat","Prolin","Anthocyane","BBCH (normalisiert)","Anthocyan-Gehalt (visuell)")
y <- arafield4_regressiondata$yLT50ACC # Create response vector y
leapsModels <- leaps(x, y, method="Cp", nbest=3, names=colnames(x))


pdf(file="figures/Metabolite_AraField4_CpPlot.pdf")
Cpplot(leapsModels)
dev.off()

adjr <- leaps(x, y, method="adjr2") # Check which model the adjusted R2 selects
maxadjr(adjr, 8)


# y <- arafield4_regressiondata$yLT50ACC[cooks.distance(arafield4_regressionACC)<0.2]
# x <- cbind(arafield4_regressiondata[,4:14])
# x_part <- x[cooks.distance(arafield4_regressionACC)<0.2,]
# a <- leaps(x_part, y)
# b <- leaps(x, y, method="adjr2")
```


# GLMNET --> LASSO
```{r glmnet --> lasso}
x <- as.matrix(arafield4_regressiondata[,5:15])
y <- arafield4_regressiondata$yLT50ACC

test_x <- as.matrix(arafield4_predictiondata[,3:13])
test_y <- measuredLT50ACC

set.seed(1)
arafield4_lasso_ACC <- glmnet(x,y)

# Cross-validation
set.seed(1)
arafield4_lasso_cv_ACC <- cv.glmnet(x, y)
plot(arafield4_lasso_cv_ACC)

# use no specific lambda
lasso_all_pred_test <- predict(arafield4_lasso_ACC, new = test_x)

# calculate mean error
lasso_all_pred_test_err <- apply( (lasso_all_pred_test - test_y)^2, 2, mean )
points(log(arafield4_lasso_ACC$lambda), lasso_all_pred_test_err, col="blue", pch="*")

# use optimal lamba value
lasso_all_pred_all_lambda <- predict(arafield4_lasso_cv_ACC, new = x, s="lambda.min")
lasso_all_pred_test_lambda <- predict(arafield4_lasso_cv_ACC, new = test_x, s="lambda.min")

# number of variables in model (for lambda.min)
which(arafield4_lasso_cv_ACC$lambda == arafield4_lasso_cv_ACC$lambda.min)
# 23
arafield4_lasso_cv_ACC$nzero[23]
# 4

# coefficients
arafield4_lasso_cv_ACC$glmnet.fit$beta[,"s22"]


# plot observed vs. predicted DRYM
plot(y, lasso_all_pred_all_lambda)
abline(0,1)
cor.test(y, lasso_all_pred_all_lambda)


lasso_all_pred_test_lambda_table <- data.frame(acc = arafield4_predictiondata$acc,
                                              measuredLT50ACC,
                                              lasso = lasso_all_pred_test_lambda, 
                                              regression = arafield4_predictionACC,
                                              regression_fac = arafield4_predictionACC_factor)


barplot(t(as.matrix(lasso_all_pred_test_lambda_table[,2:3])), 
        beside=T, names.arg = lasso_all_pred_test_lambda_table$acc, las=2)

barplot(t(as.matrix(lasso_all_pred_test_lambda_table[,2:4])), 
        beside=T, names.arg = lasso_all_pred_test_lambda_table$acc, las=2)

sum(((lasso_all_pred_test_lambda)-(measuredLT50ACC))^2)
# 61.8

sum(((lasso_all_pred_test_lambda)-(measuredLT50ACC))^2) / sum((measuredLT50ACC)^2)
# 0.028
```


## Prediction of LT50ACC with model (for accessions that are included in the model = training data)
```{r prediction of LT50ACC using model with ORIGINAL BBCH and LASSO}
cor.test(arafield4_regressionACC$fitted.values, yLT50ACC4)
# R = 0.641 bzw. R2 = 0.411
cor.test(lasso_all_pred_all_lambda, yLT50ACC4)
# R = 0.609

par(mfrow=c(1,2))

plot(yLT50ACC4, arafield4_regressionACC$fitted.values, main = "regression",
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(arafield4_regressionACC$fitted.values ~ yLT50ACC4))
lm(arafield4_regressionACC$fitted.values ~ yLT50ACC4)

plot(yLT50ACC4, lasso_all_pred_all_lambda, main = "lasso",
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(lasso_all_pred_all_lambda ~ yLT50ACC4))
lm(lasso_all_pred_all_lambda ~ yLT50ACC4)
```



```{r compare different models}
range(test_y)
lim_values <- c(-11.6, -5.5)

pdf("figures/compare_model_validation.pdf", 8, 8)
par(mfrow=c(2,2))

plot(test_y, lasso_all_pred_test_lambda, col = "white",
     main = "lasso model", xlim = lim_values, ylim = lim_values)
text(test_y, lasso_all_pred_test_lambda, metabolite_arafield4_prediction$accession)
text(-10,-6, "cor = 0.405", col="red")
abline(0,1, col="red")
cor.test(test_y, lasso_all_pred_test_lambda)

plot(test_y, arafield4_predictionACC, col = "white",
     main = "regression model", xlim = lim_values, ylim = lim_values)
text(test_y, arafield4_predictionACC, metabolite_arafield4_prediction$accession)
text(-10,-6, "cor = 0.267", col="red")
abline(0,1, col="red")
cor.test(test_y, arafield4_predictionACC)

plot(test_y, arafield4_predictionACC_factor, col = "white",
     main = "regression model (factor)", 
     xlim = lim_values, ylim = lim_values)
text(test_y, arafield4_predictionACC_factor, metabolite_arafield4_prediction$accession)
text(-10,-6, "cor = 0.246", col="red")
abline(0,1, col="red")
cor.test(test_y, arafield4_predictionACC_factor)

plot(test_y, arafield4_predictionACC_norm, col = "white",
     main = "regression model (norm BBCH)",
     xlim = lim_values, ylim = lim_values)
text(test_y, arafield4_predictionACC_norm, metabolite_arafield4_prediction$accession)
text(-10,-6, "cor = 0.152", col="red")
abline(0,1, col="red")
cor.test(test_y, arafield4_predictionACC_norm)

dev.off()
```







# mit den Variablen norm_bbch und anthoscore als FAKTOR!
```{r mit den Variablen norm_bbch und anthoscore als FAKTOR!}
class(arafield4_regressiondata$anthoscore)
#[1] "integer"
class(arafield4_regressiondata$norm_bbch)
#[1] "numeric"

arafield4_regressionACC_factor <- lm(yLT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                       antho + factor(norm_bbch) + factor(anthoscore), 
                                     data = arafield4_regressiondata)

anova(arafield4_regressionACC_factor)
# Analysis of Variance Table
# Response: yLT50ACC
#                    Df Sum Sq Mean Sq F value  Pr(>F)    
# glc                 1    4.6     4.6    1.99  0.1616    
# frc                 1   12.1    12.1    5.28  0.0240 *  
# suc                 1    0.7     0.7    0.30  0.5875    
# raf                 1   50.6    50.6   22.06 9.8e-06 ***
# aa                  1    0.3     0.3    0.13  0.7235    
# mal                 1    0.9     0.9    0.40  0.5294    
# fum                 1   12.3    12.3    5.37  0.0228 *  
# pro                 1    2.9     2.9    1.28  0.2615    
# antho               1    2.9     2.9    1.27  0.2633    
# factor(norm_bbch)   8   62.7     7.8    3.42  0.0018 ** 
# factor(anthoscore)  4    5.7     1.4    0.62  0.6511    
# Residuals          87  199.4     2.3                    
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# Summe der quadratischen Differenzen zwischen Mess- und Vorhersagewert
sum(((predict(arafield4_regressionACC_factor, arafield4_predictiondata)) - (measuredLT50ACC))^2) / sum((measuredLT50ACC)^2)
# 0.0765
sum(((predict(arafield4_regressionACC_factor, arafield4_predictiondata)) - (measuredLT50ACC))^2) 
# 82.1

summary(arafield4_regressionACC_factor)
# Call:
# lm(formula = yLT50ACC ~ glc + frc + suc + raf + aa + mal + fum + 
#     pro + antho + factor(norm_bbch) + factor(anthoscore), data = arafield4_regressiondata)
# Residuals:
#    Min     1Q Median     3Q    Max 
# -2.665 -0.998  0.071  0.797  4.134 
# Coefficients:
#                                     Estimate Std. Error t value Pr(>|t|)    
# (Intercept)                         -9.99110    1.60841   -6.21  1.7e-08 ***
# glc                                 -0.02169    0.04157   -0.52   0.6032    
# frc                                  0.04060    0.05996    0.68   0.5001    
# suc                                  0.03818    0.03933    0.97   0.3344    
# raf                                 -1.00777    0.35211   -2.86   0.0053 ** 
# aa                                  -0.02485    0.05857   -0.42   0.6724    
# mal                                  0.00657    0.03141    0.21   0.8349    
# fum                                 -0.04687    0.04119   -1.14   0.2582    
# pro                                  2.68719    2.72350    0.99   0.3265    
# antho                                0.21042    0.16425    1.28   0.2036    
# factor(norm_bbch)-1.58181818181818   0.30542    1.30536    0.23   0.8156    
# factor(norm_bbch)-1.32727272727273   0.67885    1.20886    0.56   0.5759    
# factor(norm_bbch)-0.818181818181818  0.66149    1.15896    0.57   0.5696    
# factor(norm_bbch)0                   1.11134    1.16436    0.95   0.3425    
# factor(norm_bbch)0.627272727272727   1.84827    1.23223    1.50   0.1373    
# factor(norm_bbch)0.845454545454545   3.38409    1.38606    2.44   0.0167 *  
# factor(norm_bbch)1                   3.70639    1.32203    2.80   0.0062 ** 
# factor(norm_bbch)1.10909090909091    4.14217    2.09642    1.98   0.0513 .  
# factor(anthoscore)2                  0.33471    0.86713    0.39   0.7004    
# factor(anthoscore)3                  0.56982    0.88283    0.65   0.5203    
# factor(anthoscore)4                  0.34243    0.94492    0.36   0.7179    
# factor(anthoscore)5                 -0.36027    1.13801   -0.32   0.7523    
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
# 
# Residual standard error: 1.51 on 87 degrees of freedom
# Multiple R-squared:  0.438,  Adjusted R-squared:  0.303 
# F-statistic: 3.23 on 21 and 87 DF,  p-value: 6.42e-05
```


## Log transformation
```{r log transformation}
# Speichern der gemessenen Werte in Vektor und log-Transformation
measuredLT50ACC <- c( -5.706,  -5.706, -9.132, -9.132, -9.132, -9.132, -7.212, -7.212, -10.78, -10.78, -11.14, -11.14, -6.726, -6.726)
measuredLT50ACClog <- log(abs(measuredLT50ACC))

# Modell mit logarithmierter Zielvariable yLT50
arafield4_regressionACClog <- lm(log(abs(yLT50ACC)) ~ glc + frc + suc + raf + aa + mal + fum + 
                                   pro + antho + norm_bbch + anthoscore, data = arafield4_regressiondata)
arafield4_predictionACClog <- predict(arafield4_regressionACClog, arafield4_predictiondata)

cbind(arafield4_predictiondata,arafield4_predictionACClog, measuredLT50ACClog)[,c(1,14,15)]
#          acc arafield4_predictionACClog measuredLT50ACClog
# 1       Be-0                       2.06               1.74
# 2       Be-0                       2.03               1.74
# 3   Bsch-2.2                       2.29               2.21
# 4   Bsch-2.2                       2.40               2.21
# 5  Bsch-2.78                       2.17               2.21
# 6  Bsch-2.78                       2.30               2.21
# 7       Je54                       2.22               1.98
# 8       Je54                       2.31               1.98
# 9      RRS-7                       1.93               2.38
# 10     RRS-7                       2.31               2.38
# 11      Ty-0                       2.21               2.41
# 12      Ty-0                       2.30               2.41
# 13     Van-0                       2.47               1.91
# 14     Van-0                       2.44               1.91

cbind(exp(arafield4_predictionACClog),exp(measuredLT50ACClog))
#     [,1]  [,2]
# 1   7.88  5.71
# 2   7.60  5.71
# 3   9.88  9.13
# 4  11.08  9.13
# 5   8.75  9.13
# 6   9.97  9.13
# 7   9.24  7.21
# 8  10.08  7.21
# 9   6.87 10.78
# 10 10.11 10.78
# 11  9.09 11.14
# 12  9.93 11.14
# 13 11.84  6.73
# 14 11.46  6.73

# Summe der quadratischen Differenzen zwischen Mess- und Vorhersagewert
sum(((exp(arafield4_predictionACClog)) - (exp(measuredLT50ACClog)))^2) / sum((measuredLT50ACC)^2)
# 0.0893
sum(((exp(arafield4_predictionACClog)) - (exp(measuredLT50ACClog)))^2)
# 95.9
```


## variable selection

### forward selection
```{r forward selection}
# Create initial NULL model
arafield4_regressionACC_null <- lm(yLT50ACC~1, data=arafield4_regressiondata)

# Choose a model by AIC in a Stepwise Algorithm
# Forward
arafield4_regressionACC_fw <- step(arafield4_regressionACC_null, 
                                   scope=formula(arafield4_regressionACC), 
                                   direction="forward")

# Step:  AIC=92.9
# yLT50ACC ~ norm_bbch + raf + fum + suc
#              Df Sum of Sq RSS  AIC
# <none>                    233 92.9
# + glc         1     2.340 231 93.8
# + pro         1     2.281 231 93.8
# + frc         1     2.266 231 93.8
# + anthoscore  1     1.144 232 94.4
# + antho       1     0.510 233 94.7
# + aa          1     0.101 233 94.9
# + mal         1     0.006 233 94.9

summary(arafield4_regressionACC_fw)
# Residual standard error: 1.5 on 104 degrees of freedom
# Multiple R-squared:  0.343,  Adjusted R-squared:  0.318 
# F-statistic: 13.6 on 4 and 104 DF,  p-value: 6.15e-09

# Vorhersage-Werte fuer Oekotypen, die nicht im Modell sind
predict(arafield4_regressionACC_fw, arafield4_predictiondata)

# Summe der quadratischen Differenzen zwischen Mess- und Vorhersagewert 
sum(((predict(arafield4_regressionACC_fw, arafield4_predictiondata)) - (measuredLT50ACC))^2)
# 89.5
sum(((predict(arafield4_regressionACC_fw, arafield4_predictiondata)) - (measuredLT50ACC))^2)/ sum((measuredLT50ACC)^2)
# 0.0834
```


### stepAIC
#### default direction (if missing): backward!!!
```{r selection in both directions}
############  SELECTION in BOTH DIRECTIONS ###################
# Without FACTOR!
step(arafield4_regressionACC_null, 
     scope=formula(arafield4_regressionACC), 
     direction="both")
# Step:  AIC=92.9
# yLT50ACC ~ norm_bbch + raf + fum + suc
# Call:
# lm(formula = yLT50ACC ~ norm_bbch + raf + fum + suc, data = arafield4_regressiondata)
# Coefficients:
# (Intercept)    norm_bbch          raf          fum          suc  
#     -7.2765       1.0280      -0.9556      -0.0720       0.0542  

# das selbe Modell wie bei forward selection

# Both directions, starting from Null model (FACTOR!)
arafield4_regressionACC_factorAIC <- step(arafield4_regressionACC_null, 
                                          scope=formula(arafield4_regressionACC_factor), 
                                          direction="both")

# Summe der quadratischen Differenzen zwischen Mess- und Vorhersagewert
sum(((predict(arafield4_regressionACC_factorAIC, arafield4_predictiondata)) - (measuredLT50ACC))^2) / sum((measuredLT50ACC)^2)
# 0.069
sum(((predict(arafield4_regressionACC_factorAIC, arafield4_predictiondata)) - (measuredLT50ACC))^2)
# 74.1

# bind predicted and measured LT50ACC for accessions of test set
cbind(arafield4_predictiondata, 
      predictedLT50ACC = predict(arafield4_regressionACC_factorAIC, arafield4_predictiondata), 
      measuredLT50ACC)[,c(1,14,15)]
#          acc predictedLT50ACC measuredLT50ACC
# 1       Be-0            -7.25           -5.71
# 2       Be-0            -8.20           -5.71
# 3   Bsch-2.2            -9.98           -9.13
# 4   Bsch-2.2           -10.94           -9.13
# 5  Bsch-2.78            -9.37           -9.13
# 6  Bsch-2.78           -10.18           -9.13
# 7       Je54            -9.26           -7.21
# 8       Je54           -10.43           -7.21
# 9      RRS-7            -8.53          -10.78
# 10     RRS-7            -9.98          -10.78
# 11      Ty-0            -9.63          -11.14
# 12      Ty-0           -10.09          -11.14
# 13     Van-0           -11.14           -6.73
# 14     Van-0           -10.88           -6.73
```


### stepAIC default
#### default direction (if missing): backward!!!
```{r stepAIC default}
arafield4_stepAIC_ACC <- stepAIC(arafield4_regressionACC)

arafield4_stepAIC_ACC$coefficients
# (Intercept)         frc         raf         fum         pro   norm_bbch 
#     -7.5118      0.0558     -0.8974     -0.0873      2.7659      0.9638 

# predited values for accessions that are included in the null model (training data)
arafield4_stepAIC_ACC$fitted.values

# predited values for accessions that are NOT included in the null model (test data)
arafield4_prediction_stepAIC_ACC <- predict(arafield4_stepAIC_ACC, arafield4_predictiondata)
 
cbind(arafield4_predictiondata, 
      arafield4_prediction_stepAIC_ACC, 
      measuredLT50ACC)[,c(1,14,15)]
#          acc arafield4_prediction_stepAIC_ACC measuredLT50ACC
# 1       Be-0                            -8.21           -5.71
# 2       Be-0                            -8.04           -5.71
# 3   Bsch-2.2                            -9.82           -9.13
# 4   Bsch-2.2                           -10.56           -9.13
# 5  Bsch-2.78                            -8.84           -9.13
# 6  Bsch-2.78                            -9.57           -9.13
# 7       Je54                            -9.13           -7.21
# 8       Je54                           -10.25           -7.21
# 9      RRS-7                            -6.63          -10.78
# 10     RRS-7                           -10.43          -10.78
# 11      Ty-0                            -9.08          -11.14
# 12      Ty-0                            -9.85          -11.14
# 13     Van-0                           -11.15           -6.73
# 14     Van-0                           -10.99           -6.73

# Summe der quadratischen Differenzen zwischen Mess- und Vorhersagewert
sum(((arafield4_prediction_stepAIC_ACC) - (measuredLT50ACC))^2)
# 88.4
sum(((arafield4_prediction_stepAIC_ACC) - (measuredLT50ACC))^2)/ sum((measuredLT50ACC)^2)
# 0.0823
```


### comparison of two models --> ANOVA
```{r comparison of two models}
# anova(arafield4_regressionACC, arafield4_stepAIC_ACC)
# Analysis of Variance Table
# 
# Model 1: yLT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + antho + 
#     norm_bbch + anthoscore
# Model 2: yLT50ACC ~ frc + raf + fum + pro + norm_bbch
#   Res.Df RSS Df Sum of Sq    F Pr(>F)
# 1     97 223                         
# 2    103 230 -6     -6.28 0.45   0.84

# p-value > 0.05, also Annahme von H0, dass beide Modelle aehnlich
```


### backward selection
```{r backward selection}
step(arafield4_regressionACC, scope=formula(arafield4_regressionACC), direction="backward")
# fuehrt zum gleichen Ergebnis wir stepAIC, da bei step auch der AIC-Wert minimiert wird (backward)

```


### add quadratic term for norm_bbch
#### increases R2 from 0.34 to 0.37
```{r add quadratic term for norm_bbch}
summary(lm(yLT50ACC ~ frc + raf + fum + poly(norm_bbch,2), data = arafield4_regressiondata))
# Call:
# lm(formula = yLT50ACC ~ frc + raf + fum + poly(norm_bbch, 2), 
#     data = arafield4_regressiondata)
# Residuals:
#    Min     1Q Median     3Q    Max 
# -3.154 -1.004  0.135  0.930  4.021 
# Coefficients:
#                     Estimate Std. Error t value Pr(>|t|)    
# (Intercept)          -7.6495     0.5646  -13.55  < 2e-16 ***
# frc                   0.0447     0.0346    1.29    0.199    
# raf                  -0.7717     0.2287   -3.37    0.001 ** 
# fum                  -0.0658     0.0339   -1.94    0.055 .  
# poly(norm_bbch, 2)1   8.2905     1.4813    5.60  1.8e-07 ***
# poly(norm_bbch, 2)2   3.5948     1.5641    2.30    0.024 *  
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
# Residual standard error: 1.47 on 103 degrees of freedom
# Multiple R-squared:  0.372,  Adjusted R-squared:  0.342 
# F-statistic: 12.2 on 5 and 103 DF,  p-value: 2.62e-09


testlm2 <- lm(I(1/yLT50ACC) ~ frc + raf + fum + poly(norm_bbch,2), data = arafield4_regressiondata)
summary(lm(I(1/yLT50ACC) ~ frc + raf + fum + poly(norm_bbch,2), data = arafield4_regressiondata))
```


### regression model for LT50NAC
```{r regression model for LT50NAC}
############## Regressionsmodell fuer LT50NAC #######################
arafield4_regressionNAC <- lm(yLT50NAC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                antho + norm_bbch + anthoscore, data = arafield4_regressiondata)

summary(arafield4_regressionNAC)
# Call:
# lm(formula = yLT50NAC ~ glc + frc + suc + raf + aa + mal + fum + 
#     pro + antho + norm_bbch + anthoscore, data = arafield4_regressiondata)
# 
# Residuals:
#     Min      1Q  Median      3Q     Max 
# -1.8135 -0.4997  0.0778  0.4670  1.9091 
# 
# Coefficients:
#             Estimate Std. Error t value Pr(>|t|)    
# (Intercept) -5.33125    0.56514   -9.43  2.2e-15 ***
# glc          0.02267    0.01850    1.23    0.223    
# frc         -0.00334    0.02881   -0.12    0.908    
# suc          0.00742    0.01887    0.39    0.695    
# raf         -0.33558    0.16354   -2.05    0.043 *  
# aa          -0.01578    0.02878   -0.55    0.585    
# mal         -0.00922    0.01573   -0.59    0.559    
# fum         -0.00404    0.02009   -0.20    0.841    
# pro          1.42423    1.29303    1.10    0.273    
# antho        0.15910    0.08030    1.98    0.050 .  
# norm_bbch    0.26992    0.11543    2.34    0.021 *  
# anthoscore  -0.16358    0.11168   -1.46    0.146    
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
# 
# Residual standard error: 0.783 on 97 degrees of freedom
# Multiple R-squared:  0.212,  Adjusted R-squared:  0.122 
# F-statistic: 2.37 on 11 and 97 DF,  p-value: 0.0122

# Vorhersage der LT50-Werte mit Hilfe des Modells (fuer Oekotypen, die im Modell enthalten sind)
arafield4_regressionNAC$fitted.values

cor(yLT50NAC4,arafield4_regressionNAC$fitted.values)
# 0.46 bzw. R2 = 0.22
```


### prediction of LT50NAC for test data
```{r prediction of LT50NAC for test data}
arafield4_predictionNAC <- predict(arafield4_regressionNAC, arafield4_predictiondata)

measuredLT50NAC <- c(-4.633, -4.633, -5.431, -5.431, -5.431, -5.431, -5.28, -5.28, 
                     -5.979, -5.979, -5.592, 5-.592, -5.144, -5.144)

cbind(arafield4_predictiondata, arafield4_predictionNAC, measuredLT50NAC)[,c(1,14,15)]
#          acc arafield4_predictionNAC measuredLT50NAC
# 1       Be-0                   -5.41           -4.63
# 2       Be-0                   -5.38           -4.63
# 3   Bsch-2.2                   -5.85           -5.43
# 4   Bsch-2.2                   -6.15           -5.43
# 5  Bsch-2.78                   -5.74           -5.43
# 6  Bsch-2.78                   -6.10           -5.43
# 7       Je54                   -5.81           -5.28
# 8       Je54                   -5.63           -5.28
# 9      RRS-7                   -5.26           -5.98
# 10     RRS-7                   -5.90           -5.98
# 11      Ty-0                   -5.87           -5.59
# 12      Ty-0                   -6.45            4.41
# 13     Van-0                   -6.49           -5.14
# 14     Van-0                   -6.49           -5.14
```


### stepAIC for LT50NAC
```{r stepAIC for LT50NAC}
arafield4_stepAIC_NAC <- stepAIC(arafield4_regressionNAC)

summary(arafield4_stepAIC_NAC)
# Residual standard error: 0.767 on 103 degrees of freedom
# Multiple R-squared:  0.196,  Adjusted R-squared:  0.157 
# F-statistic: 5.03 on 5 and 103 DF,  p-value: 0.000368

# fuer Oekotypen, die im Modell sind
predictedLT50NAC4_stepAIC <- arafield4_stepAIC_NAC$coefficients[1] + 
  arafield4_regressiondata$glc*arafield4_stepAIC_NAC$coefficients[2] +
  arafield4_regressiondata$raf*arafield4_stepAIC_NAC$coefficients[3] + 
  arafield4_regressiondata$antho*arafield4_stepAIC_NAC$coefficients[4] +
  arafield4_regressiondata$norm_bbch*arafield4_stepAIC_NAC$coefficients[5] + 
  arafield4_regressiondata$anthoscore*arafield4_stepAIC_NAC$coefficients[6]

# entspricht
arafield4_stepAIC_NAC$fitted.values

# fuer Oekotypen, die nicht im Modell sind
arafield4_prediction_stepAIC_NAC <- predict(arafield4_stepAIC_NAC, arafield4_predictiondata)

cbind(arafield4_predictiondata, 
      arafield4_prediction_stepAIC_NAC,
      measuredLT50NAC)[,c(1,14,15)]
#          acc arafield4_prediction_stepAIC_NAC measuredLT50NAC
# 1       Be-0                            -5.43           -4.63
# 2       Be-0                            -5.32           -4.63
# 3   Bsch-2.2                            -5.88           -5.43
# 4   Bsch-2.2                            -6.04           -5.43
# 5  Bsch-2.78                            -5.61           -5.43
# 6  Bsch-2.78                            -6.01           -5.43
# 7       Je54                            -5.94           -5.28
# 8       Je54                            -5.66           -5.28
# 9      RRS-7                            -5.55           -5.98
# 10     RRS-7                            -5.83           -5.98
# 11      Ty-0                            -5.88           -5.59
# 12      Ty-0                            -6.40            4.41
# 13     Van-0                            -6.56           -5.14
# 14     Van-0                            -6.39           -5.14
```


### regression model for acclimation capacity
```{r regression model for acclimation capacity}
# yCapacity4

arafield4_regressionCap <- lm(yCapacity4 ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                antho + norm_bbch + anthoscore, data = arafield4_regressiondata)

summary(arafield4_regressionCap)
# Call:
# lm(formula = yCapacity4 ~ glc + frc + suc + raf + aa + mal + 
#     fum + pro + antho + norm_bbch + anthoscore, data = arafield4_regressiondata)
# Residuals:
#     Min      1Q  Median      3Q     Max 
# -2.6966 -0.5716  0.0427  0.6911  2.7839 
# Coefficients:
#             Estimate Std. Error t value Pr(>|t|)    
# (Intercept)  -1.6892     0.8248   -2.05  0.04327 *  
# glc          -0.0137     0.0270   -0.51  0.61409    
# frc           0.0402     0.0421    0.96  0.34129    
# suc           0.0252     0.0275    0.92  0.36155    
# raf          -0.8114     0.2387   -3.40  0.00098 ***
# aa           -0.0217     0.0420   -0.52  0.60589    
# mal           0.0127     0.0230    0.55  0.58046    
# fum          -0.0615     0.0293   -2.10  0.03857 *  
# pro           1.0586     1.8872    0.56  0.57613    
# antho         0.0163     0.1172    0.14  0.88965    
# norm_bbch     0.6915     0.1685    4.10  8.4e-05 ***
# anthoscore   -0.0693     0.1630   -0.43  0.67168    
# ---
# Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
# Residual standard error: 1.14 on 97 degrees of freedom
# Multiple R-squared:  0.346,  Adjusted R-squared:  0.272 
# F-statistic: 4.67 on 11 and 97 DF,  p-value: 1.05e-05

# Vorhersage der Kapazitaet mit Hilfe des Modells (fuer Oekotypen, die im Modell enthalten sind)
arafield4_regressionCap$fitted.values

cor(yCapacity4,arafield4_regressionCap$fitted.values)
# 0.589 bzw. R2 = 0.347
```


### prediction of capacity for test data
```{r prediction of capacity for test data}
# Vorhersage der LT50-Werte fuer ausgewaehlte Akzessionen mit Hilfe des berechneten Regressionsmodells

arafield4_predictionCap <- predict(arafield4_regressionCap, arafield4_predictiondata)

measuredCap <- measuredLT50ACC - measuredLT50NAC

cbind(arafield4_predictiondata, arafield4_predictionCap, measuredCap)[,c(1,14,15)]
```


### stepAIC for Capacity
```{r stepAIC for Capacity}
arafield4_stepAIC_Cap <- stepAIC(arafield4_regressionCap)

summary(arafield4_stepAIC_Cap)
# Residual standard error: 1.11 on 104 degrees of freedom
# Multiple R-squared:  0.334,  Adjusted R-squared:  0.308 
# F-statistic:   13 on 4 and 104 DF,  p-value: 1.25e-08

# fuer Oekotypen, die im Modell sind
arafield4_stepAIC_Cap$fitted.values

# fuer Oekotypen, die nicht im Modell sind
arafield4_prediction_stepAIC_Cap <- predict(arafield4_stepAIC_Cap, arafield4_predictiondata)

cbind(arafield4_predictiondata, 
      arafield4_prediction_stepAIC_Cap,
      measuredCap)[,c(1,14,15)]
#          acc arafield4_prediction_stepAIC_Cap measuredCap
# 1       Be-0                            -2.71       -1.07
# 2       Be-0                            -2.36       -1.07
# 3   Bsch-2.2                            -3.93       -3.70
# 4   Bsch-2.2                            -4.92       -3.70
# 5  Bsch-2.78                            -3.22       -3.70
# 6  Bsch-2.78                            -4.05       -3.70
# 7       Je54                            -3.51       -1.93
# 8       Je54                            -4.35       -1.93
# 9      RRS-7                            -2.57       -4.80
# 10     RRS-7                            -4.30       -4.80
# 11      Ty-0                            -3.55       -5.55
# 12      Ty-0                            -3.80      -15.55
# 13     Van-0                            -5.40       -1.58
# 14     Van-0                            -5.15       -1.58
```


## save workspace
```{r save workspace}
save.image("metabolite_arafield_model.RData")
```


```{r}
# knit2html("scripts/metabolite_arafield4_models.Rmd", output = "scripts/metabolite_arafield4_models.html")
```

