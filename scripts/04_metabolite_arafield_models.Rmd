---
title: "Modelling of metabolite data Arabidopsis field trials"
author: "Heike Sprenger"
date: "Monday, July 18, 2016"
output:
  html_document:
    highlight: tango
    number_section: yes
    theme: cerulean
    toc: yes
    toc_float: true
    toc_depth: 4
---

# Set working directory  
```{r set working directory}
#getwd()
#setwd("D:/work/repos/ara_field_trials/")
```

# Load workspace, packages and scripts
```{r load workspace, include=TRUE, message=FALSE}
# load packages
library(knitr)
library(pander)
library(ggplot2)
library(DAAG)
library(leaps)
library(faraway)
library(MASS)
library(glmnet)

# set options for knitr
opts_chunk$set(fig.width=6, fig.height=5, tidy=TRUE, tidy.opts=list(width.cutoff=70))
opts_knit$set(root.dir = '../')

# load workspace
#load("metabolite_arafield_model.RData")
```


# Source functions
```{r source functions}
source("../functions/func_calc_loocv.R", encoding = 'UTF-8')
```


# Load data
Use changed metabolite data, from ``metabolite_arafield4_overview4.Rmd``
```{r load data}
field2 <- read.table("output/metabolite_arafield2_modified.txt", header = TRUE, sep = "\t")
field3 <- read.table("output/metabolite_arafield3_modified.txt", header = TRUE, sep = "\t")
field4 <- read.table("output/metabolite_arafield4_modified.txt", header = TRUE, sep = "\t")

# OLD VERSION
# lt50 <- read.table("data/LT50.txt", header = TRUE, sep = "\t")
# dim(lt50) 
# 58 accessions (= 52 accessions for training + 6 for testing)

# NEW VERSION with 64 accessions
lt50 <- read.table("data/lt50_64acc.txt", header = TRUE, sep = "\t")
dim(lt50)
# 64 accessions (= 52 accessions for training + 12 for testing)
table(lt50$Model)

# capacity
yCapacity4full <- field4$LT50ACC - field4$LT50NAC 
yCapacity <- lt50$LT50ACC - lt50$LT50NAC

setdiff(lt50$Accession, field4$accession) # Ws missing in Field 4
setdiff(lt50$Accession, field3$accession)
setdiff(lt50$Accession, field2$accession)
setdiff(field4$accession, lt50$Accession)
setdiff(field3$accession, lt50$Accession)
setdiff(field2$accession, lt50$Accession)

length(unique(field2$accession))
length(unique(field3$accession))
length(unique(field4$accession))

setdiff(field3$accession, field4$accession)

# Number accessions with known LT50
length(intersect(field2$accession, lt50$Accession))
length(intersect(field3$accession, lt50$Accession))
length(intersect(field4$accession, lt50$Accession))
```

## set factor levels correctly
```{r set factor levels correctly}
# antho score (en)
field2$antho_value_en <- factor(field2$antho_value_en, 
                                              levels = c("very low", "low", "intermediate", "high", "very high"))
field3$antho_value_en <- factor(field3$antho_value_en, 
                                              levels = c("low", "intermediate", "high", "very high")) # "very low" is not present
field4$antho_value_en <- factor(field4$antho_value_en, 
                                              levels = c("very low", "low", "intermediate", "high", "very high"))

# bbch_id as factor
class(field4$bbch_id)
field2$bbch_factor <- factor(field2$bbch_id)
field3$bbch_factor <- factor(field3$bbch_id)
field4$bbch_factor <- factor(field4$bbch_id)

# bbch categories
field2$bbch_categories <- factor(field2$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))
field3$bbch_categories <- factor(field3$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))
field4$bbch_categories <- factor(field4$bbch_categories, levels = c("vegetative", "generative buds", "flowering"))

# flowering state
field2$flowering_state <- factor(field2$flowering_state, levels = c("non-flowering", "flowering"))
field3$flowering_state <- factor(field3$flowering_state, levels = c("non-flowering", "flowering"))
field4$flowering_state <- factor(field4$flowering_state, levels = c("non-flowering", "flowering"))

# vegetative state
field2$vegetative_state <- factor(field2$vegetative_state, levels = c("vegetative", "non-vegetative"))
field3$vegetative_state <- factor(field3$vegetative_state, levels = c("vegetative", "non-vegetative"))
field4$vegetative_state <- factor(field4$vegetative_state, levels = c("vegetative", "non-vegetative"))
```

## Remove missing values (NAs)
```{r remove missing values (NAs)}
dim(field2)
dim(field3)
dim(field4)

field2 <- field2[which(!is.na(field2$sucrose_positive) ), ]
field3 <- field3[which(!is.na(field3$fumarate_positive) ), ]
# Field4-Tsu, SampleID: 837060, Plant: [At.Tsu-0.n].2.2-4 --> missing values for BBCH and antho-Score! --> remove?
field4 <- field4[which(!is.na(field4$anthoscore) ), ]

dim(field2)
dim(field3)
dim(field4)
```


# Define data for modeling
## Define training and test accessions
```{r define training and test accessions}
accessions_training <- as.character(lt50$Accession[which(lt50$Model == "train")])
accessions_testing <- as.character(lt50$Accession[which(lt50$Model == "test")])
accessions_known <- as.character(lt50$Accession)
accessions_unknown <- as.character(setdiff(field3$accession, lt50$Accession))
sum(length(accessions_known), length(accessions_unknown))

# indices for accessions for training/testing
idx_train2 <- which(field2$accession %in% accessions_training)
idx_train3 <- which(field3$accession %in% accessions_training)
idx_train4 <- which(field4$accession %in% accessions_training)
idx_test2 <- which(field2$accession %in% accessions_testing)
idx_test3 <- which(field3$accession %in% accessions_testing)
idx_test4 <- which(field4$accession %in% accessions_testing)
idx_all2 <- which(field2$accession %in% accessions_known)
idx_all3 <- which(field3$accession %in% accessions_known)
idx_all4 <- which(field4$accession %in% accessions_known)

idx_unknown2 <- which(field2$accession %in% accessions_unknown)
idx_unknown3 <- which(field3$accession %in% accessions_unknown)
idx_unknown4 <- which(field4$accession %in% accessions_unknown)
```


## Define colnames
```{r define colnames}
# with original BBCH
model_colnames <- c("accession", "plant_name", "LT50ACC", "LT50NAC", "capacity",
                    "glucose_positive", "fructose_positive", "sucrose_positive",
                    "raffinose_positive", "amino_acids_positive", "malate_positive", 
                    "fumarate_positive", "proline_positive", "bbch_id", "anthoscore")

# BBCH and antho_value as factors
model_colnames_factor <- c("accession", "plant_name", "LT50ACC", "LT50NAC", "capacity",
                    "glucose_positive", "fructose_positive", "sucrose_positive",
                    "raffinose_positive", "amino_acids_positive", "malate_positive", 
                    "fumarate_positive", "proline_positive", "bbch_factor", "antho_value_en")

# with NORMALIZED BBCH
model_colnames_norm <- c("accession", "plant_name", "LT50ACC", "LT50NAC", "capacity",
                    "glucose_positive", "fructose_positive", "sucrose_positive",
                    "raffinose_positive", "amino_acids_positive", "malate_positive", 
                    "fumarate_positive", "proline_positive", "norm_bbch_id", "anthoscore")

model_colnames_short <- c("accession", "plant_name", "LT50ACC", "LT50NAC", "cap",
                          "glc","frc","suc","raf","aa","mal","fum","pro","bbch","anthoscore")
```


### subset for model training/testing
```{r subset for model training/testing}
# training set
field2_train <- field2[idx_train2, model_colnames]
field3_train <- field3[idx_train3, model_colnames]
field4_train <- field4[idx_train4, model_colnames]
field2_train_norm <- field2[idx_train2, model_colnames_norm]
field3_train_norm <- field3[idx_train3, model_colnames_norm]
field4_train_norm <- field4[idx_train4, model_colnames_norm]

# testing set
field2_test <- field2[idx_test2, model_colnames]
field3_test <- field3[idx_test3, model_colnames]
field4_test <- field4[idx_test4, model_colnames]
field2_test_norm <- field2[idx_test2, model_colnames_norm]
field3_test_norm <- field3[idx_test3, model_colnames_norm]
field4_test_norm <- field4[idx_test4, model_colnames_norm]

# all accessions
field2_all <- field2[idx_all2, model_colnames]
field3_all <- field3[idx_all3, model_colnames]
field4_all <- field4[idx_all4, model_colnames]
field2_all_fac <- field2[idx_all2, model_colnames_factor]
field3_all_fac <- field3[idx_all3, model_colnames_factor]
field4_all_fac <- field4[idx_all4, model_colnames_factor]

# only accessions with unknown LT50
field2_unknown <- field2[idx_unknown2, model_colnames]
field3_unknown <- field3[idx_unknown3, model_colnames]
field4_unknown <- field4[idx_unknown4, model_colnames]
field2_unknown_fac <- field2[idx_unknown2, model_colnames_factor]
field3_unknown_fac <- field3[idx_unknown3, model_colnames_factor]
field4_unknown_fac <- field4[idx_unknown4, model_colnames_factor]

# remove NA samples
field2_train <- field2_train[which(!is.na(field2_train$sucrose_positive) ), ]
field3_train <- field3_train[which(!is.na(field3_train$fumarate_positive) ), ]
field3_test <- field3_test[which(!is.na(field3_test$fumarate_positive) ), ]

# Field4-Tsu, SampleID: 837060, Plant: [At.Tsu-0.n].2.2-4 --> missing values for BBCH and antho-Score! --> remove?
field4_train <- field4_train[which(!is.na(field4_train$anthoscore) ), ]

length(unique(field2_train$accession)) # 42 
length(unique(field3_train$accession)) # 52/48 (with/without NAs for fumarate!)
length(unique(field4_train$accession)) # 51

length(unique(field2_test$accession)) # 6
length(unique(field3_test$accession)) # 12/9 (with/without NAs for fumarate)
length(unique(field4_test$accession)) # 12
```


## Define freezing tolerance per trial
```{r define freezing tolerance per trial}
# field2_train_LT50ACC <- field2_train$LT50ACC
# field3_train_LT50ACC <- field3_train$LT50ACC
# field4_train_LT50ACC <- field4_train$LT50ACC
# 
# yLT50NAC2 <- field2_train$LT50NAC
# yLT50NAC3 <- field3_train$LT50NAC
# yLT50NAC4 <- field4_train$LT50NAC
# 
# yCapacity2 <- field2_train$capacity
# yCapacity3 <- field3_train$capacity
# yCapacity4 <- field4_train$capacity
```


## Change colnames and export data
- using ORIGINAL/NORMALIZED BBCH!
```{r change colnames and export data}
# training data
colnames(field2_train) <- colnames(field3_train) <- colnames(field4_train) <- model_colnames_short
# using NORMALIZED BBCH
colnames(field2_train_norm) <- colnames(field3_train_norm) <- colnames(field4_train_norm) <- model_colnames_short

# test data
colnames(field2_test) <- colnames(field3_test) <- colnames(field4_test) <- model_colnames_short
# using NORMALIZED BBCH
colnames(field2_test_norm) <- colnames(field3_test_norm) <- colnames(field4_test_norm) <- model_colnames_short

# all accessions
colnames(field2_all) <- colnames(field3_all) <- colnames(field4_all) <- model_colnames_short
colnames(field2_all_fac) <- colnames(field3_all_fac) <- colnames(field4_all_fac) <- model_colnames_short

# data for accessions of unknown LT50
colnames(field2_unknown) <- colnames(field3_unknown) <- colnames(field4_unknown) <- model_colnames_short
colnames(field2_unknown_fac) <- colnames(field3_unknown_fac) <- colnames(field4_unknown_fac) <- model_colnames_short

# training data
write.table(field2_train, "output/metabolite_arafield2_train.txt", sep="\t")
write.table(field3_train, "output/metabolite_arafield3_train.txt", sep="\t")
write.table(field4_train, "output/metabolite_arafield4_train.txt", sep="\t")
write.table(field2_train_norm, "output/metabolite_arafield2_train_norm.txt", sep="\t")
write.table(field3_train_norm, "output/metabolite_arafield3_train_norm.txt", sep="\t")
write.table(field4_train_norm, "output/metabolite_arafield4_train_norm.txt", sep="\t")
# test data
write.table(field2_test, "output/metabolite_arafield2_test.txt", sep="\t")
write.table(field3_test, "output/metabolite_arafield3_test.txt", sep="\t")
write.table(field4_test, "output/metabolite_arafield4_test.txt", sep="\t")
write.table(field2_test_norm, "output/metabolite_arafield2_test_norm.txt", sep="\t")
write.table(field3_test_norm, "output/metabolite_arafield3_test_norm.txt", sep="\t")
write.table(field4_test_norm, "output/metabolite_arafield4_test_norm.txt", sep="\t")
```


# Linear Regression of LT50ACC (Training)
## Use Normalized BBCH
* Unterschied zwischen anova- und summary-Signifikanzen: erstere geben an, ob ein Effekt signifikant zur Erklaerung der Gesamtvarianz beitraegt.
* zweitere ist "nur" ein Test, ob die Steigung signifikant unterschiedlich von null ist
```{r regACC norm BBCH}
field2_regressionACC_norm <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                bbch + anthoscore, data = field2_train_norm)
field3_regressionACC_norm <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                bbch + anthoscore, data = field3_train_norm)
field4_regressionACC_norm <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                bbch + anthoscore, data = field4_train_norm)
summary(field2_regressionACC_norm)$r.squared # Multiple R-squared: 0.356
summary(field3_regressionACC_norm)$r.squared # Multiple R-squared: 0.248
summary(field4_regressionACC_norm)$r.squared # Multiple R-squared: 0.361   

# use FACTOR for antho_score and norm_bbch
field2_regressionACC_norm_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                       factor(bbch) + factor(anthoscore), data = field2_train_norm)
field3_regressionACC_norm_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                       factor(bbch) + factor(anthoscore), data = field3_train_norm)
field4_regressionACC_norm_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                       factor(bbch) + factor(anthoscore), data = field4_train_norm)
summary(field2_regressionACC_norm_factor)$r.squared # Multiple R-squared: 0.449
summary(field3_regressionACC_norm_factor)$r.squared # Multiple R-squared: 0.356 
summary(field4_regressionACC_norm_factor)$r.squared # Multiple R-squared: 0.431 
```


## Use original BBCH - without factor
```{r regACC original BBCH - without factor}
field2_regressionACC <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                               bbch + anthoscore, data = field2_train)
field3_regressionACC <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                bbch + anthoscore, data = field3_train)
field4_regressionACC <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                bbch + anthoscore, data = field4_train)

summary(field2_regressionACC)$r.squared # 0.35
summary(field3_regressionACC)$r.squared # 0.231
summary(field4_regressionACC)$r.squared # 0.405 
```


## Use original BBCH - with factor
```{r regACC original BBCH - with factor}
field2_regressionACC_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    factor(bbch) + factor(anthoscore), data = field2_train)
field3_regressionACC_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    factor(bbch) + factor(anthoscore), data = field3_train)
field4_regressionACC_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    factor(bbch) + factor(anthoscore), data = field4_train)

summary(field2_regressionACC_factor)$r.squared # 0.449
summary(field3_regressionACC_factor)$r.squared # 0.356
summary(field4_regressionACC_factor)$r.squared # 0.431
summary(field4_regressionACC_factor)$adj.r.squared # Adjusted R-squared: 0.301

## --> identical to model with factor of normalized scores
```


# Linear Regression of LT50ACC (All Data)
## Use original BBCH - without factor
```{r regACC_all original BBCH - without factor}
field2_regressionACC_all <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    bbch + anthoscore, data = field2_all)
field3_regressionACC_all <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    bbch + anthoscore, data = field3_all)
field4_regressionACC_all <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    bbch + anthoscore, data = field4_all)

summary(field2_regressionACC_all)$r.squared # 0.367
summary(field3_regressionACC_all)$r.squared # 0.201
summary(field4_regressionACC_all)$r.squared # 0.384
summary(field4_regressionACC_all)$adj.r.squared # Adjusted R-squared: 0.334
```

## Use original BBCH - with factor
```{r regACC_all original BBCH - with factor}
field2_regressionACC_all_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    bbch + anthoscore, data = field2_all_fac)
field3_regressionACC_all_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    bbch + anthoscore, data = field3_all_fac)
field4_regressionACC_all_factor <- lm(LT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                    bbch + anthoscore, data = field4_all_fac)

summary(field2_regressionACC_all_factor)$r.squared # 0.479
summary(field3_regressionACC_all_factor)$r.squared # 0.346
summary(field4_regressionACC_all_factor)$r.squared # 0.412
summary(field4_regressionACC_all_factor)$adj.r.squared # Adjusted R-squared: 0.309
```


# Cross-validation
## 5-fold CV
```{r cross-validation}
field2_DAAGdata <- field2_train[,c(3:15)]
field3_DAAGdata <- field3_train[,c(3:15)]
field4_DAAGdata <- field4_train[,c(3:15)]

field2_DAAGdata_all <- field2_all[,c(3:15)]
field3_DAAGdata_all <- field3_all[,c(3:15)]
field4_DAAGdata_all <- field4_all[,c(3:15)]

sum(is.na(field2_DAAGdata)) # 1
sum(is.na(field3_DAAGdata)) # 13
sum(is.na(field4_DAAGdata)) # 0

# 5-fold cross-validation
CVlm(data = field2_DAAGdata, form.lm = field2_regressionACC, m = 5) # overall ms: 3.55
CVlm(data = field3_DAAGdata, form.lm = field3_regressionACC, m = 5) # overall ms: 2.69
CVlm(data = field4_DAAGdata, form.lm = field4_regressionACC, m = 5) # Overall ms: 2.4

# CVlm(data = field4_DAAGdata, form.lm = field4_regressionACC_factor, m = 5) # Overall ms: 2.44
# not possible with factors!
```


## Leave-One-Out-cross-validation (LOO-CV)
```{r Leave-One-Out-cross-validation (LOO-CV), warning=FALSE, message=FALSE}
# training data
field2_loocv <- CVlm(data = field2_DAAGdata, form.lm = field2_regressionACC, m = 76, printit = F)
attr(field2_loocv, "ms") # Overall ms: 3.19

field3_loocv <- CVlm(data = field3_DAAGdata, form.lm = field3_regressionACC, m = 97, printit = F)
attr(field3_loocv, "ms") # Overall ms: 2.76

field4_loocv <- CVlm(data = field4_DAAGdata, form.lm = field4_regressionACC, m = 109, printit = F)
attr(field4_loocv, "ms") # Overall ms: 2.31


# ALL data
field2_all_loocv <- CVlm(data = field2_DAAGdata_all, form.lm = field2_regressionACC_all, m = 87, printit = F)
attr(field2_all_loocv, "ms") # Overall ms: 2.89

field3_all_loocv <- CVlm(data = field3_DAAGdata_all, form.lm = field3_regressionACC_all, m = 114, printit = F)
attr(field3_all_loocv, "ms") # Overall ms: 2.55

field4_all_loocv <- CVlm(data = field4_DAAGdata_all, form.lm = field4_regressionACC_all, m = 135, printit = F)
attr(field4_all_loocv, "ms") # Overall ms: 2.19
```


# Prediction of LT50ACC
## Prediction of LT50ACC with model (for accessions that are included in the model = training data)
```{r prediction of LT50ACC using factor model with ORIGINAL BBCH}
cor.test(field2_regressionACC_factor$fitted.values, field2_train$LT50ACC) # R = 0.67
cor.test(field3_regressionACC_factor$fitted.values, field3_train$LT50ACC) # R = 0.597
cor.test(field4_regressionACC_factor$fitted.values, field4_train$LT50ACC) # R = 0.656 / R2 = 0.43

plot(field2_train$LT50ACC, field2_regressionACC_factor$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), 
     pch = 19)
abline(lm(field2_regressionACC_factor$fitted.values ~ field2_train$LT50ACC))

plot(field3_train$LT50ACC, field3_regressionACC_factor$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), 
     pch = 19)
abline(lm(field3_regressionACC_factor$fitted.values ~ field3_train$LT50ACC))

plot(field4_train$LT50ACC, field4_regressionACC_factor$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(field4_regressionACC_factor$fitted.values ~ field4_train$LT50ACC))
```


## Prediction of LT50ACC with model (for accessions that are included in the model = training data)
```{r prediction of LT50ACC using model with ORIGINAL BBCH}
cor.test(field2_regressionACC$fitted.values, field2_train$LT50ACC) # R = 0.592
cor.test(field3_regressionACC$fitted.values, field3_train$LT50ACC) # R = 0.481
cor.test(field4_regressionACC$fitted.values, field4_train$LT50ACC) # R = 0.636

plot(field2_train$LT50ACC, field2_regressionACC$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), 
     pch = 19)
abline(lm(field2_regressionACC$fitted.values ~ field2_train$LT50ACC))

plot(field3_train$LT50ACC, field3_regressionACC_factor$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), 
     pch = 19)
abline(lm(field3_regressionACC$fitted.values ~ field3_train$LT50ACC))

plot(field4_train$LT50ACC, field4_regressionACC$fitted.values, 
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(field4_regressionACC$fitted.values ~ field4_train$LT50ACC))
```


## Prediction of LT50ACC test data
```{r prediction of LT50ACC for test data}
# Vorhersage der LT50-Werte fuer ausgewaehlte Akzessionen mit Hilfe des berechneten Regressionsmodells
field2_predictionACC <- predict(field2_regressionACC, field2_test[,6:15])
field3_predictionACC <- predict(field3_regressionACC, field3_test[,6:15])
field4_predictionACC <- predict(field4_regressionACC, field4_test[,6:15])

field2_predictionACC_factor <- predict(field2_regressionACC_factor, field2_test[,6:15])
field3_predictionACC_factor <- predict(field3_regressionACC_factor, field3_test[,6:15])
field4_predictionACC_factor <- predict(field4_regressionACC_factor, field4_test[,6:15])

field2_predictionACC_norm <- predict(field2_regressionACC_norm, field2_test_norm[,6:15])
field3_predictionACC_norm <- predict(field3_regressionACC_norm, field3_test_norm[,6:15])
field4_predictionACC_norm <- predict(field4_regressionACC_norm, field4_test_norm[,6:15])

field2_predictionACC_norm_factor <- predict(field2_regressionACC_norm_factor, field2_test_norm[,6:15])
field3_predictionACC_norm_factor <- predict(field3_regressionACC_norm_factor, field3_test_norm[,6:15])
field4_predictionACC_norm_factor <- predict(field4_regressionACC_norm_factor, field4_test_norm[,6:15])
```

### Tables of predicted LT50ACC for test data
```{r tables of predicted LT50ACC for test data}
field2_predictionACC_table <- data.frame(accession = field2_test$accession,
                                         measured = field2_test$LT50ACC,
                                         predicted = field2_predictionACC,
                                         predicted_factor = field2_predictionACC_factor,
                                         predicted_norm = field2_predictionACC_norm)

field3_predictionACC_table <- data.frame(accession = field3_test$accession,
                                         measured = field3_test$LT50ACC,
                                         predicted = field3_predictionACC,
                                         predicted_factor = field3_predictionACC_factor,
                                         predicted_norm = field3_predictionACC_norm)

field4_predictionACC_table <- data.frame(accession = field4_test$accession,
                                         measured = field4_test$LT50ACC,
                                         predicted = field4_predictionACC,
                                         predicted_factor = field4_predictionACC_factor,
                                         predicted_norm = field4_predictionACC_norm)

head(field2_predictionACC_table)
head(field3_predictionACC_table)
head(field4_predictionACC_table)

write.table(field2_predictionACC_table, "output/field2_predictionACC.txt", sep="\t")
write.table(field3_predictionACC_table, "output/field3_predictionACC.txt", sep="\t")
write.table(field4_predictionACC_table, "output/field4_predictionACC.txt", sep="\t")
```


### Correlation of predicted and measured LT50ACC for test data
```{r correlation of predicted and measured LT50ACC for test data}
# field 2
cor(field2_test$LT50ACC, field2_predictionACC)
cor(field2_test$LT50ACC, field2_predictionACC_factor)
cor(field2_test$LT50ACC, field2_predictionACC_norm)
cor(field2_test$LT50ACC, field2_predictionACC_norm_factor)

# field 3
cor(field3_test$LT50ACC, field3_predictionACC)
cor(field3_test$LT50ACC, field3_predictionACC_factor)
cor(field3_test$LT50ACC, field3_predictionACC_norm)
cor(field3_test$LT50ACC, field3_predictionACC_norm_factor)

# field 4
cor(field4_test$LT50ACC, field4_predictionACC)
cor(field4_test$LT50ACC, field4_predictionACC_factor)
cor(field4_test$LT50ACC, field4_predictionACC_norm)
cor(field4_test$LT50ACC, field4_predictionACC_norm_factor)
```


### Difference between predicted and measured LT50 for test data
```{r difference between predicted and measured LT50 for test data}
sum(((field4_predictionACC)-(field4_test$LT50ACC))^2)
# 52.6
sum(((field4_predictionACC_norm)-(field4_test$LT50ACC))^2)
# 64.9
sum(((field4_predictionACC_factor)-(field4_test$LT50ACC))^2)
# 55.3

sum(((field4_predictionACC)-(field4_test$LT50ACC))^2) / sum((field4_test$LT50ACC)^2)
# 0.0232
sum(((field4_predictionACC_norm)-(field4_test$LT50ACC))^2) / sum((field4_test$LT50ACC)^2)
# 0.0286
```


### Barplots of predicted LT50ACC for test data
```{r barplots of predicted LT50ACC for test data}
plot(field4_test$LT50ACC, field4_predictionACC)
plot(field4_test$LT50ACC, field4_predictionACC_factor)

barplot(t(as.matrix(field2_predictionACC_table[,c(2,4)])), 
        beside=T, names.arg = field2_predictionACC_table$accession, las=2)

barplot(t(as.matrix(field3_predictionACC_table[,c(2,4)])), 
        beside=T, names.arg = field3_predictionACC_table$accession, las=2)

barplot(t(as.matrix(field4_predictionACC_table[,2:3])), 
        beside=T, names.arg = field4_predictionACC_table$accession, las=2)

barplot(t(as.matrix(field4_predictionACC_table[,c(2,4)])), 
        beside=T, names.arg = field4_predictionACC_table$accession, las=2)
```


### Confidence interval
```{r confidence interval}
# mehr zum Thema Vorhersage und Konfidenz-Intervalle im Kapitel 3 im Buch Regression, Seite 123
# Vorhersage mit 95%-Vorhersageintervall
head(predict(field4_regressionACC, field4_test, interval="prediction"))
# Vorhersage mit 95%-Konfidenzintervall
head(predict(field4_regressionACC, field4_test, interval="confidence"))
```


# Accessions of unknown LT50
```{r accessions of unknown LT50}
accessions_unknown

field3_regressionACC_all_factor$xlevels$`bbch` <- union(field3_regressionACC_all_factor$xlevels$`bbch`,
                                                        levels(field3_unknown$bbch))

field4_regressionACC_all_factor$xlevels$`bbch` <- union(field4_regressionACC_all_factor$xlevels$`bbch`,
                                                        levels(field4_unknown$bbch))

field2_unknown_predictionACC_factor <- predict(field2_regressionACC_all_factor, field2_unknown_fac[,6:15])
field3_unknown_predictionACC_factor <- predict(field3_regressionACC_all_factor, field3_unknown_fac[,6:15])
field4_unknown_predictionACC_factor <- predict(field4_regressionACC_all_factor, field4_unknown_fac[,6:15])
names(field2_unknown_predictionACC_factor) <- field2_unknown$accession
names(field3_unknown_predictionACC_factor) <- field3_unknown$accession
names(field4_unknown_predictionACC_factor) <- field4_unknown$accession

field2_unknown_predictionACC <- predict(field2_regressionACC, field2_unknown[,6:15])
field3_unknown_predictionACC <- predict(field3_regressionACC, field3_unknown[,6:15])
field4_unknown_predictionACC <- predict(field4_regressionACC, field4_unknown[,6:15])
names(field2_unknown_predictionACC) <- field2_unknown$accession
names(field3_unknown_predictionACC) <- field3_unknown$accession
names(field4_unknown_predictionACC) <- field4_unknown$accession
```


# Reduced model
```{r reduced model}
summary(field2_regressionACC_factor)
summary(field3_regressionACC_factor)
summary(field4_regressionACC_factor)

anova(field2_regressionACC_factor)
anova(field3_regressionACC_factor)
anova(field4_regressionACC_factor)
```



## Cp-plot
```{r Cp-plot}
################### Cp-Plot ####################
x <- as.matrix(field4_train[,c(6:15)]) # Create design matrix x
y <- field4_train$LT50ACC # Create response vector y
leapsModels <- leaps(x, y, method="Cp", nbest=3, names=colnames(x))

pdf(file="figures/Metabolite_AraField4_CpPlot.pdf")
Cpplot(leapsModels)
dev.off()

adjr <- leaps(x, y, method="adjr2") # Check which model the adjusted R2 selects
maxadjr(adjr, 8)

# y <- arafield4_regressiondata$yLT50ACC[cooks.distance(arafield4_regressionACC)<0.2]
# x <- cbind(arafield4_regressiondata[,4:14])
# x_part <- x[cooks.distance(arafield4_regressionACC)<0.2,]
# a <- leaps(x_part, y)
# b <- leaps(x, y, method="adjr2")
```


# LASSO model
## LASSO model field 3
```{r LASSO model field 3}
x <- as.matrix(field3_train[,6:15])
y <- field3_train$LT50ACC

test_x <- as.matrix(field3_test[,6:15])
test_y <- field3_test$LT50ACC

set.seed(1)
field3_lasso_ACC <- glmnet(x,y)

# Cross-validation
set.seed(1)
field3_lasso_cv_ACC <- cv.glmnet(x, y)

# use no specific lambda
field3_lasso_ACC_pred_test <- predict(field3_lasso_ACC, new = test_x)

# calculate mean error
field3_lasso_ACC_pred_test_err <- apply( (field3_lasso_ACC_pred_test - test_y)^2, 2, mean )

# use optimal lamba value
field3_lasso_ACC_pred_all_lambda <- predict(field3_lasso_cv_ACC, new = x, s="lambda.min")
field3_lasso_ACC_pred_test_lambda <- predict(field3_lasso_cv_ACC, new = test_x, s="lambda.min")

# number of variables in model (for lambda.min)
which(field3_lasso_cv_ACC$lambda == field3_lasso_cv_ACC$lambda.min)
# 32
field3_lasso_cv_ACC$nzero[23]
# 10

# coefficients
field3_lasso_cv_ACC$glmnet.fit$beta[,"s31"]

cor.test(y, field3_lasso_ACC_pred_all_lambda)
# 0.477
cor.test(test_y, field3_lasso_ACC_pred_test_lambda)
# 0.405

field3_lasso_ACC_pred_test_lambda_table <- data.frame(accession = field3_test$accession,
                                                      measured = field3_test$LT50ACC,
                                                      lasso = field3_lasso_ACC_pred_test_lambda, 
                                                      regression_fac = field3_predictionACC_factor)

sum(((field3_lasso_ACC_pred_test_lambda)-(field3_test$LT50ACC))^2)
# 33.2

sum(((field3_lasso_ACC_pred_test_lambda)-(field3_test$LT50ACC))^2) / sum((field3_test$LT50ACC)^2)
# 0.0211
```


## LASSO model field 4
```{r LASSO model field 4}
x <- as.matrix(field4_train[,6:15])
y <- field4_train$LT50ACC

test_x <- as.matrix(field4_test[,6:15])
test_y <- field4_test$LT50ACC

set.seed(1)
field4_lasso_ACC <- glmnet(x,y)

# Cross-validation
set.seed(1)
field4_lasso_cv_ACC <- cv.glmnet(x, y)
# plot(field4_lasso_cv_ACC)

# use no specific lambda
field4_lasso_ACC_pred_test <- predict(field4_lasso_ACC, new = test_x)

# calculate mean error
field4_lasso_ACC_pred_test_err <- apply( (field4_lasso_ACC_pred_test - test_y)^2, 2, mean )
# points(log(field4_lasso_ACC$lambda), field4_lasso_ACC_pred_test_err, col="blue", pch="*")

# use optimal lamba value
field4_lasso_ACC_pred_all_lambda <- predict(field4_lasso_cv_ACC, new = x, s="lambda.min")
field4_lasso_ACC_pred_test_lambda <- predict(field4_lasso_cv_ACC, new = test_x, s="lambda.min")

# number of variables in model (for lambda.min)
which(field4_lasso_cv_ACC$lambda == field4_lasso_cv_ACC$lambda.min)
# 23
field4_lasso_cv_ACC$nzero[23]
# 4

# coefficients
field4_lasso_cv_ACC$glmnet.fit$beta[,"s22"]


# plot observed vs. predicted DRYM
# plot(y, lasso_all_pred_all_lambda)
# abline(0,1)
cor.test(y, field4_lasso_ACC_pred_all_lambda) # 0.609
cor.test(test_y, field4_lasso_ACC_pred_test_lambda) # 0.592

field4_lasso_ACC_pred_test_lambda_table <- data.frame(accession = field4_test$accession,
                                                      measured = field4_test$LT50ACC,
                                                      lasso = field4_lasso_ACC_pred_test_lambda, 
                                                      regression = field4_predictionACC,
                                                      regression_fac = field4_predictionACC_factor)


# barplot(t(as.matrix(lasso_all_pred_test_lambda_table[,2:3])), 
#         beside=T, names.arg = lasso_all_pred_test_lambda_table$acc, las=2)
# 
# barplot(t(as.matrix(lasso_all_pred_test_lambda_table[,2:4])), 
#         beside=T, names.arg = lasso_all_pred_test_lambda_table$acc, las=2)

sum(((field4_lasso_ACC_pred_test_lambda)-(field4_test$LT50ACC))^2)
# 38.3

sum(((field4_lasso_ACC_pred_test_lambda)-(field4_test$LT50ACC))^2) / sum((field4_test$LT50ACC)^2)
# 0.0169
```


## Prediction of LT50ACC with model (for accessions that are included in the model = training data)
```{r prediction of LT50ACC using model with ORIGINAL BBCH and LASSO}
cor.test(field4_regressionACC$fitted.values, field4_train$LT50ACC)
# R = 0.636
cor.test(field4_lasso_ACC_pred_all_lambda, field4_train$LT50ACC)
# R = 0.609

par(mfrow=c(1,2))

plot(field4_train$LT50ACC, field4_regressionACC$fitted.values, main = "regression",
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(field4_regressionACC$fitted.values ~ field4_train$LT50ACC))
#lm(field4_regressionACC$fitted.values ~ field4_train$LT50ACC)

plot(field4_train$LT50ACC, field4_lasso_ACC_pred_all_lambda, main = "lasso",
     ylab="LT50ACC fitted values", 
     xlab="LT50ACC measured values", 
     xlim=c(-12.5,-5), ylim=c(-12.5,-5), pch = 19)
abline(lm(field4_lasso_ACC_pred_all_lambda ~ field4_train$LT50ACC))
#lm(field4_lasso_ACC_pred_all_lambda ~ field4_train$LT50ACC)
```



```{r compare different models}
range(test_y)
lim_values <- c(-11.6, -5.5)

pdf("figures/field4_compare_model_validation.pdf", 8, 8)
par(mfrow=c(2,2))

plot(test_y, field4_lasso_ACC_pred_test_lambda, col = "white",
     main = "lasso model", xlim = lim_values, ylim = lim_values)
text(test_y, field4_lasso_ACC_pred_test_lambda, field4_test$accession)
text(-10,-6, "cor = 0.405", col="red")
abline(0,1, col="red")
cor.test(test_y, field4_lasso_ACC_pred_test_lambda)

plot(test_y, field4_predictionACC, col = "white",
     main = "regression model", xlim = lim_values, ylim = lim_values)
text(test_y, field4_predictionACC, field4_test$accession)
text(-10,-6, "cor = 0.295", col="red")
abline(0,1, col="red")
cor.test(test_y, field4_predictionACC)

plot(test_y, field4_predictionACC_factor, col = "white",
     main = "regression model (factor)", 
     xlim = lim_values, ylim = lim_values)
text(test_y, field4_predictionACC_factor, field4_test$accession)
text(-10,-6, "cor = 0.3", col="red")
abline(0,1, col="red")
cor.test(test_y, field4_predictionACC_factor)

plot(test_y, field4_predictionACC_norm, col = "white",
     main = "regression model (norm BBCH)",
     xlim = lim_values, ylim = lim_values)
text(test_y, field4_predictionACC_norm, field4_test$accession)
text(-10,-6, "cor = 0.18", col="red")
abline(0,1, col="red")
cor.test(test_y, field4_predictionACC_norm)

dev.off()
```








# variable selection

## forward selection
```{r forward selection}
# Create initial NULL model
field2_regressionACC_null <- lm(field2_train$LT50ACC ~ 1, data = field2_train)
field3_regressionACC_null <- lm(field3_train$LT50ACC ~ 1, data = field3_train)
field4_regressionACC_null <- lm(field4_train$LT50ACC ~ 1, data = field4_train)

# Choose a model by AIC in a Stepwise Algorithm
# Forward
field4_regressionACC_fw <- step(field4_regressionACC_null, 
                                scope = formula(field4_regressionACC), 
                                direction = "forward")

# Step:  AIC=92.9
# yLT50ACC ~ norm_bbch + raf + fum + suc
#              Df Sum of Sq RSS  AIC
# <none>                    233 92.9
# + glc         1     2.340 231 93.8
# + pro         1     2.281 231 93.8
# + frc         1     2.266 231 93.8
# + anthoscore  1     1.144 232 94.4
# + antho       1     0.510 233 94.7
# + aa          1     0.101 233 94.9
# + mal         1     0.006 233 94.9

summary(field4_regressionACC_fw)
# R = 0.368

# Vorhersage-Werte fuer Oekotypen, die nicht im Modell sind
predict(field4_regressionACC_fw, field4_test)

# Summe der quadratischen Differenzen zwischen Mess- und Vorhersagewert 
sum(((predict(field4_regressionACC_fw, field4_test)) - (field4_test$LT50ACC))^2)
# 51.7
sum(((predict(field4_regressionACC_fw, field4_test)) - (field4_test$LT50ACC))^2)/ sum((field4_test$LT50ACC)^2)
# 0.0227
```


## stepAIC
### default direction (if missing): backward!!!
```{r selection in both directions}
############  SELECTION in BOTH DIRECTIONS ###################
# Without FACTOR!
step(field4_regressionACC_null, 
     scope = formula(field4_regressionACC_factor), 
     direction = "both")
# Step:  AIC=92.9
# yLT50ACC ~ norm_bbch + raf + fum + suc
# Call:
# lm(formula = yLT50ACC ~ norm_bbch + raf + fum + suc, data = arafield4_regressiondata)
# Coefficients:
# (Intercept)    norm_bbch          raf          fum          suc  
#     -7.2765       1.0280      -0.9556      -0.0720       0.0542  

# das selbe Modell wie bei forward selection

# Both directions, starting from Null model (FACTOR!)
field2_regressionACC_factorAIC <- step(field2_regressionACC_null, 
                                       scope = formula(field2_regressionACC_factor), 
                                       direction = "both")
# raf, fum, mal

field3_regressionACC_factorAIC <- step(field3_regressionACC_null, 
                                       scope = formula(field3_regressionACC_factor), 
                                       direction = "both")
summary(field3_regressionACC_factorAIC)
# factor(bbch), pro, suc

field4_regressionACC_factorAIC <- step(field4_regressionACC_null, 
                                       scope = formula(field4_regressionACC_factor), 
                                       direction = "both")
summary(field4_regressionACC_factorAIC)
# factor(bbch), raf, suc, fum


# Summe der quadratischen Differenzen zwischen Mess- und Vorhersagewert
sum(((predict(field4_regressionACC_factorAIC, field4_test)) - (field4_test$LT50ACC))^2) / sum((field4_test$LT50ACC)^2)
# 0.0227
sum(((predict(field4_regressionACC_factorAIC, field4_test)) - (field4_test$LT50ACC))^2)
# 51.6

# bind predicted and measured LT50ACC for accessions of test set
head(data.frame(accession = field3_test$accession, 
                measured = field3_test$LT50ACC,
                predicted_reduced = predict(field3_regressionACC_factorAIC, field3_test),
                predicted_full = predict(field3_regressionACC_factor, field3_test)))

head(data.frame(accession = field4_test$accession, 
                measured = field4_test$LT50ACC,
                predicted_reduced = predict(field4_regressionACC_factorAIC, field4_test),
                predicted_full = predict(field4_regressionACC_factor, field4_test)))
```


### stepAIC default
#### default direction (if missing): backward!!!
```{r stepAIC default}
field4_stepAIC_ACC <- stepAIC(field4_regressionACC)
field4_stepAIC_ACC$coefficients

# predited values for accessions that are included in the null model (training data)
# field4_stepAIC_ACC$fitted.values

# predited values for accessions that are NOT included in the null model (test data)
field4_prediction_stepAIC_ACC <- predict(field4_stepAIC_ACC, field4_test)
 
head(data.frame(accession = field4_test$accession, 
                measured = field4_test$LT50ACC, 
                predicted_reduced = field4_prediction_stepAIC_ACC,
                predicted_full = predict(field4_regressionACC, field4_test)))

# Summe der quadratischen Differenzen zwischen Mess- und Vorhersagewert
sum(((field4_prediction_stepAIC_ACC) - (field4_test$LT50ACC))^2)
# 51.4
sum(((field4_prediction_stepAIC_ACC) - (field4_test$LT50ACC))^2)/ sum((field4_test$LT50ACC)^2)
# 0.0227
```


### comparison of two models --> ANOVA
```{r comparison of two models}
# anova(arafield4_regressionACC, arafield4_stepAIC_ACC)
# Analysis of Variance Table
# 
# Model 1: yLT50ACC ~ glc + frc + suc + raf + aa + mal + fum + pro + antho + 
#     norm_bbch + anthoscore
# Model 2: yLT50ACC ~ frc + raf + fum + pro + norm_bbch
#   Res.Df RSS Df Sum of Sq    F Pr(>F)
# 1     97 223                         
# 2    103 230 -6     -6.28 0.45   0.84

# p-value > 0.05, also Annahme von H0, dass beide Modelle aehnlich
```


### backward selection
```{r backward selection}
step(field4_regressionACC, scope=formula(field4_regressionACC), direction="backward")
# fuehrt zum gleichen Ergebnis wir stepAIC, da bei step auch der AIC-Wert minimiert wird (backward)

```


### add quadratic term for norm_bbch
#### increases R2 from 0.34 to 0.37
```{r add quadratic term for norm_bbch}
summary(lm(LT50ACC ~ frc + raf + fum + poly(bbch,2), data = field4_train_norm))
# Adjusted R-squared:  0.345 

testlm2 <- lm(I(1/LT50ACC) ~ frc + raf + fum + poly(bbch,2), data = field4_train_norm)
summary(lm(I(1/LT50ACC) ~ frc + raf + fum + poly(bbch,2), data = field4_train_norm))
# Adjusted R-squared: 0.39
```


### regression model for LT50NAC
```{r regression model for LT50NAC}
############## Regressionsmodell fuer LT50NAC #######################
field4_regressionNAC <- lm(LT50NAC ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                bbch + anthoscore, data = field4_train)

summary(field4_regressionNAC)
# Adjusted R-squared:  0.121

# Vorhersage der LT50-Werte mit Hilfe des Modells (fuer Oekotypen, die im Modell enthalten sind)
# field4_regressionNAC$fitted.values

cor(field4_train$LT50NAC, field4_regressionNAC$fitted.values)
# 0.45
```


### prediction of LT50NAC for test data
```{r prediction of LT50NAC for test data}
field4_predictionNAC <- predict(field4_regressionNAC, field4_test)

head(data.frame(accession = field4_test$accession,
                measured = field4_test$LT50NAC,
                predicted = field4_predictionNAC))
```


### stepAIC for LT50NAC
```{r stepAIC for LT50NAC}
field4_stepAIC_NAC <- stepAIC(field4_regressionNAC)

summary(field4_stepAIC_NAC)
# Adjusted R-squared:  0.164 

# fuer Oekotypen, die im Modell sind
field4_stepAIC_NAC$fitted.values

# fuer Oekotypen, die nicht im Modell sind
field4_prediction_stepAIC_NAC <- predict(field4_stepAIC_NAC, field4_test)

head(data.frame(accession = field4_test$accession,
                measured = field4_test$LT50NAC,
                predicted = field4_prediction_stepAIC_NAC))
```


### regression model for acclimation capacity
```{r regression model for acclimation capacity}
# yCapacity4

field4_regressionCap <- lm(cap ~ glc + frc + suc + raf + aa + mal + fum + pro + 
                                bbch + anthoscore, data = field4_train_norm)

summary(field4_regressionCap)
# Adjusted R-squared:  0.278 

# Vorhersage der Kapazitaet mit Hilfe des Modells (fuer Oekotypen, die im Modell enthalten sind)
# field4_regressionCap$fitted.values

cor(field4_train_norm$cap, field4_regressionCap$fitted.values)
# 0.587
```


### prediction of capacity for test data
```{r prediction of capacity for test data}
# Vorhersage der LT50-Werte fuer ausgewaehlte Akzessionen mit Hilfe des berechneten Regressionsmodells
field4_predictionCap <- predict(field4_regressionCap, field4_test_norm)

head(data.frame(accession = field4_test$accession,
                measured = field4_test$cap,
                predicted = field4_predictionCap))
```


### stepAIC for Capacity
```{r stepAIC for Capacity}
field4_stepAIC_Cap <- stepAIC(field4_regressionCap)

summary(field4_stepAIC_Cap)
# Adjusted R-squared:  0.305

# fuer Oekotypen, die im Modell sind
# field4_stepAIC_Cap$fitted.values

# fuer Oekotypen, die nicht im Modell sind
field4_prediction_stepAIC_Cap <- predict(field4_stepAIC_Cap, field4_test_norm)

head(data.frame(accession = field4_test$accession,
                measured = field4_test$cap,
                predicted = field4_prediction_stepAIC_Cap))
```


# LOO-CV
```{r loo-cv field, warning=FALSE}
field2_error_cv <- func_calc_loocv(field2)
field3_error_cv <- func_calc_loocv(field3)
field4_error_cv <- func_calc_loocv(field4)

pairs(data.frame(field2_error_cv, field3_error_cv, field4_error_cv))
pairs(data.frame(log(field2_error_cv), log(field3_error_cv), log(field4_error_cv)))
```



# Save workspace
```{r save workspace}
save.image("metabolite_arafield_model.RData")
sessionInfo()
```


```{r}
# knit2html("scripts/metabolite_arafield4_models.Rmd", output = "scripts/metabolite_arafield4_models.html")
```

