---
title: "Metabolite data Arabidopsis field trial 4 (2009/10)"
author: "Heike Sprenger"
date: "Tuesday, May 07, 2015"
output: html_document
---

### Set working directory  
```{r set working directory}
#getwd()
setwd("D:/work/repos/ara_field_trials/")
```

### Load workspace, packages and scripts
```{r load workspace}
# load packages
library(knitr)
library(pander)
library(ggplot2)

# set options for knitr
opts_chunk$set(fig.width=10, fig.height=5)
opts_knit$set(root.dir = 'D:/work/repos/ara_field_trials/')

# load workspace
#load("metabolite_arafield4.RData")
```

### Load data
```{r load data}
metabolite_arafield4 <- read.table("data/Metabolite_AraField4.txt", header=TRUE, sep="\t")
pander(metabolite_arafield4[1:5,1:10])

lt50 <- read.table("data/LT50.txt", header=TRUE, sep="\t")
pander(head(lt50))
```


### Anthocyan score
```{r anthocyan score}
# gibt verschiedene Levels des Faktors "antho_value" --> Anthocyan-Score
levels(metabolite_arafield4$antho_value)

# Ordnen der Levels
ordered_antho_value4 <- ordered(metabolite_arafield4$antho_value, levels=c("", "sehr gering", "gering", "mittel", "hoch", "sehr hoch"))
levels(ordered_antho_value4)

# überprüfen, ob richtige Reihenfolge
table(ordered_antho_value4)

# Verbinden der Spalte der geordneten Anthocyan-Scores mit Tabelle
metabolite_arafield4 <- cbind(metabolite_arafield4, 
                           antho_value = ordered_antho_value4)

# Anpassung der Spalten-Reihenfolge (Spalte 27 = anthovalue als 19. Spalte)
metabolite_arafield4 <- (metabolite_arafield4[ , names(metabolite_arafield4)[c(1:18,27,20:26)]] )

# create english version
metabolite_arafield4$antho_value_en <- metabolite_arafield4$antho_value
levels(metabolite_arafield4$antho_value_en) <- c("low", "high", "intermediate", "very low", "very high")
metabolite_arafield4$antho_value_en <- factor(metabolite_arafield4$antho_value_en, 
                                              levels=c("very low", "low", "intermediate", "high", "very high") )
```


## BBCH
### Ranking BBCH
```{r ranking BBCH}
# rank(x, na.last = TRUE, ties.method = c("average", "first", "random", "max", "min"))
# Returns the sample ranks of the values in a vector. Ties (i.e., equal values) and missing values can be handled in several ways. 

# wobei NAs beibehalten werden (statt Rang für NA zu vergeben)
rank_bbch_id4 <- rank(metabolite_arafield4$bbch_id, na.last="keep")    # keep NAs
# Berechnung des gerankten BBCH in Prozent, wobei hier Rank 159 Maximum ist, also 100%
percent_bbch_id4 <- rank_bbch_id4/159*100

# Anfügen, Anordnen und Umbennen der Spalten
metabolite_arafield4 <- cbind(metabolite_arafield4, 
                              rank_bbch_id = rank_bbch_id4, 
                              percent_bbch_id = percent_bbch_id4)

metabolite_arafield4 <- (metabolite_arafield4[ , names(metabolite_arafield4)[c(1:18,27,28,29,19:26)]] )
```


### Median BBCH
```{r median BBCH}
# Median des gerankten BBCH (in %) für alle C24-Boxen
c24_bbch4 <- median(metabolite_arafield4$percent_bbch_id[which(metabolite_arafield4$accession=="C24")])
# 96.22642
 
# Median des gerankten BBCH (in %) für alle Col-0-Boxen
col0_bbch4 <- median(metabolite_arafield4$percent_bbch_id[which(metabolite_arafield4$accession %in% c("Col-0","Col-0-G1"))])
# 61.63522
```


### Normalization BBCH
Formel zur Normalisierung des BBCH Scoring anhand der Check-Kultivare C24 und Col-0 über verschiedene Feldversuche 
BBCH(norm)(xi) = [RankBBCH (xi) - Median (RankBBCH(Col-0))]/[ Median(RankBBCH(C24)) - Median (RankBBCH(Col-0))] 
also ergibt sich für Col-0 ein normierter Wert von 0  (insofern Col-0(i) = median(Col-0) 
und für C24 1 (insofern C24(i) = median(C24)
```{r normalization BBCH}
norm_bbch_id4 <- (metabolite_arafield4$percent_bbch_id - col0_bbch4)/(c24_bbch4-col0_bbch4)
metabolite_arafield4 <- cbind(metabolite_arafield4, 
                              norm_bbch_id = norm_bbch_id4)

metabolite_arafield4 <- (metabolite_arafield4[ , names(metabolite_arafield4)[c(1:20,30,21:29)]] )

# sinnvoll hier zu skalieren?
# scale_bbch4=scale(metabolite_arafield4$percent_bbch_id)
```


### Categories for BBCH
```{r categories for BBCH}
# Unterteilung des BBCH in 3 Kategorien, von 0 bis 49: vegetativ, von 50 bis 59: Blütenanlagen, ab 60: Blüte
categories_bbch_id_arafield4 <- cut(metabolite_arafield4$bbch_id, 
                                    breaks=c(0,49,59,100), ordered=T)
levels(categories_bbch_id_arafield4) <- c("vegetativ","Blütenanlage","Blüte")

# überprüfen, ob Klasse korrekt ist
class(categories_bbch_id_arafield4)
#[1] "ordered" "factor" 

# überprüfen wie viele Pflanzen in jeder Kategorie sind
table(categories_bbch_id_arafield4)

# Anfügen der Spalte mit den Kategorien an die gesamte Tabelle
metabolite_arafield4 <- cbind(metabolite_arafield4,
                           bbch_categories = categories_bbch_id_arafield4)

# überprüfen, ob Kategorien korrekt zugeordnet sind           
pander(table(metabolite_arafield4$bbch_id, metabolite_arafield4$bbch_categories))

# Anpassung der Spalten-Reihenfolge
metabolite_arafield4 <- (metabolite_arafield4[ , names(metabolite_arafield4)[c(1:21,31,22:30)]] )
```


### Change negative values in small positive values 
1/10 of the minimal value
Field 4 has only one negative value for fumarate
Columns 7: Glc, 8: Frc, 9: Suc, 10: Raf, 11: AS, 12: Malate, 13: Fumarate, 14: Proline, 15: Anthocyanin
```{r change negative values}

orig.df4 <- metabolite_arafield4[,c(7:15)]
nonNeg4 <- as.data.frame(apply(orig.df4, 2, function(col) 
{
  min.val <- min(col[col>0])
  col[col<0] <- (min.val/10)
	col # Column index
}))

# change column names
cnames_nonNeg4 <- colnames(nonNeg4)
cnames_nonNeg4 <- c("glucose_positive", "fructose_positive", "sucrose_positive",
                    "raffinose_positive", "amino_acids_positive", "malate_positive", 
                    "fumarate_positive", "proline_positive", "anthocyanin_positive")
colnames(nonNeg4) <- cnames_nonNeg4

# attach columns with non-negative values to table
metabolite_arafield4 <- cbind(metabolite_arafield4, nonNeg4)
```


### Create a category for flowering and non-flowering plants
- non-flowering: 0 to 59 
- flowering: > 60

```{r category flowering and non-flowering plants}

flowering_state_arafield4 <- cut(metabolite_arafield4$bbch_id, breaks=c(0,59,100), ordered=T)
levels(flowering_state_arafield4) <- c("non-flowering","flowering")
table(flowering_state_arafield4)
# non-flowering    flowering 
#          141           18 

metabolite_arafield4 <- cbind(metabolite_arafield4, flowering_state_arafield4)
colnames(metabolite_arafield4)[41] <- "flowering_state"
table(metabolite_arafield4$bbch_id, metabolite_arafield4$flowering_state)
#      non-flowering flowering
#   50            4         0
#   51           13         0
#   52           15         0
#   53           41         0
#   55           49         0
#   57            1         0
#   59           18         0
#   61            0         6
#   63            0        11
#   65            0         1
```


### Create a category for vegetative and non-vegetative plants
- vegetative: 0 to 49 
- non-vegetative: > 50 
```{r category vegetative and non-vegetative plants}
vegetative_state_arafield4 <- cut(metabolite_arafield4$bbch_id, breaks=c(0,49,100), ordered=T)
levels(vegetative_state_arafield4) <- c("vegetative", "non-vegetative")
table(vegetative_state_arafield4)
#      vegetative  non-vegetative 
#               0             159 

metabolite_arafield4 <- cbind(metabolite_arafield4, vegetative_state_arafield4)
colnames(metabolite_arafield4)[42] = "vegetative_state"
table(metabolite_arafield4$bbch_id, metabolite_arafield4$vegetative_state)
#     vegetative non-vegetative
#  50         0               4
#  51         0              13
#  52         0              15
#  53         0              41
#  55         0              49
#  57         0               1
#  59         0              18
#  61         0               6
#  63         0              11
#  65         0               1
```


### table bbch and anthoscore
```{r table bbch and anthoscore}
table(metabolite_arafield4$bbch_categories)
#   vegetativ  Blütenanlage        Blüte 
#           0           141           18 

table(metabolite_arafield4$antho_value)
#        NA sehr gering      gering      mittel        hoch   sehr hoch 
#         1           6          28          69          42          14 
table(metabolite_arafield4$antho_value_en)

table(metabolite_arafield4$antho_value_en, metabolite_arafield4$bbch_categories)
#              vegetativ Blütenanlage Blüte
#  sehr gering         0            3     3
#  gering              0           23     5
#  mittel              0           61     8
#  hoch                0           41     1
#  sehr hoch           0           13     1
```


### anthocyanin plots and tests
```{r anthocyanin plots and tests}
# pdf(file="Masterarbeit/Ergebnisse/AraField4_Assocplot.pdf", 5,5)
assocplot(table(metabolite_arafield4$antho_value_en, metabolite_arafield4$bbch_categories)[ ,c(2:3)], 
          col=c("black","red"), xlab="Anthocyan-Gehalt (visuelle Skala)", ylab="BBCH-Kategorie")
# flächenproportionale Darstellung der Abweichungen
# Veranschaulichung, ob einzelne Werte größer oder kleiner als erwartet waren
# Direkte Analyse der Residuen (Residuals)

assocplot(table(metabolite_arafield4$antho_value_en, metabolite_arafield4$flowering_state), 
          col=c("black","red"), xlab="Anthocyan-Gehalt (visuelle Skala)", 
          ylab="BBCH-Kategorie", main="Feldversuch 2009/10")

boxplot(metabolite_arafield4$anthoscore ~ metabolite_arafield4$bbch_categories, 
        main="Anthocyan-Gehalt bei verschiedenen BBCH-Kategorien", xlab="BBCH-Kategorie",
        ylab="Anthocyan-Gehalt (visuelle Skala)", cex.main=1.5, cex.axis=1.3, cex.lab=1.3)
dev.off()

# col=c("#9ACD32","#B02B76")

# Nullhypothese: (Two or More) Groups are not different from each other regarding their population proportions or means
# P-Value: gives the probability that the null hypothesis is true!
        # Tells you how often you would get the observed difference by random sampling from two populations if the means/proportions would be equal
        # Tells you not(!!) how sure we are that there is really a difference


prop.test(table(metabolite_arafield4$antho_value_en, metabolite_arafield4$bbch_categories)[,c(2:3)])
#        5-sample test for equality of proportions without continuity correction
#data:  table(metabolite_arafield4$antho_value, metabolite_arafield4$bbch_categories)[c(2:6),      c(2:3)] 
#X-squared = 13.7252, df = 4, p-value = 0.008226
#alternative hypothesis: two.sided 
#sample estimates:
#   prop 1    prop 2    prop 3    prop 4    prop 5 
#0.5000000 0.8214286 0.8840580 0.9761905 0.9285714 
#
#Warning message:
#In prop.test(table(metabolite_arafield4$antho_value, metabolite_arafield4$bbch_categories)[c(2:6),  :
#  Chi-squared approximation may be incorrect


pairwise.prop.test(table(metabolite_arafield4$antho_value_en, metabolite_arafield4$bbch_categories)[,c(2:3)])
#         Pairwise comparisons using Pairwise comparison of proportions 
#data:  table(metabolite_arafield4$antho_value, metabolite_arafield4$bbch_categories)[c(2:6),      c(2:3)] 
#          sehr gering gering mittel hoch 
#gering    1.000       -      -      -    
#mittel    0.462       1.000  -      -    
#hoch      0.016       0.538  1.000  -    
#sehr hoch 0.789       1.000  1.000  1.000

chisq.test(table(metabolite_arafield4$antho_value_en, metabolite_arafield4$bbch_categories)[,c(2:3)])
# Pearson's Chi-squared test
#data:  table(metabolite_arafield4$antho_value, metabolite_arafield4$bbch_categories)[c(2:6),      c(2:3)] 
#X-squared = 13.7252, df = 4, p-value = 0.008226

#Warning message:
#In chisq.test(table(metabolite_arafield4$antho_value, metabolite_arafield4$bbch_categories)[c(2:6),  :
#  Chi-squared approximation may be incorrect

# Ausgabe der erwarteten Werte
chisq.test(table(metabolite_arafield4$antho_value_en, metabolite_arafield4$bbch_categories)[,c(2:3)])$expected
#              Blütenanlage     Blüte
#  sehr gering     5.320755 0.6792453
#  gering         24.830189 3.1698113
#  mittel         61.188679 7.8113208
#  hoch           37.245283 4.7547170
#  sehr hoch      12.415094 1.5849057


###### bei Anzahl erwarteter Werte N<5 Verwendung des Fisher.test !!! ########
# --> siehe Dormann: Angewandte Statistik für die biologischen Wissenschaften, Seite 51

fisher.test(table(metabolite_arafield4$antho_value_en, metabolite_arafield4$bbch_categories)[,c(2:3)])
#        Fisher's Exact Test for Count Data
#data:  
#p-value = 0.01308
#alternative hypothesis: two.sided

# signifikanter Unterschied
```


```{r acclimation capacity}
# Berechnung der Akklimatisierungskapazität als Differenz von LT50ACC und LT50NAC
yCapacity4full <- metabolite_arafield4$LT50ACC - metabolite_arafield4$LT50NAC 
metabolite_arafield4 <- cbind(metabolite_arafield4, 
                              "capacity" = yCapacity4full)

#colnames(metabolite_arafield4)[43]="capacity" 
```


```{r save metabolite table}
write.table(metabolite_arafield4, file="output/metabolite_arafield4.txt", sep="\t")
```


```{r outlier}

##### Outlier wurden zuvor auf NA gesetzt ######################################
##### und werden jetzt mittels linearer Regression geschätzt ###################
 
# field4_sucrose <- metabolite_arafield4$sucrose_without_outliers
# # Speichern welche Werte NAs sind
# missing_field4_sucrose <- is.na(metabolite_arafield4$sucrose_without_outliers)
# # Vorhersage der Saccharose-Werte mit Hilfe der Messwerte für Glc, Frc, Raf, Fumarat, Malat, AS und Prolin
# predicted_field4_sucrose <- predict(lm(as.numeric(metabolite_arafield4$sucrose_without_outliers) ~ 
#                                          metabolite_arafield4$glucose_positive + metabolite_arafield4$fructose_positive + 
#                                          metabolite_arafield4$raffinose_positive + metabolite_arafield4$fumarate_positive + 
#                                          metabolite_arafield4$malate_positive + metabolite_arafield4$amino_acids_positive + 
#                                          metabolite_arafield4$proline_positive + metabolite_arafield4$anthocyanin_positive))
# 
# # Speichern der vorhergesagten Saccharose-Werte für NAs
# field4_sucrose[missing_field4_sucrose] <- predicted_field4_sucrose[missing_field4_sucrose]
# # Verbinden der Tabelle mit der Spalte für Saccharose-Werte ohne NAs
# metabolite_arafield4 <- cbind(metabolite_arafield4,field4_sucrose)
# # Umbennenung der hinzugefügten Spalte
# colnames(metabolite_arafield4)[61] <- "sucrose_new"    
#-------------------------------------------------------------------------------
```


```{r survivor}
# ???
# Anteil der überlebenden Pflanzen (im Mai) an Zahl der ausgesäten Same (150)
# survivors4_total = 150 - metabolite_arafield4$number2
# 
# 
# Anteil der überlebenden Pflanzen (im Mai) an Zahl der überlebenden Pflanzen im März
# survivors4_part = metabolite_arafield4$number3 - metabolite_arafield4$number2
```


## save workspace
```{r save workspace}
save.image("metabolite_arafield4.RData")
```

